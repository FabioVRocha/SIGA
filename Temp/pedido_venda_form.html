{% extends "base.html" %}

{# Macros from produtos_form.html #}
{% macro grid_col_class(col) -%}
{% set col_int = col|int if col is not none else 12 %}\ncol-span-12 {% if col_int >= 1 and col_int <= 12 %}md:col-span-{{ col_int }}{% else %}md:col-span-12{% endif %}
{%- endmacro %}

{% macro text_input(field, col=4, type='text', placeholder='', extra_classes='') -%}
{% set field_class = grid_col_class(col) %}
<div class="{{ field_class }}">
  {{ field.label(class="form-label") }}
  {{ field(class="form-input " + extra_classes, placeholder=placeholder, type=type) }}
</div>
{%- endmacro %}

{% macro number_input(field, col=4, min=None, step=None, extra_classes='') -%}
{% set field_class = grid_col_class(col) %}
<div class="{{ field_class }}">
  {{ field.label(class="form-label") }}
  {{ field(class="form-input " + extra_classes, type="number", min=min, step=step) }}
</div>
{%- endmacro %}

{% macro textarea_input(field, col=12, rows=3, placeholder='', extra_classes='') -%}
{% set field_class = grid_col_class(col) %}
<div class="{{ field_class }}">
  {{ field.label(class="form-label") }}
  {{ field(class="form-input min-h-[120px] resize-y " + extra_classes, rows=rows, placeholder=placeholder) }}
</div>
{%- endmacro %}

{% macro checkbox_input(field, col=3) -%}
{% set field_class = grid_col_class(col) %}
<div class="{{ field_class }} pt-6">
  <label class="inline-flex items-center gap-3 text-sm font-medium text-slate-600">
    {{ field(class="h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500 focus:border-indigo-500") }}
    <span>{{ field.label.text }}</span>
  </label>
</div>
{%- endmacro %}

{% macro select_field(field, col=4, extra_classes='') -%}
{% set field_class = grid_col_class(col) %}
<div class="{{ field_class }}">
    {{ field.label(class="form-label") }}
    {{ field(class="form-select " + extra_classes, id=field.id) }}
</div>
{%- endmacro %}


{% block title %}{% if is_edit %}Editar Pedido de Venda{% else %}Novo Pedido de Venda{% endif %}{% endblock %}
{% block page_title %}{% if is_edit %}Editar Pedido de Venda #{{ pedido.numero_pedido }}{% else %}Novo Pedido de Venda{% endif %}{% endblock %}

{% block page_header_actions %}
  <a href="{{ url_for('comercial.pedido_venda_list') }}" class="btn-secondary">Voltar</a>
  {% if is_edit %}
    {# Maybe add a print button or something here in the future #}
  {% endif %}
{% endblock %}

{% block content %}
<div class="space-y-6">
  <form method="post" id="pedido-form" novalidate class="rounded-2xl border border-slate-200 bg-white shadow-sm">
    {{ form.hidden_tag() }}
    <input type="hidden" name="status" id="status_input" value="{{ form.status.data if form.status.data else (pedido.status.value if pedido else 'rascunho') }}">

    {% set tabs = [
      ('tab-geral', 'Geral'),
      ('tab-itens', 'Itens'),
      ('tab-financeiro', 'Financeiro'),
      ('tab-enderecos', 'Endereços'),
      ('tab-transporte', 'Transporte'),
      ('tab-observacoes', 'Observações'),
      ('tab-controle', 'Controle')
    ] %}
    <div class="border-b border-slate-200 bg-slate-50 px-5 py-4 md:px-6">
      <div class="flex flex-wrap gap-2">
        {% for tab_id, tab_label in tabs %}
        <button type="button"
                data-tab-target="{{ tab_id }}"
                class="tab-trigger rounded-xl px-4 py-2 text-sm font-medium transition focus:outline-none focus:ring-2 focus:ring-indigo-200 {% if loop.first %}bg-white text-indigo-600 shadow-sm border border-slate-200{% else %}text-slate-600 border border-transparent hover:text-indigo-600 hover:bg-white/60{% endif %}"
                {% if loop.first %}aria-selected="true"{% else %}aria-selected="false"{% endif %}>
          {{ tab_label }}
        </button>
        {% endfor %}
      </div>
    </div>

    <div class="space-y-8 px-5 py-6 md:px-6">
      <div data-tab-panel="tab-geral" class="tab-panel space-y-8" role="tabpanel">
        <div class="grid grid-cols-12 gap-6">
          {{ text_input(form.numero_pedido, col=3) }}
          <div class="{{ grid_col_class(6) }}">
            {{ form.cliente.label(class="form-label") }}
            <div class="flex gap-2">
              {{ form.cliente(class="form-select tom-select flex-1", id=form.cliente.id) }}
              <button type="button" id="open-cliente-modal" class="btn-secondary flex items-center justify-center px-3" aria-label="Buscar cliente">
                <svg class="h-5 w-5 text-slate-600" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                  <circle cx="11" cy="11" r="7" />
                  <path d="m20 20-3.5-3.5" />
                </svg>
              </button>
            </div>
          </div>
          <div class="{{ grid_col_class(3) }}">
            {{ form.vendedor.label(class="form-label") }}
            <div class="flex gap-2">
              {{ form.vendedor(class="form-select tom-select flex-1", id=form.vendedor.id) }}
              <button type="button" id="open-vendedor-modal" class="btn-secondary flex items-center justify-center px-3" aria-label="Buscar vendedor">
                <svg class="h-5 w-5 text-slate-600" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                  <circle cx="11" cy="11" r="7" />
                  <path d="m20 20-3.5-3.5" />
                </svg>
              </button>
            </div>
          </div>
          {{ select_field(form.tipo_pedido, col=3) }}
          {{ select_field(form.canal, col=3) }}
          {{ select_field(form.tabela_preco, col=3, extra_classes='tom-select') }}
          {{ select_field(form.condicao_pagamento, col=3, extra_classes='tom-select') }}
          {{ select_field(form.forma_pagamento, col=3) }}
          {{ text_input(form.prazo_entrega, col=3, type='date') }}
        </div>
      </div>

      <div data-tab-panel="tab-itens" class="tab-panel space-y-8 hidden" role="tabpanel">
        <div class="rounded-2xl border border-slate-200 bg-white shadow-sm">
          <div class="flex flex-wrap items-center justify-between gap-3 border-b border-slate-200 px-5 py-4 md:px-6">
            <div>
              <h3 class="text-lg font-semibold">Itens do Pedido</h3>
              <p class="text-sm text-slate-500">Adicione os produtos do pedido e informe quantidades e valores.</p>
            </div>
            <button type="button" id="add-item" class="btn-primary flex items-center gap-2">
              <span class="text-xl leading-none">+</span>
              <span>Adicionar Item</span>
            </button>
          </div>
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-slate-200" aria-describedby="itens-empty-state">
              <thead class="bg-slate-50">
                <tr class="text-left text-xs font-semibold uppercase tracking-wide text-slate-500">
                  <th scope="col" class="px-6 py-3">Produto</th>
                  <th scope="col" class="px-6 py-3 text-right">Quantidade</th>
                  <th scope="col" class="px-6 py-3 text-right">Preço Unit. Bruto</th>
                  <th scope="col" class="px-6 py-3 text-right">Desc. %</th>
                  <th scope="col" class="px-6 py-3 text-right">Total Líquido</th>
                  <th scope="col" class="px-6 py-3 text-right">Ações</th>
                </tr>
              </thead>
              <tbody id="itens-table-body" class="divide-y divide-slate-200 bg-white">
                {% for item in itens or [] %}
                <tr class="item-row">
                  <td class="px-6 py-4 align-top">
                    <div class="font-semibold text-slate-800">{{ item.descricao }}</div>
                    <div class="text-xs text-slate-500">Código: {{ item.codigo if item.codigo else '—' }}</div>
                    <input type="hidden" name="item_produto_id" value="{{ item.produto_id }}">
                  </td>
                  <td class="px-6 py-4 align-top">
                    <input type="number" name="item_qtde" step="any" class="form-input w-28 text-right" value="{{ item.qtde }}">
                  </td>
                  <td class="px-6 py-4 align-top">
                    <input type="number" name="item_preco_bruto" step="any" class="form-input w-32 text-right" value="{{ item.preco_bruto }}">
                  </td>
                  <td class="px-6 py-4 align-top">
                    <input type="number" name="item_desconto_perc" step="any" class="form-input w-24 text-right" value="{{ item.desconto_perc }}">
                  </td>
                  <td class="px-6 py-4 align-top text-right">
                    <span class="total-liquido-item font-semibold text-slate-800">R$ 0,00</span>
                  </td>
                  <td class="px-6 py-4 align-top text-right">
                    <button type="button" class="btn-secondary remove-item">Remover</button>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
            <div id="itens-empty-state" class="px-6 py-8 text-center text-sm text-slate-500 {% if itens %}hidden{% endif %}">
              Nenhum item adicionado até o momento. Clique em &ldquo;Adicionar Item&rdquo; para começar.
            </div>
          </div>
        </div>
      </div>

      <div data-tab-panel="tab-financeiro" class="tab-panel space-y-8 hidden" role="tabpanel">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="rounded-2xl border border-slate-200 bg-white shadow-sm p-6">
                <h3 class="text-lg font-semibold mb-4">Totais do Pedido</h3>
                <div class="space-y-2">
                    <div class="flex justify-between">
                        <span>Subtotal Bruto:</span>
                        <span id="subtotal_bruto">R$ {{ pedido.subtotal_bruto|default('0.00') }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Descontos:</span>
                        <span id="descontos">R$ {{ pedido.descontos|default('0.00') }}</span>
                    </div>
                    {{ number_input(form.frete, col=12, step='0.01') }}
                    {{ number_input(form.seguro, col=12, step='0.01') }}
                    {{ number_input(form.outras_despesas, col=12, step='0.01') }}
                    <div class="flex justify-between">
                        <span>Total Impostos:</span>
                        <span id="total_impostos">R$ {{ (pedido.icms_total or 0) + (pedido.ipi_total or 0) + (pedido.pis_total or 0) + (pedido.cofins_total or 0) }}</span>
                    </div>
                    <div class="flex justify-between font-bold text-lg">
                        <span>Total Líquido:</span>
                        <span id="total_liquido">R$ {{ pedido.total_liquido|default('0.00') }}</span>
                    </div>
                </div>
            </div>
            <div class="rounded-2xl border border-slate-200 bg-white shadow-sm p-6">
                <h3 class="text-lg font-semibold mb-4">Parcelas</h3>
                <div class="space-y-2">
                    {% if pedido and pedido.parcelas %}
                        <table class="w-full text-sm text-left text-gray-500">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3">#</th>
                                    <th scope="col" class="px-6 py-3">Vencimento</th>
                                    <th scope="col" class="px-6 py-3">Valor</th>
                                </tr>
                            </thead>
                            <tbody>
                            {% for parcela in pedido.parcelas %}
                                <tr class="bg-white border-b">
                                    <td class="px-6 py-4">{{ parcela.n_parcela }}</td>
                                    <td class="px-6 py-4">{{ parcela.vencimento.strftime('%d/%m/%Y') }}</td>
                                    <td class="px-6 py-4">R$ {{ "%.2f"|format(parcela.valor) }}</td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    {% else %}
                        <p>Nenhuma parcela gerada.</p>
                    {% endif %}
                </div>
            </div>
        </div>
      </div>

      <div data-tab-panel="tab-enderecos" class="tab-panel space-y-8 hidden" role="tabpanel">
        <div class="grid grid-cols-12 gap-6">
            {{ select_field(form.endereco_entrega, col=6, extra_classes='tom-select') }}
            {{ select_field(form.endereco_cobranca, col=6, extra_classes='tom-select') }}
        </div>
      </div>

      <div data-tab-panel="tab-transporte" class="tab-panel space-y-8 hidden" role="tabpanel">
        <div class="grid grid-cols-12 gap-6">
            {{ select_field(form.transportadora, col=4, extra_classes='tom-select') }}
            {{ select_field(form.modal, col=4) }}
            {{ select_field(form.frete_por_conta, col=4) }}
        </div>
      </div>

      <div data-tab-panel="tab-observacoes" class="tab-panel space-y-8 hidden" role="tabpanel">
        <div class="grid grid-cols-12 gap-6">
            {{ textarea_input(form.observacoes_comerciais, col=6, rows=4) }}
            {{ textarea_input(form.observacoes_fiscais, col=6, rows=4) }}
        </div>
      </div>

      <div data-tab-panel="tab-controle" class="tab-panel space-y-8 hidden" role="tabpanel">
        <div class="grid grid-cols-12 gap-6">
            {% if pedido %}
            <div class="col-span-12 md:col-span-3">
                <label class="form-label">Status Atual</label>
                <span class="px-4 py-2 rounded-full text-white font-semibold 
                    {% if pedido.status.value == 'rascunho' %} bg-gray-400
                    {% elif pedido.status.value == 'bloqueado_credito' %} bg-red-500
                    {% elif pedido.status.value == 'cancelado' %} bg-red-700
                    {% elif pedido.status.value == 'aguardando_aprovacao' %} bg-yellow-500
                    {% elif pedido.status.value == 'reservado' %} bg-blue-500
                    {% elif pedido.status.value == 'finalizado' %} bg-green-500
                    {% else %} bg-indigo-500 {% endif %}">
                    {{ pedido.status.value.replace('_', ' ')|title }}
                </span>
            </div>
            {% else %}
                {{ select_field(form.status, col=3) }}
            {% endif %}
            {{ checkbox_input(form.exige_aprovacao, col=3) }}
            {{ checkbox_input(form.prioridade, col=3) }}
            {{ checkbox_input(form.urgente, col=3) }}
        </div>
      </div>
    </div>

    <div class="border-t border-slate-200 bg-slate-50 px-5 py-4 md:px-6">
      <div class="flex flex-wrap justify-between items-center gap-3">
        <div class="flex flex-wrap gap-3">
            <button type="submit" name="action" value="save" class="btn-primary">Salvar Alterações</button>
            <a href="{{ url_for('comercial.pedido_venda_list') }}" class="btn-secondary">Voltar</a>
        </div>
        
        {% if transicoes %}
        <div class="flex items-center gap-2">
            <span class="text-sm font-medium text-gray-600">Ações:</span>
            {% for transicao in transicoes %}
                <button type="button" class="btn-secondary status-action-btn" data-status="{{ transicao.value }}">
                    {{ transicao.value.replace('_', ' ')|title }}
                </button>
            {% endfor %}
        </div>
        {% endif %}
      </div>
    </div>
  </form>
</div>

<div id="cliente-modal" class="fixed inset-0 z-50 hidden">
  <div class="flex min-h-full items-center justify-center bg-slate-900/60 px-4 py-8">
    <div class="w-full max-w-2xl rounded-2xl bg-white shadow-xl">
      <div class="flex items-center justify-between border-b border-slate-200 px-6 py-4">
        <h3 class="text-lg font-semibold text-slate-800">Selecionar cliente</h3>
        <button type="button" class="text-2xl font-semibold leading-none text-slate-400 transition hover:text-slate-600" data-modal-close aria-label="Fechar">
          &times;
        </button>
      </div>
      <div class="space-y-5 px-6 py-6">
        <div>
          <label for="cliente-modal-search" class="form-label">Buscar cliente</label>
          <input type="text" id="cliente-modal-search" class="form-input" placeholder="Digite nome ou documento para filtrar">
        </div>
        <div class="max-h-80 overflow-y-auto rounded-xl border border-slate-200">
          {% if clientes %}
          <ul id="cliente-modal-list" class="divide-y divide-slate-200">
            {% for cliente in clientes %}
            {% set cliente_nome = cliente.nome_fantasia or cliente.razao_social or cliente.nome_completo or 'Sem nome' %}
            {% set cliente_documento = cliente.cnpj or cliente.cpf or '' %}
            <li>
              <button type="button" class="flex w-full items-start justify-between gap-4 px-4 py-3 text-left transition hover:bg-slate-50 focus:bg-slate-100 focus:outline-none" data-cliente-item data-cliente-id="{{ cliente.id }}" data-cliente-display="{{ cliente_nome }}" data-cliente-search="{{ (cliente_nome ~ ' ' ~ cliente_documento)|lower }}">
                <div>
                  <p class="font-medium text-slate-800">{{ cliente_nome }}</p>
                  {% if cliente_documento %}
                  <p class="text-sm text-slate-500">{{ cliente_documento }}</p>
                  {% endif %}
                </div>
                <span class="text-sm font-medium text-indigo-600">Selecionar</span>
              </button>
            </li>
            {% endfor %}
          </ul>
          {% else %}
          <p class="px-4 py-6 text-center text-sm text-slate-500">Nenhum cliente cadastrado.</p>
          {% endif %}
          <p id="cliente-modal-empty" class="hidden px-4 py-6 text-center text-sm text-slate-500">Nenhum cliente encontrado.</p>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="vendedor-modal" class="fixed inset-0 z-50 hidden">
  <div class="flex min-h-full items-center justify-center bg-slate-900/60 px-4 py-8">
    <div class="w-full max-w-xl rounded-2xl bg-white shadow-xl">
      <div class="flex items-center justify-between border-b border-slate-200 px-6 py-4">
        <h3 class="text-lg font-semibold text-slate-800">Selecionar vendedor</h3>
        <button type="button" class="text-2xl font-semibold leading-none text-slate-400 transition hover:text-slate-600" data-modal-close aria-label="Fechar">
          &times;
        </button>
      </div>
      <div class="space-y-5 px-6 py-6">
        <div>
          <label for="vendedor-modal-search" class="form-label">Buscar vendedor</label>
          <input type="text" id="vendedor-modal-search" class="form-input" placeholder="Digite nome ou identificação para filtrar">
        </div>
        <div class="max-h-80 overflow-y-auto rounded-xl border border-slate-200">
          {% if vendedores %}
          <ul id="vendedor-modal-list" class="divide-y divide-slate-200">
            {% for vendedor in vendedores %}
            {% set vendedor_nome = vendedor.nome_fantasia or vendedor.razao_social or vendedor.nome_completo or ('Pessoa #' ~ vendedor.id) %}
            <li>
              <button type="button" class="flex w-full items-start justify-between gap-4 px-4 py-3 text-left transition hover:bg-slate-50 focus:bg-slate-100 focus:outline-none" data-vendedor-item data-vendedor-id="{{ vendedor.id }}" data-vendedor-display="{{ vendedor_nome }}" data-vendedor-search="{{ (vendedor_nome ~ ' ' ~ vendedor.id)|lower }}">
                <div>
                  <p class="font-medium text-slate-800">{{ vendedor_nome }}</p>
                  <p class="text-sm text-slate-500">ID: {{ vendedor.id }}</p>
                </div>
                <span class="text-sm font-medium text-indigo-600">Selecionar</span>
              </button>
            </li>
            {% endfor %}
          </ul>
          {% else %}
          <p class="px-4 py-6 text-center text-sm text-slate-500">Nenhum vendedor cadastrado.</p>
          {% endif %}
          <p id="vendedor-modal-empty" class="hidden px-4 py-6 text-center text-sm text-slate-500">Nenhum vendedor encontrado.</p>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="item-modal" class="fixed inset-0 z-50 hidden">
  <div class="flex min-h-full items-center justify-center bg-slate-900/60 px-4 py-8">
    <div class="w-full max-w-2xl rounded-2xl bg-white shadow-xl">
      <div class="flex items-center justify-between border-b border-slate-200 px-6 py-4">
        <h3 class="text-lg font-semibold text-slate-800">Adicionar item ao pedido</h3>
        <button type="button" class="text-2xl font-semibold leading-none text-slate-400 transition hover:text-slate-600" data-modal-close aria-label="Fechar">
          &times;
        </button>
      </div>
      <form id="item-modal-form" class="space-y-6 px-6 py-6" novalidate>
        <div class="grid grid-cols-12 gap-4">
          <div class="col-span-12">
            <label for="modal_produto_display" class="form-label">Produto</label>
            <div class="flex gap-2">
              <input type="text" id="modal_produto_display" class="form-input flex-1" placeholder="Selecione um produto" readonly>
              <input type="hidden" id="modal_produto_id">
              <input type="hidden" id="modal_produto_codigo">
              <button type="button" id="open-produto-modal" class="btn-secondary flex items-center justify-center px-3" aria-label="Buscar produto">
                <svg class="h-5 w-5 text-slate-600" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                  <circle cx="11" cy="11" r="7" />
                  <path d="m20 20-3.5-3.5" />
                </svg>
              </button>
            </div>
          </div>
          <div class="col-span-12 md:col-span-4">
            <label for="modal_qtde" class="form-label">Quantidade</label>
            <input type="number" id="modal_qtde" class="form-input" min="0" step="any" value="1">
          </div>
          <div class="col-span-12 md:col-span-4">
            <label for="modal_preco_bruto" class="form-label">Preço unit. bruto</label>
            <input type="number" id="modal_preco_bruto" class="form-input" min="0" step="any">
          </div>
          <div class="col-span-12 md:col-span-4">
            <label for="modal_desconto" class="form-label">Desconto (%)</label>
            <input type="number" id="modal_desconto" class="form-input" min="0" step="any" value="0">
          </div>
        </div>
        <div class="flex justify-end gap-3 border-t border-slate-200 pt-4">
          <button type="button" class="btn-secondary" data-modal-close>Cancelar</button>
          <button type="submit" class="btn-primary">Adicionar item</button>
        </div>
      </form>
    </div>
  </div>
</div>

<div id="produto-modal" class="fixed inset-0 z-50 hidden">
  <div class="flex min-h-full items-center justify-center bg-slate-900/60 px-4 py-8">
    <div class="w-full max-w-3xl rounded-2xl bg-white shadow-xl">
      <div class="flex items-center justify-between border-b border-slate-200 px-6 py-4">
        <h3 class="text-lg font-semibold text-slate-800">Selecionar produto</h3>
        <button type="button" class="text-2xl font-semibold leading-none text-slate-400 transition hover:text-slate-600" data-modal-close aria-label="Fechar">
          &times;
        </button>
      </div>
      <div class="space-y-5 px-6 py-6">
        <div>
          <label for="produto-modal-search" class="form-label">Buscar produto</label>
          <input type="text" id="produto-modal-search" class="form-input" placeholder="Digite código ou descrição para filtrar">
        </div>
        <div class="max-h-80 overflow-y-auto rounded-xl border border-slate-200">
          {% if produtos %}
          <ul id="produto-modal-list" class="divide-y divide-slate-200">
            {% for produto in produtos %}
            <li>
              {% set produto_codigo = produto.codigo_interno or 'Sem código' %}
              <button type="button" class="flex w-full items-start justify-between gap-4 px-4 py-3 text-left transition hover:bg-slate-50 focus:bg-slate-100 focus:outline-none" data-produto-item data-produto-id="{{ produto.id }}" data-produto-descricao="{{ produto.descricao }}" data-produto-codigo="{{ produto.codigo_interno or '' }}" data-produto-preco="{{ produto.preco_venda_padrao or 0 }}" data-produto-search="{{ (produto_codigo ~ ' ' ~ produto.descricao)|lower }}">
                <div>
                  <p class="font-medium text-slate-800">{{ produto.descricao }}</p>
                  <p class="text-sm text-slate-500">Código: {{ produto_codigo }}</p>
                </div>
                <span class="text-sm font-medium text-indigo-600">Selecionar</span>
              </button>
            </li>
            {% endfor %}
          </ul>
          {% else %}
          <p class="px-4 py-6 text-center text-sm text-slate-500">Nenhum produto cadastrado.</p>
          {% endif %}
          <p id="produto-modal-empty" class="hidden px-4 py-6 text-center text-sm text-slate-500">Nenhum produto encontrado.</p>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const form = document.getElementById('pedido-form');
      if (!form) return;

      const clienteSelect = document.getElementById('{{ form.cliente.id }}');
      const clienteModal = document.getElementById('cliente-modal');
      const openClienteModalButton = document.getElementById('open-cliente-modal');
      const clienteModalSearch = document.getElementById('cliente-modal-search');
      const clienteModalList = document.getElementById('cliente-modal-list');
      const clienteModalEmpty = document.getElementById('cliente-modal-empty');
      const clienteModalItems = clienteModal ? Array.from(clienteModal.querySelectorAll('[data-cliente-item]')) : [];

      const vendedorSelect = document.getElementById('{{ form.vendedor.id }}');
      const vendedorModal = document.getElementById('vendedor-modal');
      const openVendedorModalButton = document.getElementById('open-vendedor-modal');
      const vendedorModalSearch = document.getElementById('vendedor-modal-search');
      const vendedorModalList = document.getElementById('vendedor-modal-list');
      const vendedorModalEmpty = document.getElementById('vendedor-modal-empty');
      const vendedorModalItems = vendedorModal ? Array.from(vendedorModal.querySelectorAll('[data-vendedor-item]')) : [];

      const filterClienteList = (searchTerm = '') => {
        if (!clienteModalItems.length) return;
        const normalizedTerm = searchTerm.trim().toLowerCase();
        let hasResults = false;

        clienteModalItems.forEach((button) => {
          const listItem = button.closest('li');
          if (!listItem) return;

          const haystack = button.dataset.clienteSearch || '';
          const matches = !normalizedTerm || haystack.includes(normalizedTerm);
          listItem.classList.toggle('hidden', !matches);
          if (matches) {
            hasResults = true;
          }
        });

        if (clienteModalList) {
          clienteModalList.classList.toggle('hidden', !hasResults);
        }
        if (clienteModalEmpty) {
          clienteModalEmpty.classList.toggle('hidden', hasResults);
        }
      };

      const openClienteModal = () => {
        if (!clienteModal) return;
        clienteModal.classList.remove('hidden');
        document.body.classList.add('overflow-hidden');
        filterClienteList('');
        if (clienteModalSearch) {
          clienteModalSearch.value = '';
          window.setTimeout(() => clienteModalSearch.focus(), 0);
        }
      };

      const closeClienteModal = () => {
        if (!clienteModal) return;
        clienteModal.classList.add('hidden');
        document.body.classList.remove('overflow-hidden');
        if (clienteModalSearch) {
          clienteModalSearch.value = '';
        }
        filterClienteList('');
      };

      if (openClienteModalButton) {
        openClienteModalButton.addEventListener('click', openClienteModal);
      }
      if (clienteModal) {
        clienteModal.addEventListener('click', (event) => {
          if (event.target === clienteModal) {
            closeClienteModal();
          }
        });
        const clienteModalCloseButtons = clienteModal.querySelectorAll('[data-modal-close]');
        clienteModalCloseButtons.forEach((button) => {
          button.addEventListener('click', closeClienteModal);
        });
      }

      if (clienteModalSearch) {
        clienteModalSearch.addEventListener('input', () => {
          filterClienteList(clienteModalSearch.value);
        });
      }

      clienteModalItems.forEach((button) => {
        button.addEventListener('click', () => {
          const clienteId = button.dataset.clienteId;
          if (clienteSelect && clienteId) {
            clienteSelect.value = clienteId;
            const changeEvent = new Event('change', { bubbles: true });
            clienteSelect.dispatchEvent(changeEvent);
          }
          closeClienteModal();
        });
      });

      const filterVendedorList = (searchTerm = '') => {
        if (!vendedorModalItems.length) return;
        const normalizedTerm = searchTerm.trim().toLowerCase();
        let hasResults = false;

        vendedorModalItems.forEach((button) => {
          const listItem = button.closest('li');
          if (!listItem) return;

          const haystack = button.dataset.vendedorSearch || '';
          const matches = !normalizedTerm || haystack.includes(normalizedTerm);
          listItem.classList.toggle('hidden', !matches);
          if (matches) {
            hasResults = true;
          }
        });

        if (vendedorModalList) {
          vendedorModalList.classList.toggle('hidden', !hasResults);
        }
        if (vendedorModalEmpty) {
          vendedorModalEmpty.classList.toggle('hidden', hasResults);
        }
      };

      const openVendedorModal = () => {
        if (!vendedorModal) return;
        vendedorModal.classList.remove('hidden');
        document.body.classList.add('overflow-hidden');
        filterVendedorList('');
        if (vendedorModalSearch) {
          vendedorModalSearch.value = '';
          window.setTimeout(() => vendedorModalSearch.focus(), 0);
        }
      };

      const closeVendedorModal = () => {
        if (!vendedorModal) return;
        vendedorModal.classList.add('hidden');
        document.body.classList.remove('overflow-hidden');
        if (vendedorModalSearch) {
          vendedorModalSearch.value = '';
        }
        filterVendedorList('');
      };

      if (openVendedorModalButton) {
        openVendedorModalButton.addEventListener('click', openVendedorModal);
      }

      if (vendedorModal) {
        vendedorModal.addEventListener('click', (event) => {
          if (event.target === vendedorModal) {
            closeVendedorModal();
          }
        });
        const vendedorModalCloseButtons = vendedorModal.querySelectorAll('[data-modal-close]');
        vendedorModalCloseButtons.forEach((button) => {
          button.addEventListener('click', closeVendedorModal);
        });
      }

      if (vendedorModalSearch) {
        vendedorModalSearch.addEventListener('input', () => {
          filterVendedorList(vendedorModalSearch.value);
        });
      }

      vendedorModalItems.forEach((button) => {
        button.addEventListener('click', () => {
          const vendedorId = button.dataset.vendedorId;
          if (vendedorSelect && vendedorId) {
            vendedorSelect.value = vendedorId;
            const changeEvent = new Event('change', { bubbles: true });
            vendedorSelect.dispatchEvent(changeEvent);
          }
          closeVendedorModal();
        });
      });

      // --- Tab Logic ---
      const tabButtons = Array.from(form.querySelectorAll('[data-tab-target]'));
      const tabPanels = Array.from(form.querySelectorAll('[data-tab-panel]'));
      const activeClasses = ['bg-white', 'text-indigo-600', 'shadow-sm', 'border', 'border-slate-200'];
      const inactiveClasses = ['text-slate-600', 'border', 'border-transparent', 'hover:text-indigo-600', 'hover:bg-white/60'];

      const activateTab = (targetId) => {
        tabButtons.forEach((btn) => {
          const isTarget = btn.dataset.tabTarget === targetId;
          btn.setAttribute('aria-selected', isTarget ? 'true' : 'false');
          if(isTarget) {
              btn.classList.add(...activeClasses);
              btn.classList.remove(...inactiveClasses);
          } else {
              btn.classList.remove(...activeClasses);
              btn.classList.add(...inactiveClasses);
          }
        });

        tabPanels.forEach((panel) => {
          panel.classList.toggle('hidden', panel.dataset.tabPanel !== targetId);
        });
      };

      tabButtons.forEach((btn) => {
        btn.addEventListener('click', (e) => {
            e.preventDefault();
            activateTab(btn.dataset.tabTarget)
        });
      });

      if (tabButtons.length) {
        activateTab(tabButtons[0].dataset.tabTarget);
      }

      // --- Status Action Logic ---
      const statusButtons = document.querySelectorAll('.status-action-btn');
      const statusInput = document.getElementById('status_input');

      statusButtons.forEach(button => {
          button.addEventListener('click', function() {
              const newStatus = this.dataset.status;
              if (statusInput) {
                  statusInput.value = newStatus;
              }
              if (confirm(`Tem certeza que deseja mover o pedido para o status '${newStatus.replace(/_/g, ' ')}'?`)) {
                  form.submit();
              }
          });
      });
    });
  </script>
  <script src="{{ url_for('static', filename='js/pedido_venda.js') }}"></script>
{% endblock %}