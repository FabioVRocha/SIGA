{% extends "base.html" %}

{% block title %}Pedidos de Venda{% endblock %}

{% block page_title %}Pedidos de Venda{% endblock %}

{% block content %}
<style>
    .list-section {
        background-color: var(--clr-card-bg);
        border-radius: 0.75rem;
        border: 1px solid var(--clr-border);
        box-shadow: 0 1px 3px rgba(15, 23, 42, 0.12);
        padding: 1.5rem;
    }
    @media (min-width: 1024px) {
        .list-section {
            padding: 2rem;
        }
    }
    .section-heading {
        font-size: 1.05rem;
        font-weight: 600;
        color: var(--clr-dark-blue);
    }
    .text-dark-blue {
        color: var(--clr-dark-blue);
    }
    .text-slate-muted {
        color: var(--clr-text-secondary);
    }
    .hover-row:hover {
        background-color: rgba(79, 131, 204, 0.12);
        transition: background-color 0.2s ease-in-out;
    }
    .sort-button {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        background: none;
        border: none;
        color: inherit;
        font: inherit;
        text-transform: inherit;
        width: 100%;
        padding: 0;
        cursor: pointer;
    }
    .sort-button:focus-visible {
        outline: 2px solid var(--clr-light-blue);
        outline-offset: 2px;
    }
    .sort-button.justify-end {
        justify-content: flex-end;
    }
    .sort-icon {
        font-size: 0.75rem;
        opacity: 0.5;
    }
    .sort-button.active .sort-icon {
        opacity: 1;
        color: var(--clr-light-blue);
    }
    .form-input, .filter-input {
        width: 100%;
        padding: 0.5rem 0.75rem;
        border: 1px solid var(--clr-border);
        border-radius: 0.5rem;
        font-size: 0.8rem;
        color: var(--clr-dark-blue);
        background-color: var(--clr-white);
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }
    .form-input::placeholder, .filter-input::placeholder {
        color: var(--clr-text-secondary);
    }
    .form-input:focus, .filter-input:focus {
        border-color: var(--clr-light-blue);
        box-shadow: 0 0 0 3px rgba(79, 131, 204, 0.15);
        outline: none;
    }
    .modal-content {
        background-color: var(--clr-card-bg);
        border: 1px solid var(--clr-border);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    #orderDetailsModal .modal-content {
        width: 100%;
        max-width: 80rem;
        max-height: 90vh;
        overflow-y: auto;
    }
    .order-summary-card {
        background-color: var(--clr-card-bg);
        border: 1px solid var(--clr-border);
        border-radius: 0.75rem;
        padding: 1rem;
        box-shadow: 0 1px 3px rgba(15, 23, 42, 0.12);
    }
    .order-summary-label {
        font-size: 0.65rem;
        font-weight: 600;
        letter-spacing: 0.05em;
        text-transform: uppercase;
        color: var(--clr-text-secondary);
    }
    .order-summary-value {
        margin-top: 0.35rem;
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--clr-dark-blue);
    }
</style>

<div class="space-y-6">
    <section class="list-section">
        <div class="flex flex-col gap-2 md:flex-row md:items-center md:justify-between mb-4">
            <div>
                <h2 class="section-heading">Pedidos de Venda</h2>
                <p class="text-xs text-slate-muted">Total de {{ orders|length if orders else 0 }} registros encontrados.</p>
            </div>
            <div class="flex justify-end w-full md:w-auto">
                <button id="openFilterModalBtn" class="btn-primary flex items-center px-4 py-2 rounded-lg">
                    <i class="fas fa-filter mr-2"></i> Filtrar
                </button>
            </div>
        </div>

        <div class="overflow-x-auto">
            <form id="columnFilterForm" action="{{ url_for('sales_orders_list') }}" method="GET" class="space-y-3">
                <!-- Hidden inputs for existing filters from modal -->
                {% for city in filters.cities or [] %}<input type="hidden" name="cities" value="{{ city }}">{% endfor %}
                {% for state in filters.states or [] %}<input type="hidden" name="states" value="{{ state }}">{% endfor %}
                {% for vendor in filters.vendors or [] %}<input type="hidden" name="vendors" value="{{ vendor }}">{% endfor %}
                {% for status in filters.statuses or [] %}<input type="hidden" name="statuses" value="{{ status }}">{% endfor %}
                {% for situation in filters.situations or [] %}<input type="hidden" name="situations" value="{{ situation }}">{% endfor %}
                {% for occurrence in filters.occurrences or [] %}<input type="hidden" name="occurrences" value="{{ occurrence }}">{% endfor %}
                {% for val in filters.has_load_lot or [] %}<input type="hidden" name="has_load_lot" value="{{ val }}">{% endfor %}
                {% for val in filters.has_production_lot or [] %}<input type="hidden" name="has_production_lot" value="{{ val }}">{% endfor %}
                {% if filters.start_date %}<input type="hidden" name="start_date" value="{{ filters.start_date }}">{% endif %}
                {% if filters.end_date %}<input type="hidden" name="end_date" value="{{ filters.end_date }}">{% endif %}
                
                <input type="hidden" name="sort_by" id="columnSortByInput" value="{{ sort_by }}">
                <input type="hidden" name="sort_order" id="columnSortOrderInput" value="{{ sort_order }}">

                <table class="min-w-full bg-white rounded-xl overflow-hidden">
                    <thead class="bg-gray-800 text-white" style="background-color: var(--clr-sidebar-bg);">
                        <tr class="text-xs font-medium uppercase tracking-wider">
                            <th scope="col" class="px-4 py-3 text-left rounded-tl-lg"><button type="button" class="sort-button {% if sort_by == 'pedido' %}active{% endif %}" data-sort-column="pedido"><span>Pedido</span><i class="fas {% if sort_by == 'pedido' %}{% if sort_order == 'asc' %}fa-sort-up{% else %}fa-sort-down{% endif %}{% else %}fa-sort{% endif %} sort-icon"></i></button></th>
                            <th scope="col" class="px-4 py-3 text-left"><button type="button" class="sort-button {% if sort_by == 'data' %}active{% endif %}" data-sort-column="data"><span>Data</span><i class="fas {% if sort_by == 'data' %}{% if sort_order == 'asc' %}fa-sort-up{% else %}fa-sort-down{% endif %}{% else %}fa-sort{% endif %} sort-icon"></i></button></th>
                            <th scope="col" class="px-4 py-3 text-left"><button type="button" class="sort-button {% if sort_by == 'codigo' %}active{% endif %}" data-sort-column="codigo"><span>Código</span><i class="fas {% if sort_by == 'codigo' %}{% if sort_order == 'asc' %}fa-sort-up{% else %}fa-sort-down{% endif %}{% else %}fa-sort{% endif %} sort-icon"></i></button></th>
                            <th scope="col" class="px-4 py-3 text-left"><button type="button" class="sort-button {% if sort_by == 'cliente' %}active{% endif %}" data-sort-column="cliente"><span>Cliente</span><i class="fas {% if sort_by == 'cliente' %}{% if sort_order == 'asc' %}fa-sort-up{% else %}fa-sort-down{% endif %}{% else %}fa-sort{% endif %} sort-icon"></i></button></th>
                            <th scope="col" class="px-4 py-3 text-right"><button type="button" class="sort-button justify-end {% if sort_by == 'quantidade_total' %}active{% endif %}" data-sort-column="quantidade_total"><span>Quantidade</span><i class="fas {% if sort_by == 'quantidade_total' %}{% if sort_order == 'asc' %}fa-sort-up{% else %}fa-sort-down{% endif %}{% else %}fa-sort{% endif %} sort-icon"></i></button></th>
                            <th scope="col" class="px-4 py-3 text-right"><button type="button" class="sort-button justify-end {% if sort_by == 'valor_total' %}active{% endif %}" data-sort-column="valor_total"><span>Valor</span><i class="fas {% if sort_by == 'valor_total' %}{% if sort_order == 'asc' %}fa-sort-up{% else %}fa-sort-down{% endif %}{% else %}fa-sort{% endif %} sort-icon"></i></button></th>
                            <th scope="col" class="px-4 py-3 text-left"><button type="button" class="sort-button {% if sort_by == 'linha' %}active{% endif %}" data-sort-column="linha"><span>Linha</span><i class="fas {% if sort_by == 'linha' %}{% if sort_order == 'asc' %}fa-sort-up{% else %}fa-sort-down{% endif %}{% else %}fa-sort{% endif %} sort-icon"></i></button></th>
                            <th scope="col" class="px-4 py-3 text-left"><button type="button" class="sort-button {% if sort_by == 'approval_status' %}active{% endif %}" data-sort-column="approval_status"><span>Status</span><i class="fas {% if sort_by == 'approval_status' %}{% if sort_order == 'asc' %}fa-sort-up{% else %}fa-sort-down{% endif %}{% else %}fa-sort{% endif %} sort-icon"></i></button></th>
                            <th scope="col" class="px-4 py-3 text-left"><button type="button" class="sort-button {% if sort_by == 'situation' %}active{% endif %}" data-sort-column="situation"><span>Situação</span><i class="fas {% if sort_by == 'situation' %}{% if sort_order == 'asc' %}fa-sort-up{% else %}fa-sort-down{% endif %}{% else %}fa-sort{% endif %} sort-icon"></i></button></th>
                            <th scope="col" class="px-4 py-3 text-left"><button type="button" class="sort-button {% if sort_by == 'occurrence' %}active{% endif %}" data-sort-column="occurrence"><span>Ocorrência</span><i class="fas {% if sort_by == 'occurrence' %}{% if sort_order == 'asc' %}fa-sort-up{% else %}fa-sort-down{% endif %}{% else %}fa-sort{% endif %} sort-icon"></i></button></th>
                            <th scope="col" class="px-4 py-3 text-left"><button type="button" class="sort-button {% if sort_by == 'production_lots_display' %}active{% endif %}" data-sort-column="production_lots_display"><span>Lote Produção</span><i class="fas {% if sort_by == 'production_lots_display' %}{% if sort_order == 'asc' %}fa-sort-up{% else %}fa-sort-down{% endif %}{% else %}fa-sort{% endif %} sort-icon"></i></button></th>
                            <th scope="col" class="px-4 py-3 text-left"><button type="button" class="sort-button {% if sort_by == 'load_lot' %}active{% endif %}" data-sort-column="load_lot"><span>Lote Carga</span><i class="fas {% if sort_by == 'load_lot' %}{% if sort_order == 'asc' %}fa-sort-up{% else %}fa-sort-down{% endif %}{% else %}fa-sort{% endif %} sort-icon"></i></button></th>
                            <th scope="col" class="px-4 py-3 text-center rounded-tr-lg"><span>Ações</span></th>
                        </tr>
                        <tr class="bg-slate-100 text-xs text-dark-blue">
                            <th scope="col" class="px-4 py-2"><input type="text" name="filter_pedido" value="{{ filters.filter_pedido or '' }}" class="filter-input column-filter-input" placeholder="Pedido"></th>
                            <th scope="col" class="px-4 py-2"><input type="text" name="filter_data" value="{{ filters.filter_data or '' }}" class="filter-input column-filter-input" placeholder="Data"></th>
                            <th scope="col" class="px-4 py-2"><input type="text" name="filter_codigo" value="{{ filters.filter_codigo or '' }}" class="filter-input column-filter-input" placeholder="Código"></th>
                            <th scope="col" class="px-4 py-2"><input type="text" name="filter_cliente" value="{{ filters.filter_cliente or '' }}" class="filter-input column-filter-input" placeholder="Cliente"></th>
                            <th scope="col" class="px-4 py-2"><input type="text" name="filter_quantidade_total" value="{{ filters.filter_quantidade_total or '' }}" class="filter-input column-filter-input text-right" placeholder="Qtd."></th>
                            <th scope="col" class="px-4 py-2"><input type="text" name="filter_valor_total" value="{{ filters.filter_valor_total or '' }}" class="filter-input column-filter-input text-right" placeholder="Valor"></th>
                            <th scope="col" class="px-4 py-2"><input type="text" name="filter_linha" value="{{ filters.filter_linha or '' }}" class="filter-input column-filter-input" placeholder="Linha"></th>
                            <th scope="col" class="px-4 py-2"><input type="text" name="filter_approval_status" value="{{ filters.filter_approval_status or '' }}" class="filter-input column-filter-input" placeholder="Status"></th>
                            <th scope="col" class="px-4 py-2"><input type="text" name="filter_situation" value="{{ filters.filter_situation or '' }}" class="filter-input column-filter-input" placeholder="Situação"></th>
                            <th scope="col" class="px-4 py-2"><input type="text" name="filter_occurrence" value="{{ filters.filter_occurrence or '' }}" class="filter-input column-filter-input" placeholder="Ocorrência"></th>
                            <th scope="col" class="px-4 py-2"><input type="text" name="filter_production_lots_display" value="{{ filters.filter_production_lots_display or '' }}" class="filter-input column-filter-input" placeholder="Lote Produção"></th>
                            <th scope="col" class="px-4 py-2"><input type="text" name="filter_load_lot" value="{{ filters.filter_load_lot or '' }}" class="filter-input column-filter-input" placeholder="Lote Carga"></th>
                            <th scope="col" class="px-4 py-2 text-center">
                                <div class="flex items-center justify-center gap-3">
                                    <button type="submit" class="text-xs font-semibold text-blue-700 hover:underline">Aplicar</button>
                                    <button type="button" id="clearColumnFiltersBtn" class="text-xs text-red-600 hover:underline">Limpar</button>
                                </div>
                            </th>
                            <th scope="col" class="px-4 py-2"></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if orders %}
                        {% for order in orders %}
                        {% set row_bg = 'var(--clr-white)' if loop.index is odd else 'var(--clr-light-gray)' %}
                        <tr class="hover-row text-sm text-dark-blue" style="background-color: {{ row_bg }};">
                            <td class="py-2 px-4 whitespace-nowrap font-semibold">{{ order.pedido }}</td>
                            <td class="py-2 px-4 whitespace-nowrap">{{ order.data or '-' }}</td>
                            <td class="py-2 px-4 whitespace-nowrap">{{ order.codigo or '-' }}</td>
                            <td class="py-2 px-4 whitespace-nowrap">
                                <div class="font-medium">{{ order.cliente or '-' }}</div>
                                {% if order.cidade or order.estado %}
                                <div class="text-xs text-slate-muted">{{ order.cidade }}{% if order.estado %} / {{ order.estado }}{% endif %}</div>
                                {% endif %}
                            </td>
                            <td class="py-2 px-4 whitespace-nowrap text-right">{{ order.quantidade_total | format_decimal_br(0) }}</td>
                            <td class="py-2 px-4 whitespace-nowrap text-right">{{ order.valor_total | format_currency_brl }}</td>
                            <td class="py-2 px-4 whitespace-nowrap">{{ order.linha }}</td>
                            <td class="py-2 px-4 whitespace-nowrap">{{ order.approval_status }}</td>
                            <td class="py-2 px-4 whitespace-nowrap">{{ order.situation }}</td>
                            <td class="py-2 px-4 whitespace-nowrap">{{ order.occurrence or '-' }}</td>
                            <td class="py-2 px-4 whitespace-nowrap">{{ order.production_lots_display or '-' }}</td>
                            <td class="py-2 px-4 whitespace-nowrap">{{ order.load_lot or '-' }}</td>
                            <td class="py-2 px-4 whitespace-nowrap text-center">
                                <button type="button" class="icon-button view-order-btn" data-order-id="{{ order.pedido }}" aria-label="Visualizar pedido {{ order.pedido }}" title="Visualizar pedido {{ order.pedido }}">
                                    <i class="fas fa-eye text-blue-600 hover:text-blue-800"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                        {% else %}
                        <tr>
                            <td colspan="13" class="py-6 px-4 text-center text-sm text-slate-muted">
                                Nenhum pedido encontrado. Ajuste os filtros ou utilize os campos de busca acima.
                            </td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </form>
        </div>
        {% if orders %}
        <div class="bg-gray-100 p-4 rounded-lg mt-4 flex flex-wrap justify-center gap-4">
            <div class="bg-blue-100 text-blue-800 px-4 py-2 rounded-lg text-sm font-semibold">
                Quantidade Total: <span>{{ totals.quantidade_total | format_decimal_br(0) }}</span>
            </div>
            <div class="bg-green-100 text-green-800 px-4 py-2 rounded-lg text-sm font-semibold">
                Valor Total: <span>{{ totals.valor_total | format_currency_brl }}</span>
            </div>
        </div>
        {% else %}
        <div class="text-center py-12 px-4 text-sm text-slate-muted">
            <div class="flex flex-col items-center gap-3">
                <i class="fas fa-file-invoice-dollar text-2xl" style="color: var(--clr-medium-gray);"></i>
                <p class="font-semibold text-dark-blue">Nenhum pedido de venda encontrado.</p>
                <p>Use o botão "Filtrar" para ajustar sua busca.</p>
            </div>
        </div>
        {% endif %}
    </section>
</div>

<div id="filterModal" class="modal">
    <div class="modal-content" style="max-width: 56rem;">
        <div class="flex justify-between items-center mb-4">
            <h2 class="section-heading">Filtrar Pedidos de Venda</h2>
            <button id="closeFilterModalBtn" class="close-button">&times;</button>
        </div>
        <form id="filterForm" action="{{ url_for('sales_orders_list') }}" method="GET" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- Filters will be dynamically created by JS -->
            </div>
            <div class="flex justify-end space-x-4 mt-6">
                <button type="button" id="clearFiltersBtn" class="btn btn-secondary">Limpar Filtros</button>
                <button type="submit" class="btn btn-primary">Aplicar Filtros</button>
            </div>
            <!-- Hidden inputs for column filters -->
        </form>
</div>
</div>

<div id="orderDetailsModal" class="modal">
    <div class="modal-content order-detail-modal-content p-6 md:p-8 rounded-xl space-y-4">
        <div class="flex items-center justify-between">
            <h2 class="section-heading">Detalhes do Pedido</h2>
            <button id="closeOrderDetailsModalBtn" class="close-button" aria-label="Fechar detalhes do pedido">&times;</button>
        </div>
        <div id="orderDetailsLoading" class="py-6 text-center text-sm text-dark-blue hidden">
            <i class="fas fa-spinner fa-spin mr-2"></i> Carregando detalhes do pedido...
        </div>
        <div id="orderDetailsError" class="py-6 text-center text-sm text-red-600 hidden"></div>
        <div id="orderDetailsContent" class="space-y-4 hidden">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm text-dark-blue">
                <div><span class="font-semibold">Pedido:</span> <span id="orderDetailsPedido">--</span></div>
                <div><span class="font-semibold">Cliente:</span> <span id="orderDetailsCliente">--</span></div>
                <div><span class="font-semibold">Cidade:</span> <span id="orderDetailsCidade">--</span></div>
                <div><span class="font-semibold">UF:</span> <span id="orderDetailsUf">--</span></div>
                <div><span class="font-semibold">Data do Pedido:</span> <span id="orderDetailsDataPedido">--</span></div>
                <div class="md:col-span-2"><span class="font-semibold">Lote de Produção:</span> <span id="orderDetailsLoteProducao">--</span></div>
                <div class="md:col-span-2"><span class="font-semibold">Lote de Carga:</span> <span id="orderDetailsLoteCarga">--</span></div>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white rounded-xl overflow-hidden">
                    <thead class="bg-gray-800 text-white" style="background-color: var(--clr-sidebar-bg);">
                        <tr class="text-xs font-medium uppercase tracking-wider">
                            <th scope="col" class="px-4 py-3 text-left">Código do Produto</th>
                            <th scope="col" class="px-4 py-3 text-left">Sequência</th>
                            <th scope="col" class="px-4 py-3 text-left">Produto</th>
                            <th scope="col" class="px-4 py-3 text-right">Quantidade</th>
                            <th scope="col" class="px-4 py-3 text-right">Valor Tabela</th>
                            <th scope="col" class="px-4 py-3 text-right">% Desconto</th>
                            <th scope="col" class="px-4 py-3 text-right">Valor Unitário</th>
                            <th scope="col" class="px-4 py-3 text-right">IPI</th>
                            <th scope="col" class="px-4 py-3 text-right">% Frete</th>
                            <th scope="col" class="px-4 py-3 text-right">Valor Frete</th>
                            <th scope="col" class="px-4 py-3 text-right">Valor Total</th>
                        </tr>
                    </thead>
                    <tbody id="orderDetailsItemsBody" class="text-sm text-dark-blue"></tbody>
                </table>
            </div>
            <div id="orderDetailsSummary" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-3 hidden">
                <div class="order-summary-card">
                    <p class="order-summary-label">Quantidade Total</p>
                    <p id="orderSummaryQuantity" class="order-summary-value">--</p>
                </div>
                <div class="order-summary-card">
                    <p class="order-summary-label">Valor dos Produtos</p>
                    <p id="orderSummaryProducts" class="order-summary-value">--</p>
                </div>
                <div class="order-summary-card">
                    <p class="order-summary-label">Valor do IPI</p>
                    <p id="orderSummaryIpi" class="order-summary-value">--</p>
                </div>
                <div class="order-summary-card">
                    <p class="order-summary-label">Valor do Frete</p>
                    <p id="orderSummaryFrete" class="order-summary-value">--</p>
                </div>
                <div class="order-summary-card">
                    <p class="order-summary-label">Valor Total</p>
                    <p id="orderSummaryTotal" class="order-summary-value">--</p>
                </div>
            </div>
            <div id="orderDetailsEmptyState" class="hidden text-sm text-center text-slate-muted">
                Nenhum item encontrado para este pedido.
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const filterModal = document.getElementById('filterModal');
    const openFilterModalBtn = document.getElementById('openFilterModalBtn');
    const closeFilterModalBtn = document.getElementById('closeFilterModalBtn');
    const clearFiltersBtn = document.getElementById('clearFiltersBtn');
    const filterForm = document.getElementById('filterForm');
    const columnFilterForm = document.getElementById('columnFilterForm');
    const orderDetailsModal = document.getElementById('orderDetailsModal');
    const closeOrderDetailsModalBtn = document.getElementById('closeOrderDetailsModalBtn');
    const orderDetailsPedidoEl = document.getElementById('orderDetailsPedido');
    const orderDetailsClienteEl = document.getElementById('orderDetailsCliente');
    const orderDetailsCidadeEl = document.getElementById('orderDetailsCidade');
    const orderDetailsUfEl = document.getElementById('orderDetailsUf');
    const orderDetailsDataEl = document.getElementById('orderDetailsDataPedido');
    const orderDetailsLoteProducaoEl = document.getElementById('orderDetailsLoteProducao');
    const orderDetailsLoteCargaEl = document.getElementById('orderDetailsLoteCarga');
    const orderDetailsLoadingEl = document.getElementById('orderDetailsLoading');
    const orderDetailsErrorEl = document.getElementById('orderDetailsError');
    const orderDetailsContentEl = document.getElementById('orderDetailsContent');
    const orderDetailsItemsBody = document.getElementById('orderDetailsItemsBody');
    const orderDetailsEmptyStateEl = document.getElementById('orderDetailsEmptyState');
    const orderDetailsSummaryEl = document.getElementById('orderDetailsSummary');
    const orderSummaryQuantityEl = document.getElementById('orderSummaryQuantity');
    const orderSummaryProductsEl = document.getElementById('orderSummaryProducts');
    const orderSummaryIpiEl = document.getElementById('orderSummaryIpi');
    const orderSummaryFreteEl = document.getElementById('orderSummaryFrete');
    const orderSummaryTotalEl = document.getElementById('orderSummaryTotal');
    
    const sortableButtons = document.querySelectorAll('[data-sort-column]');
    const sortByInput = document.getElementById('columnSortByInput');
    const sortOrderInput = document.getElementById('columnSortOrderInput');

    const safeText = (value, fallback = '--') => {
        if (value === undefined || value === null) {
            return fallback;
        }
        const text = String(value).trim();
        return text === '' ? fallback : text;
    };

    const setTextContent = (element, value, fallback = '--') => {
        if (!element) return;
        element.textContent = safeText(value, fallback);
    };

    const setListContent = (element, value, fallback = '--') => {
        if (!element) return;
        element.textContent = '';
        const values = Array.isArray(value)
            ? value
            : String(value || '')
                  .split(';')
                  .map((item) => item.trim())
                  .filter((item) => item.length > 0);
        if (values.length === 0) {
            element.textContent = fallback;
            return;
        }
        values.forEach((item, index) => {
            if (index > 0) {
                element.appendChild(document.createElement('br'));
            }
            element.appendChild(document.createTextNode(item));
        });
    };

    const formatNumber = (value, decimals = 2) => {
        const number = Number(value);
        if (!Number.isFinite(number)) {
            return Number(0).toLocaleString('pt-BR', {
                minimumFractionDigits: decimals,
                maximumFractionDigits: decimals,
            });
        }
        return number.toLocaleString('pt-BR', {
            minimumFractionDigits: decimals,
            maximumFractionDigits: decimals,
        });
    };

    const formatCurrency = (value) => {
        const number = Number(value);
        if (!Number.isFinite(number)) {
            return Number(0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }
        return number.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    };

    const formatPercentage = (value) => `${formatNumber(value, 2)}%`;

    const toNumber = (value) => {
        const number = Number(value);
        return Number.isFinite(number) ? number : 0;
    };

    const resetOrderSummary = () => {
        if (!orderDetailsSummaryEl) return;
        orderDetailsSummaryEl.classList.add('hidden');
        if (orderSummaryQuantityEl) orderSummaryQuantityEl.textContent = '--';
        if (orderSummaryProductsEl) orderSummaryProductsEl.textContent = '--';
        if (orderSummaryIpiEl) orderSummaryIpiEl.textContent = '--';
        if (orderSummaryFreteEl) orderSummaryFreteEl.textContent = '--';
        if (orderSummaryTotalEl) orderSummaryTotalEl.textContent = '--';
    };

    const updateOrderSummary = (totals) => {
        if (!orderDetailsSummaryEl || !totals) return;
        if (orderSummaryQuantityEl) orderSummaryQuantityEl.textContent = formatNumber(totals.quantidade, 2);
        if (orderSummaryProductsEl) orderSummaryProductsEl.textContent = formatCurrency(totals.produtos);
        if (orderSummaryIpiEl) orderSummaryIpiEl.textContent = formatCurrency(totals.ipi);
        if (orderSummaryFreteEl) orderSummaryFreteEl.textContent = formatCurrency(totals.frete);
        if (orderSummaryTotalEl) orderSummaryTotalEl.textContent = formatCurrency(totals.total);
        orderDetailsSummaryEl.classList.remove('hidden');
    };

    const updateOrderHeader = (header = {}) => {
        setTextContent(orderDetailsPedidoEl, header.pedido);
        setTextContent(orderDetailsClienteEl, header.cliente);
        setTextContent(orderDetailsCidadeEl, header.cidade);
        setTextContent(orderDetailsUfEl, header.uf);
        setTextContent(orderDetailsDataEl, header.data_pedido);
        setListContent(orderDetailsLoteProducaoEl, header.lote_producao);
        setTextContent(orderDetailsLoteCargaEl, header.lote_carga);
    };

    const renderOrderItems = (items = []) => {
        if (!orderDetailsItemsBody) return;
        orderDetailsItemsBody.innerHTML = '';
        resetOrderSummary();

        if (!Array.isArray(items) || items.length === 0) {
            if (orderDetailsEmptyStateEl) {
                orderDetailsEmptyStateEl.classList.remove('hidden');
            }
            return;
        }

        if (orderDetailsEmptyStateEl) {
            orderDetailsEmptyStateEl.classList.add('hidden');
        }

        const totals = {
            quantidade: 0,
            produtos: 0,
            ipi: 0,
            frete: 0,
            total: 0,
        };

        items.forEach((item) => {
            const quantityValue = toNumber(item.quantidade_total);
            const productsValue = toNumber(item.valor_unitario_total);
            const ipiValue = toNumber(item.valor_ipi);
            const freightValue = toNumber(item.valor_frete);
            const totalValue = toNumber(item.valor_total);

            const row = document.createElement('tr');
            row.className = 'hover-row text-sm text-dark-blue';

            const cells = [
                { text: safeText(item.codigo_produto), className: 'py-3 px-4 whitespace-nowrap font-semibold' },
                { text: safeText(item.sequencia), className: 'py-3 px-4 whitespace-nowrap' },
                { text: safeText(item.produto), className: 'py-3 px-4 whitespace-nowrap' },
                { text: formatNumber(quantityValue, 2), className: 'py-3 px-4 whitespace-nowrap text-right' },
                { text: formatCurrency(item.valor_tabela), className: 'py-3 px-4 whitespace-nowrap text-right' },
                { text: formatPercentage(item.percentual_desconto), className: 'py-3 px-4 whitespace-nowrap text-right' },
                { text: formatCurrency(productsValue), className: 'py-3 px-4 whitespace-nowrap text-right' },
                { text: formatCurrency(ipiValue), className: 'py-3 px-4 whitespace-nowrap text-right' },
                { text: formatPercentage(item.percentual_frete), className: 'py-3 px-4 whitespace-nowrap text-right' },
                { text: formatCurrency(freightValue), className: 'py-3 px-4 whitespace-nowrap text-right' },
                { text: formatCurrency(totalValue), className: 'py-3 px-4 whitespace-nowrap text-right' },
            ];

            cells.forEach((cellData) => {
                const cell = document.createElement('td');
                cell.className = cellData.className;
                cell.textContent = cellData.text;
                row.appendChild(cell);
            });

            totals.quantidade += quantityValue;
            totals.produtos += productsValue;
            totals.ipi += ipiValue;
            totals.frete += freightValue;
            totals.total += totalValue;

            orderDetailsItemsBody.appendChild(row);
        });

        updateOrderSummary(totals);
    };

    const resetOrderDetailsModal = () => {
        updateOrderHeader({});
        resetOrderSummary();
        if (orderDetailsItemsBody) {
            orderDetailsItemsBody.innerHTML = '';
        }
        if (orderDetailsEmptyStateEl) {
            orderDetailsEmptyStateEl.classList.add('hidden');
        }
        if (orderDetailsLoadingEl) {
            orderDetailsLoadingEl.classList.add('hidden');
        }
        if (orderDetailsErrorEl) {
            orderDetailsErrorEl.classList.add('hidden');
            orderDetailsErrorEl.textContent = '';
        }
        if (orderDetailsContentEl) {
            orderDetailsContentEl.classList.add('hidden');
        }
    };

    const showOrderDetailsLoading = () => {
        if (orderDetailsLoadingEl) {
            orderDetailsLoadingEl.classList.remove('hidden');
        }
        if (orderDetailsErrorEl) {
            orderDetailsErrorEl.classList.add('hidden');
        }
        if (orderDetailsContentEl) {
            orderDetailsContentEl.classList.add('hidden');
        }
    };

    const showOrderDetailsContent = () => {
        if (orderDetailsContentEl) {
            orderDetailsContentEl.classList.remove('hidden');
        }
        if (orderDetailsLoadingEl) {
            orderDetailsLoadingEl.classList.add('hidden');
        }
        if (orderDetailsErrorEl) {
            orderDetailsErrorEl.classList.add('hidden');
        }
    };

    const showOrderDetailsError = (message) => {
        if (orderDetailsErrorEl) {
            orderDetailsErrorEl.textContent = message || 'Não foi possível carregar os detalhes do pedido.';
            orderDetailsErrorEl.classList.remove('hidden');
        }
        if (orderDetailsLoadingEl) {
            orderDetailsLoadingEl.classList.add('hidden');
        }
        if (orderDetailsContentEl) {
            orderDetailsContentEl.classList.add('hidden');
        }
        if (orderDetailsEmptyStateEl) {
            orderDetailsEmptyStateEl.classList.add('hidden');
        }
    };

    const openOrderDetailsModal = () => {
        if (!orderDetailsModal) return;
        orderDetailsModal.style.display = 'flex';
    };

    const closeOrderDetailsModal = () => {
        if (!orderDetailsModal) return;
        orderDetailsModal.style.display = 'none';
        resetOrderDetailsModal();
    };

    resetOrderDetailsModal();

    if (closeOrderDetailsModalBtn) {
        closeOrderDetailsModalBtn.addEventListener('click', closeOrderDetailsModal);
    }

    if (orderDetailsModal) {
        orderDetailsModal.addEventListener('click', (event) => {
            if (event.target === orderDetailsModal) {
                closeOrderDetailsModal();
            }
        });
    }

    // Generic Dropdown Logic
    const createDropdown = (id, label, name, options, selected, isMulti=true) => {
        const container = document.createElement('div');
        container.className = 'form-group';

        const labelEl = document.createElement('label');
        labelEl.className = 'form-label';
        labelEl.textContent = label;
        container.appendChild(labelEl);

        const dropdownContainer = document.createElement('div');
        dropdownContainer.id = `${id}DropdownContainer`;
        dropdownContainer.className = 'relative';
        container.appendChild(dropdownContainer);

        const toggleBtn = document.createElement('button');
        toggleBtn.type = 'button';
        toggleBtn.id = `${id}DropdownToggle`;
        toggleBtn.className = 'form-input cursor-pointer flex items-center justify-between';
        toggleBtn.innerHTML = `<span id="${id}DropdownLabel" class="text-left truncate">${isMulti ? `Selecione ${label.toLowerCase()}` : 'Selecione uma opção'}</span><i class="fas fa-chevron-down ml-2 text-gray-500"></i>`;
        dropdownContainer.appendChild(toggleBtn);

        const dropdownMenu = document.createElement('div');
        dropdownMenu.id = `${id}Dropdown`;
        dropdownMenu.className = 'hidden absolute z-20 mt-1 w-full bg-white border border-gray-300 rounded-lg shadow-lg p-3';
        dropdownContainer.appendChild(dropdownMenu);

        const optionsContainer = document.createElement('div');
        optionsContainer.className = 'max-h-60 overflow-y-auto space-y-2';
        dropdownMenu.appendChild(optionsContainer);

        if (options && options.length > 0) {
            options.forEach(opt => {
                const optionLabel = document.createElement('label');
                optionLabel.className = 'flex items-center space-x-2 cursor-pointer';
                
                const input = document.createElement('input');
                input.type = isMulti ? 'checkbox' : 'radio';
                input.name = name;
                input.value = opt.value;
                input.dataset.display = opt.label;
                if (isMulti && selected.includes(opt.value)) {
                    input.checked = true;
                } else if (!isMulti && selected === opt.value) {
                    input.checked = true;
                }
                
                const span = document.createElement('span');
                span.className = 'text-sm text-gray-700';
                span.textContent = opt.label;

                optionLabel.appendChild(input);
                optionLabel.appendChild(span);
                optionsContainer.appendChild(optionLabel);
            });
        } else {
            optionsContainer.innerHTML = `<p class="text-sm text-gray-500">Nenhuma opção disponível.</p>`;
        }

        if (isMulti) {
            const footer = document.createElement('div');
            footer.className = 'flex justify-end pt-2 mt-2 border-t border-gray-200';
            const clearBtn = document.createElement('button');
            clearBtn.type = 'button';
            clearBtn.id = `${id}ClearBtn`;
            clearBtn.className = 'text-sm text-red-600 hover:underline';
            clearBtn.textContent = 'Limpar seleção';
            footer.appendChild(clearBtn);
            dropdownMenu.appendChild(footer);
        }
        
        return container;
    };
    
    const setupDropdown = (id, name, isMulti=true) => {
        const container = document.getElementById(`${id}DropdownContainer`);
        if (!container) return;
        
        const toggle = document.getElementById(`${id}DropdownToggle`);
        const dropdown = document.getElementById(`${id}Dropdown`);
        const label = document.getElementById(`${id}DropdownLabel`);
        const clearBtn = document.getElementById(`${id}ClearBtn`);
        const inputs = Array.from(container.querySelectorAll(`input[name="${name}"]`));

        const updateLabel = () => {
            const selected = inputs.filter(i => i.checked);
            if (selected.length === 0) {
                label.textContent = isMulti ? `Selecione ${label.textContent.toLowerCase()}` : 'Selecione uma opção';
            } else if (selected.length === 1) {
                label.textContent = selected[0].dataset.display || selected[0].value;
            } else {
                label.textContent = `${selected.length} selecionados`;
            }
        };

        toggle.addEventListener('click', (e) => {
            e.stopPropagation();
            document.querySelectorAll('.absolute.z-20').forEach(d => {
                if (d !== dropdown) d.classList.add('hidden');
            });
            dropdown.classList.toggle('hidden');
        });

        if (clearBtn) {
            clearBtn.addEventListener('click', () => {
                inputs.forEach(i => i.checked = false);
                updateLabel();
            });
        }

        inputs.forEach(i => i.addEventListener('change', () => {
            if (!isMulti) {
                dropdown.classList.add('hidden');
            }
            updateLabel();
        }));
        
        updateLabel();
    };

    const filterGrid = filterForm.querySelector('.grid');
    
    // Filter Definitions
    const cityOptions = {{ city_options | tojson }};
    const stateOptions = {{ state_options | tojson }};
    const vendorOptions = {{ vendor_options | tojson }};
    const statusOptions = {{ approval_status_options | tojson }};
    const situationOptions = {{ situation_options | tojson }};
    const occurrenceOptions = {{ occurrence_options | tojson }};
    const loadLotFilterOptions = {{ load_lot_filter_options | tojson }};
    const productionLotFilterOptions = {{ production_lot_filter_options | tojson }};
    
    const filters = {{ filters | tojson }};

    filterGrid.appendChild(createDropdown('city', 'Cidades', 'cities', cityOptions.map(c => ({value: c, label: c})), filters.cities || []));
    filterGrid.appendChild(createDropdown('state', 'Estados', 'states', stateOptions.map(s => ({value: s, label: s})), filters.states || []));
    filterGrid.appendChild(createDropdown('vendor', 'Vendedores', 'vendors', vendorOptions.map(v => ({value: v.code, label: v.name || v.code})), filters.vendors || []));
    filterGrid.appendChild(createDropdown('status', 'Status', 'statuses', statusOptions.map(s => ({value: s.code, label: s.label})), filters.statuses || []));
    filterGrid.appendChild(createDropdown('situation', 'Situações', 'situations', situationOptions.map(s => ({value: s.code, label: s.label})), filters.situations || []));
    filterGrid.appendChild(createDropdown('occurrence', 'Ocorrências', 'occurrences', occurrenceOptions.map(o => ({value: o.code, label: `${o.code} - ${o.description}`})), filters.occurrences || []));
    filterGrid.appendChild(createDropdown('hasLoadLot', 'Lote de Carga', 'has_load_lot', loadLotFilterOptions.map(o => ({value: o.value, label: o.label})), filters.has_load_lot || [], false));
    filterGrid.appendChild(createDropdown('hasProductionLot', 'Lote de Produção', 'has_production_lot', productionLotFilterOptions.map(o => ({value: o.value, label: o.label})), filters.has_production_lot || [], false));

    // Date filters
    const dateContainer = document.createElement('div');
    dateContainer.className = 'form-group';
    dateContainer.innerHTML = `
        <label class="form-label">Período (Data do Pedido)</label>
        <div class="grid grid-cols-2 gap-2">
            <input type="date" name="start_date" class="form-input" value="${filters.start_date || ''}">
            <input type="date" name="end_date" class="form-input" value="${filters.end_date || ''}">
        </div>
    `;
    filterGrid.appendChild(dateContainer);

    // Setup all created dropdowns
    setupDropdown('city', 'cities');
    setupDropdown('state', 'states');
    setupDropdown('vendor', 'vendors');
    setupDropdown('status', 'statuses');
    setupDropdown('situation', 'situations');
    setupDropdown('occurrence', 'occurrences');
    setupDropdown('hasLoadLot', 'has_load_lot', false);
    setupDropdown('hasProductionLot', 'has_production_lot', false);

    // Modal handling
    const openFilterModal = () => filterModal.style.display = 'flex';
    const closeFilterModal = () => filterModal.style.display = 'none';

    openFilterModalBtn.addEventListener('click', openFilterModal);
    closeFilterModalBtn.addEventListener('click', closeFilterModal);
    clearFiltersBtn.addEventListener('click', () => {
        window.location.href = "{{ url_for('sales_orders_list') }}";
    });
    filterModal.addEventListener('click', (e) => {
        if (e.target === filterModal) closeFilterModal();
    });
    document.addEventListener('keydown', (e) => {
        if (e.key !== 'Escape') return;
        if (filterModal && filterModal.style.display === 'flex') {
            closeFilterModal();
        }
        if (orderDetailsModal && orderDetailsModal.style.display === 'flex') {
            closeOrderDetailsModal();
        }
    });
    
    // Sorting
    sortableButtons.forEach(button => {
        button.addEventListener('click', () => {
            const column = button.dataset.sortColumn;
            const currentOrder = sortOrderInput.value;
            
            let nextOrder = 'asc';
            if (sortByInput.value === column && currentOrder === 'asc') {
                nextOrder = 'desc';
            }
            
            sortByInput.value = column;
            sortOrderInput.value = nextOrder;
            
            columnFilterForm.submit();
        });
    });

    // Column Filtering
    const columnFilterInputs = columnFilterForm.querySelectorAll('.column-filter-input');
    const clearColumnFiltersBtn = document.getElementById('clearColumnFiltersBtn');

    const debounce = (callback, delay = 300) => {
        let timeoutId;
        return (...args) => {
            clearTimeout(timeoutId);
            timeoutId = setTimeout(() => {
                callback.apply(null, args);
            }, delay);
        };
    };

    const debouncedColumnSubmit = debounce(() => columnFilterForm.submit(), 500);

    columnFilterInputs.forEach(input => {
        input.addEventListener('input', debouncedColumnSubmit);
    });

    clearColumnFiltersBtn.addEventListener('click', (e) => {
        e.preventDefault();
        columnFilterInputs.forEach(input => input.value = '');
        columnFilterForm.submit();
    });

    const viewOrderButtons = document.querySelectorAll('.view-order-btn');

    viewOrderButtons.forEach((button) => {
        button.addEventListener('click', async () => {
            if (!orderDetailsModal) return;

            const pedido = button.dataset.orderId;
            if (!pedido) return;

            resetOrderDetailsModal();
            openOrderDetailsModal();
            showOrderDetailsLoading();

            const originalInnerHTML = button.innerHTML;
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span>Carregando...</span>';

            try {
                const response = await fetch(`/orders/${encodeURIComponent(pedido)}/details`);
                let data = null;
                try {
                    data = await response.json();
                } catch {
                    data = null;
                }

                if (!response.ok) {
                    const message = data && data.error ? data.error : 'Não foi possível carregar os detalhes do pedido.';
                    throw new Error(message);
                }

                if (!data) {
                    throw new Error('Resposta inválida do servidor.');
                }

                updateOrderHeader(data.header || {});
                renderOrderItems(Array.isArray(data.items) ? data.items : []);
                showOrderDetailsContent();
            } catch (error) {
                console.error('Erro ao carregar detalhes do pedido:', error);
                showOrderDetailsError(error.message);
            } finally {
                button.innerHTML = originalInnerHTML;
                button.disabled = false;
                button.blur();
            }
        });
    });

    // Sync column filters with modal form on submit
    filterForm.addEventListener('submit', () => {
        const columnFilters = columnFilterForm.querySelectorAll('.column-filter-input');
        columnFilters.forEach(cf => {
            let hiddenInput = filterForm.querySelector(`input[name="${cf.name}"]`);
            if (!hiddenInput) {
                hiddenInput = document.createElement('input');
                hiddenInput.type = 'hidden';
                hiddenInput.name = cf.name;
                filterForm.appendChild(hiddenInput);
            }
            hiddenInput.value = cf.value;
        });
    });
    
    document.addEventListener('click', (e) => {
        const openDropdown = document.querySelector('.absolute.z-20:not(.hidden)');
        if (openDropdown && !openDropdown.parentElement.contains(e.target)) {
            openDropdown.classList.add('hidden');
        }
    });
});
</script>
{% endblock %}
