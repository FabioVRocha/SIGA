{% extends "base.html" %}

{% block title %}Pedidos de Vendas{% endblock %}

{% block page_title %}Pedidos de Vendas{% endblock %}

{% block content %}
<style>
    .list-section {
        background-color: var(--clr-card-bg);
        border-radius: 0.75rem;
        border: 1px solid var(--clr-border);
        box-shadow: 0 1px 3px rgba(15, 23, 42, 0.12);
        padding: 1.5rem;
    }
    @media (min-width: 1024px) {
        .list-section {
            padding: 2rem;
        }
    }
    .filter-dropdown {
        position: relative;
    }
    .filter-dropdown__toggle {
        width: 100%;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 0.75rem;
        border: 1px solid var(--clr-border);
        border-radius: 0.5rem;
        font-size: 0.85rem;
        color: var(--clr-dark-blue);
        background-color: var(--clr-white);
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }
    .filter-dropdown__toggle:hover {
        border-color: var(--clr-light-blue);
    }
    .filter-dropdown__toggle:focus-visible {
        outline: 2px solid var(--clr-light-blue);
        outline-offset: 2px;
    }
    .filter-dropdown__menu {
        position: absolute;
        top: calc(100% + 0.5rem);
        left: 0;
        width: 100%;
        max-height: 16rem;
        overflow-y: auto;
        background-color: var(--clr-white);
        border: 1px solid var(--clr-border);
        border-radius: 0.75rem;
        box-shadow: 0 10px 25px rgba(15, 23, 42, 0.15);
        z-index: 30;
    }
    .filter-dropdown__menu label {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 0.75rem;
        font-size: 0.8rem;
        color: var(--clr-dark-blue);
    }
    .filter-dropdown__menu label:hover {
        background-color: rgba(79, 131, 204, 0.1);
    }
    .filter-dropdown__clear {
        width: 100%;
        text-align: right;
        padding: 0.5rem 0.75rem;
        border-top: 1px solid var(--clr-border);
        font-size: 0.75rem;
        color: var(--clr-light-blue);
        background-color: transparent;
    }
    .filter-dropdown__clear:hover {
        text-decoration: underline;
    }
</style>

<div class="space-y-6">
    <section class="list-section">
        <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
            <div>
                <h2 class="text-lg font-semibold text-gray-800">Pedidos de Vendas</h2>
                <p class="text-xs text-gray-500">
                    Exibindo {{ orders|length if orders else 0 }} registros.
                </p>
            </div>
            <div class="flex items-center gap-2">
                <button id="openFilterModalBtn" class="btn-primary flex items-center px-4 py-2 rounded-lg">
                    <i class="fas fa-filter mr-2"></i> Filtrar
                </button>
                <a href="{{ url_for('sales_orders_list') }}" class="btn-secondary flex items-center px-4 py-2 rounded-lg">
                    <i class="fas fa-eraser mr-2"></i> Limpar
                </a>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mt-4 text-sm">
            <div class="p-3 rounded-lg bg-slate-100 border border-slate-200">
                <p class="text-xs text-slate-500 uppercase tracking-wide">Quantidade Total</p>
                <p class="text-lg font-semibold text-slate-800">
                    {{ totals.quantidade_total | format_decimal_br(0) }}
                </p>
            </div>
            <div class="p-3 rounded-lg bg-slate-100 border border-slate-200">
                <p class="text-xs text-slate-500 uppercase tracking-wide">Valor Total</p>
                <p class="text-lg font-semibold text-slate-800">
                    {{ totals.valor_total | format_currency_brl }}
                </p>
            </div>
        </div>

        <div class="overflow-x-auto mt-6">
            <table class="min-w-full bg-white rounded-xl overflow-hidden">
                <thead class="bg-gray-800 text-white" style="background-color: var(--clr-sidebar-bg);">
                    <tr class="text-xs font-medium uppercase tracking-wider">
                        <th class="px-4 py-3 text-left">Pedido</th>
                        <th class="px-4 py-3 text-left">Data</th>
                        <th class="px-4 py-3 text-left">C&oacute;digo</th>
                        <th class="px-4 py-3 text-left">Cliente</th>
                        <th class="px-4 py-3 text-right">Quantidade</th>
                        <th class="px-4 py-3 text-right">Valor</th>
                        <th class="px-4 py-3 text-left">Linha</th>
                        <th class="px-4 py-3 text-left">Status</th>
                        <th class="px-4 py-3 text-left">Situa&ccedil;&atilde;o</th>
                        <th class="px-4 py-3 text-left">Ocorr&ecirc;ncia</th>
                        <th class="px-4 py-3 text-left">Lote de Produ&ccedil;&atilde;o</th>
                        <th class="px-4 py-3 text-left">Lote de Carga</th>
                    </tr>
                </thead>
                <tbody class="text-xs text-gray-700">
                    {% if orders %}
                        {% for order in orders %}
                        <tr class="odd:bg-white even:bg-slate-50">
                            <td class="px-4 py-3 font-semibold text-gray-800">{{ order.pedido }}</td>
                            <td class="px-4 py-3">{{ order.data or '-' }}</td>
                            <td class="px-4 py-3">{{ order.codigo or '-' }}</td>
                            <td class="px-4 py-3">
                                <div class="font-medium text-gray-800">{{ order.cliente or '-' }}</div>
                                {% if order.cidade or order.estado %}
                                <div class="text-[11px] text-gray-500">
                                    {{ order.cidade }}{% if order.estado %} / {{ order.estado }}{% endif %}
                                </div>
                                {% endif %}
                            </td>
                            <td class="px-4 py-3 text-right">{{ order.quantidade_total | format_decimal_br(0) }}</td>
                            <td class="px-4 py-3 text-right">{{ order.valor_total | format_currency_brl }}</td>
                            <td class="px-4 py-3">{{ order.linha }}</td>
                            <td class="px-4 py-3">{{ order.approval_status }}</td>
                            <td class="px-4 py-3">{{ order.situation }}</td>
                            <td class="px-4 py-3">{{ order.occurrence or '-' }}</td>
                            <td class="px-4 py-3">{{ order.production_lots_display or '-' }}</td>
                            <td class="px-4 py-3">{{ order.load_lot or '-' }}</td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="12" class="px-4 py-6 text-center text-gray-500">
                                Nenhum pedido encontrado para os filtros informados.
                            </td>
                        </tr>
                    {% endif %}
                </tbody>
                {% if orders %}
                <tfoot class="bg-slate-100 text-xs font-semibold text-gray-700">
                    <tr>
                        <td colspan="4" class="px-4 py-3 text-right">Totais:</td>
                        <td class="px-4 py-3 text-right">{{ totals.quantidade_total | format_decimal_br(0) }}</td>
                        <td class="px-4 py-3 text-right">{{ totals.valor_total | format_currency_brl }}</td>
                        <td colspan="6"></td>
                    </tr>
                </tfoot>
                {% endif %}
            </table>
        </div>
    </section>
</div>

<div id="filterModal" class="fixed inset-0 z-40 hidden items-center justify-center bg-black bg-opacity-40 p-4">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between border-b border-gray-200 px-6 py-4">
            <h3 class="text-lg font-semibold text-gray-800">Filtrar pedidos</h3>
            <button id="closeFilterModalBtn" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times text-lg"></i>
            </button>
        </div>
        <form id="filterForm" method="get" action="{{ url_for('sales_orders_list') }}" class="px-6 py-5 space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
                <div>
                    <label class="block text-xs font-semibold text-gray-600 mb-2 uppercase tracking-wide">
                        Cidade
                    </label>
                    <div class="filter-dropdown" data-dropdown>
                        <button type="button"
                                class="filter-dropdown__toggle"
                                data-dropdown-toggle
                                data-target="cityDropdownMenu"
                                data-default-label="Selecione cidades">
                            <span data-dropdown-label>Selecione cidades</span>
                            <i class="fas fa-chevron-down text-xs"></i>
                        </button>
                        <div id="cityDropdownMenu" class="filter-dropdown__menu hidden" data-dropdown-menu>
                            <div class="max-h-48 overflow-y-auto">
                                {% for city in city_options %}
                                <label>
                                    <input type="checkbox"
                                           name="cities"
                                           value="{{ city }}"
                                           data-label="{{ city }}"
                                           {% if city in filters.cities %}checked{% endif %}>
                                    <span>{{ city }}</span>
                                </label>
                                {% endfor %}
                            </div>
                            <button type="button" class="filter-dropdown__clear" data-dropdown-clear>Limpar</button>
                        </div>
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-semibold text-gray-600 mb-2 uppercase tracking-wide">
                        Estado
                    </label>
                    <div class="filter-dropdown" data-dropdown>
                        <button type="button"
                                class="filter-dropdown__toggle"
                                data-dropdown-toggle
                                data-target="stateDropdownMenu"
                                data-default-label="Selecione estados">
                            <span data-dropdown-label>Selecione estados</span>
                            <i class="fas fa-chevron-down text-xs"></i>
                        </button>
                        <div id="stateDropdownMenu" class="filter-dropdown__menu hidden" data-dropdown-menu>
                            <div class="max-h-48 overflow-y-auto">
                                {% for state in state_options %}
                                <label>
                                    <input type="checkbox"
                                           name="states"
                                           value="{{ state }}"
                                           data-label="{{ state }}"
                                           {% if state in filters.states %}checked{% endif %}>
                                    <span>{{ state }}</span>
                                </label>
                                {% endfor %}
                            </div>
                            <button type="button" class="filter-dropdown__clear" data-dropdown-clear>Limpar</button>
                        </div>
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-semibold text-gray-600 mb-2 uppercase tracking-wide">
                        Vendedor
                    </label>
                    <div class="filter-dropdown" data-dropdown>
                        <button type="button"
                                class="filter-dropdown__toggle"
                                data-dropdown-toggle
                                data-target="vendorDropdownMenu"
                                data-default-label="Selecione vendedores">
                            <span data-dropdown-label>Selecione vendedores</span>
                            <i class="fas fa-chevron-down text-xs"></i>
                        </button>
                        <div id="vendorDropdownMenu" class="filter-dropdown__menu hidden" data-dropdown-menu>
                            <div class="max-h-48 overflow-y-auto">
                                {% for vendor in vendor_options %}
                                <label>
                                    <input type="checkbox"
                                           name="vendors"
                                           value="{{ vendor.code }}"
                                           data-label="{{ vendor.name if vendor.name else vendor.code }}"
                                           {% if vendor.code in filters.vendors %}checked{% endif %}>
                                    <span>{{ vendor.code }}{% if vendor.name %} - {{ vendor.name }}{% endif %}</span>
                                </label>
                                {% endfor %}
                            </div>
                            <button type="button" class="filter-dropdown__clear" data-dropdown-clear>Limpar</button>
                        </div>
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-semibold text-gray-600 mb-2 uppercase tracking-wide">
                        Status
                    </label>
                    <div class="filter-dropdown" data-dropdown>
                        <button type="button"
                                class="filter-dropdown__toggle"
                                data-dropdown-toggle
                                data-target="statusDropdownMenu"
                                data-default-label="Selecione status">
                            <span data-dropdown-label>Selecione status</span>
                            <i class="fas fa-chevron-down text-xs"></i>
                        </button>
                        <div id="statusDropdownMenu" class="filter-dropdown__menu hidden" data-dropdown-menu>
                            <div class="max-h-48 overflow-y-auto">
                                {% for status in approval_status_options %}
                                <label>
                                    <input type="checkbox"
                                           name="statuses"
                                           value="{{ status.code }}"
                                           data-label="{{ status.label }}"
                                           {% if status.code in filters.statuses %}checked{% endif %}>
                                    <span>{{ status.label }}</span>
                                </label>
                                {% endfor %}
                            </div>
                            <button type="button" class="filter-dropdown__clear" data-dropdown-clear>Limpar</button>
                        </div>
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-semibold text-gray-600 mb-2 uppercase tracking-wide">
                        Situa&ccedil;&atilde;o
                    </label>
                    <div class="filter-dropdown" data-dropdown>
                        <button type="button"
                                class="filter-dropdown__toggle"
                                data-dropdown-toggle
                                data-target="situationDropdownMenu"
                                data-default-label="Selecione situa&ccedil;&otilde;es">
                            <span data-dropdown-label>Selecione situa&ccedil;&otilde;es</span>
                            <i class="fas fa-chevron-down text-xs"></i>
                        </button>
                        <div id="situationDropdownMenu" class="filter-dropdown__menu hidden" data-dropdown-menu>
                            <div class="max-h-48 overflow-y-auto">
                                {% for situation in situation_options %}
                                <label>
                                    <input type="checkbox"
                                           name="situations"
                                           value="{{ situation.code }}"
                                           data-label="{{ situation.label }}"
                                           {% if situation.code in filters.situations %}checked{% endif %}>
                                    <span>{{ situation.label }}</span>
                                </label>
                                {% endfor %}
                            </div>
                            <button type="button" class="filter-dropdown__clear" data-dropdown-clear>Limpar</button>
                        </div>
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-semibold text-gray-600 mb-2 uppercase tracking-wide">
                        Ocorr&ecirc;ncia
                    </label>
                    <div class="filter-dropdown" data-dropdown>
                        <button type="button"
                                class="filter-dropdown__toggle"
                                data-dropdown-toggle
                                data-target="occurrenceDropdownMenu"
                                data-default-label="Selecione ocorr&ecirc;ncias">
                            <span data-dropdown-label>Selecione ocorr&ecirc;ncias</span>
                            <i class="fas fa-chevron-down text-xs"></i>
                        </button>
                        <div id="occurrenceDropdownMenu" class="filter-dropdown__menu hidden" data-dropdown-menu>
                            <div class="max-h-48 overflow-y-auto">
                                {% for occurrence in occurrence_options %}
                                <label>
                                    <input type="checkbox"
                                           name="occurrences"
                                           value="{{ occurrence.code }}"
                                           data-label="{{ occurrence.code }}{% if occurrence.description %} - {{ occurrence.description }}{% endif %}"
                                           {% if occurrence.code in filters.occurrences %}checked{% endif %}>
                                    <span>
                                        {{ occurrence.code }}{% if occurrence.description %} - {{ occurrence.description }}{% endif %}
                                    </span>
                                </label>
                                {% endfor %}
                            </div>
                            <button type="button" class="filter-dropdown__clear" data-dropdown-clear>Limpar</button>
                        </div>
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-semibold text-gray-600 mb-2 uppercase tracking-wide">
                        Lote de Carga
                    </label>
                    <div class="filter-dropdown" data-dropdown>
                        <button type="button"
                                class="filter-dropdown__toggle"
                                data-dropdown-toggle
                                data-target="loadLotDropdownMenu"
                                data-default-label="Selecione op&ccedil;&otilde;es">
                            <span data-dropdown-label>Selecione op&ccedil;&otilde;es</span>
                            <i class="fas fa-chevron-down text-xs"></i>
                        </button>
                        <div id="loadLotDropdownMenu" class="filter-dropdown__menu hidden" data-dropdown-menu>
                            <div class="max-h-48 overflow-y-auto">
                                {% for option in load_lot_filter_options %}
                                <label>
                                    <input type="checkbox"
                                           name="has_load_lot"
                                           value="{{ option.value }}"
                                           data-label="{{ option.label }}"
                                           {% if option.value in filters.has_load_lot %}checked{% endif %}>
                                    <span>{{ option.label }}</span>
                                </label>
                                {% endfor %}
                            </div>
                            <button type="button" class="filter-dropdown__clear" data-dropdown-clear>Limpar</button>
                        </div>
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-semibold text-gray-600 mb-2 uppercase tracking-wide">
                        Lote de Produ&ccedil;&atilde;o
                    </label>
                    <div class="filter-dropdown" data-dropdown>
                        <button type="button"
                                class="filter-dropdown__toggle"
                                data-dropdown-toggle
                                data-target="productionLotDropdownMenu"
                                data-default-label="Selecione op&ccedil;&otilde;es">
                            <span data-dropdown-label>Selecione op&ccedil;&otilde;es</span>
                            <i class="fas fa-chevron-down text-xs"></i>
                        </button>
                        <div id="productionLotDropdownMenu" class="filter-dropdown__menu hidden" data-dropdown-menu>
                            <div class="max-h-48 overflow-y-auto">
                                {% for option in production_lot_filter_options %}
                                <label>
                                    <input type="checkbox"
                                           name="has_production_lot"
                                           value="{{ option.value }}"
                                           data-label="{{ option.label }}"
                                           {% if option.value in filters.has_production_lot %}checked{% endif %}>
                                    <span>{{ option.label }}</span>
                                </label>
                                {% endfor %}
                            </div>
                            <button type="button" class="filter-dropdown__clear" data-dropdown-clear>Limpar</button>
                        </div>
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-semibold text-gray-600 mb-2 uppercase tracking-wide">
                        Per&iacute;odo (Data do Pedido)
                    </label>
                    <div class="grid grid-cols-1 gap-3">
                        <input type="date"
                               name="start_date"
                               value="{{ filters.start_date }}"
                               class="filter-dropdown__toggle">
                        <input type="date"
                               name="end_date"
                               value="{{ filters.end_date }}"
                               class="filter-dropdown__toggle">
                    </div>
                </div>
            </div>
            <div class="flex justify-end gap-3 border-t border-gray-200 pt-4">
                <button type="button" id="closeFilterFooterBtn" class="btn-secondary px-4 py-2 rounded-lg">
                    Cancelar
                </button>
                <button type="submit" class="btn-primary px-4 py-2 rounded-lg">
                    Aplicar filtros
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const filterModal = document.getElementById('filterModal');
    const openModalBtn = document.getElementById('openFilterModalBtn');
    const closeModalBtn = document.getElementById('closeFilterModalBtn');
    const closeFooterBtn = document.getElementById('closeFilterFooterBtn');

    const openModal = () => filterModal.classList.remove('hidden');
    const closeModal = () => filterModal.classList.add('hidden');

    openModalBtn.addEventListener('click', openModal);
    closeModalBtn.addEventListener('click', closeModal);
    closeFooterBtn.addEventListener('click', closeModal);

    filterModal.addEventListener('click', (event) => {
        if (event.target === filterModal) {
            closeModal();
        }
    });

    let activeDropdownMenu = null;
    const dropdowns = document.querySelectorAll('[data-dropdown]');

    dropdowns.forEach((dropdown) => {
        const toggle = dropdown.querySelector('[data-dropdown-toggle]');
        const menuId = toggle ? toggle.getAttribute('data-target') : null;
        const menu = menuId ? document.getElementById(menuId) : null;
        const labelSpan = toggle ? toggle.querySelector('[data-dropdown-label]') : null;
        const defaultLabel = toggle ? (toggle.getAttribute('data-default-label') || 'Selecione') : 'Selecione';
        const checkboxes = menu ? Array.from(menu.querySelectorAll('input[type="checkbox"]')) : [];
        const clearButton = menu ? menu.querySelector('[data-dropdown-clear]') : null;

        if (!toggle || !menu || !labelSpan) {
            return;
        }

        const updateLabel = () => {
            const selected = checkboxes.filter((checkbox) => checkbox.checked);
            if (selected.length === 0) {
                labelSpan.textContent = defaultLabel;
            } else if (selected.length === 1) {
                labelSpan.textContent = selected[0].dataset.label || selected[0].value;
            } else {
                labelSpan.textContent = `${selected.length} selecionados`;
            }
        };

        toggle.addEventListener('click', (event) => {
            event.preventDefault();
            const isOpen = !menu.classList.contains('hidden');
            if (activeDropdownMenu && activeDropdownMenu !== menu) {
                activeDropdownMenu.classList.add('hidden');
            }
            if (isOpen) {
                menu.classList.add('hidden');
                activeDropdownMenu = null;
            } else {
                menu.classList.remove('hidden');
                activeDropdownMenu = menu;
            }
        });

        document.addEventListener('click', (event) => {
            if (!dropdown.contains(event.target) && activeDropdownMenu === menu) {
                menu.classList.add('hidden');
                activeDropdownMenu = null;
            }
        });

        checkboxes.forEach((checkbox) => {
            checkbox.addEventListener('change', updateLabel);
        });

        if (clearButton) {
            clearButton.addEventListener('click', (event) => {
                event.preventDefault();
                checkboxes.forEach((checkbox) => {
                    checkbox.checked = false;
                });
                updateLabel();
            });
        }

        updateLabel();
    });
});
</script>
{% endblock %}
