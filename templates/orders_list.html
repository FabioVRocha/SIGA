{% extends 'base.html' %}

{% block title %}SIGA - Lista de Pedidos{% endblock %}
{% block page_title %}Lista de Pedidos{% endblock %}

{% block content %}
<style>
  .list-section {
    background-color: var(--clr-card-bg);
    border-radius: 0.75rem;
    border: 1px solid var(--clr-border);
    box-shadow: 0 1px 3px rgba(15, 23, 42, 0.12);
    padding: 1.5rem;
  }
  @media (min-width: 1024px) {
    .list-section {
      padding: 2rem;
    }
  }
  .section-heading {
    font-size: 1.05rem;
    font-weight: 600;
    color: var(--clr-dark-blue);
  }
  .text-dark-blue {
    color: var(--clr-dark-blue);
  }
  .text-slate-muted {
    color: var(--clr-text-secondary);
  }
  .hover-row:hover {
    background-color: rgba(79, 131, 204, 0.12);
    transition: background-color 0.2s ease-in-out;
  }
  .filter-row th {
    background-color: var(--clr-light-gray);
    padding: 0.75rem 1rem;
    border-bottom: 1px solid var(--clr-border);
  }
  .filter-input {
    width: 100%;
    padding: 0.5rem 0.75rem;
    border: 1px solid var(--clr-border);
    border-radius: 0.5rem;
    font-size: 0.8rem;
    color: var(--clr-dark-blue);
    background-color: var(--clr-white);
    transition: border-color 0.2s ease, box-shadow 0.2s ease;
  }
  .filter-input::placeholder {
    color: var(--clr-text-secondary);
  }
  .filter-input:focus {
    border-color: var(--clr-light-blue);
    box-shadow: 0 0 0 3px rgba(79, 131, 204, 0.15);
    outline: none;
  }
</style>

<div class="space-y-6">
  <section class="list-section">
    <div class="flex flex-col gap-2 md:flex-row md:items-center md:justify-between mb-4">
      <div>
        <h2 class="section-heading">Lista de Pedidos</h2>
        <p class="text-xs text-slate-muted">Filtre os resultados diretamente na tabela.</p>
      </div>
      <span class="text-sm font-medium text-dark-blue">{{ orders|length }} {{ 'registro' if orders|length == 1 else 'registros' }}</span>
    </div>
    <div class="overflow-x-auto">
      <table id="ordersTable" class="min-w-full bg-white rounded-xl overflow-hidden">
        <thead>
          <tr class="table-header-bg text-left text-xs font-semibold uppercase tracking-wide">
            <th class="py-3 px-4">Pedido</th>
            <th class="py-3 px-4">Seq. Lote</th>
            <th class="py-3 px-4">CÃ³d. Cliente</th>
            <th class="py-3 px-4">Cliente</th>
            <th class="py-3 px-4">Cidade/UF</th>
            <th class="py-3 px-4 text-right">Quantidade</th>
            <th class="py-3 px-4 text-right">Reservado</th>
            <th class="py-3 px-4 text-right">Separado</th>
            <th class="py-3 px-4 text-right">Carregado</th>
            <th class="py-3 px-4">Linha</th>
          </tr>
          <tr class="filter-row text-xs uppercase tracking-wide">
            <th class="px-4"><input type="text" class="filter-input" placeholder="Filtrar..." data-column="0"></th>
            <th class="px-4"><input type="text" class="filter-input" placeholder="Filtrar..." data-column="1"></th>
            <th class="px-4"><input type="text" class="filter-input" placeholder="Filtrar..." data-column="2"></th>
            <th class="px-4"><input type="text" class="filter-input" placeholder="Filtrar..." data-column="3"></th>
            <th class="px-4"><input type="text" class="filter-input" placeholder="Filtrar..." data-column="4"></th>
            <th class="px-4"><input type="text" class="filter-input" placeholder="Filtrar..." data-column="5"></th>
            <th class="px-4"><input type="text" class="filter-input" placeholder="Filtrar..." data-column="6"></th>
            <th class="px-4"><input type="text" class="filter-input" placeholder="Filtrar..." data-column="7"></th>
            <th class="px-4"><input type="text" class="filter-input" placeholder="Filtrar..." data-column="8"></th>
            <th class="px-4"><input type="text" class="filter-input" placeholder="Filtrar..." data-column="9"></th>
          </tr>
        </thead>
        <tbody>
          {% for order in orders %}
          {% set row_bg = 'var(--clr-white)' if loop.index is odd else 'var(--clr-light-gray)' %}
          <tr class="hover-row text-sm text-dark-blue" style="background-color: {{ row_bg }};">
            <td class="py-3 px-4 align-top font-semibold" style="color: var(--clr-light-blue);">{{ order.pedido or 'N/A' }}</td>
            <td class="py-3 px-4 align-top">{{ order.sequencia_lote or 'N/A' }}</td>
            <td class="py-3 px-4 align-top">{{ order.cliente_codigo or 'N/A' }}</td>
            <td class="py-3 px-4 align-top">{{ order.cliente_nome or 'N/A' }}</td>
            <td class="py-3 px-4 align-top">{{ order.cidade_uf or 'N/A' }}</td>
            <td class="py-3 px-4 align-top text-right">{{ order.quantidade_total | format_decimal_br }}</td>
            <td class="py-3 px-4 align-top text-right">{{ order.reservado | format_decimal_br }}</td>
            <td class="py-3 px-4 align-top text-right">{{ order.separado | format_decimal_br }}</td>
            <td class="py-3 px-4 align-top text-right">{{ order.carregado | format_decimal_br }}</td>
            <td class="py-3 px-4 align-top">{{ order.linha or 'N/A' }}</td>
          </tr>
          {% else %}
          <tr>
            <td colspan="10" class="py-12 px-4 text-center text-sm text-slate-muted">
              <div class="flex flex-col items-center gap-3">
                <i class="fas fa-box-open text-2xl" style="color: var(--clr-medium-gray);"></i>
                <p class="font-semibold text-dark-blue">Nenhum pedido encontrado.</p>
                <p>Tente ajustar os filtros ou aguarde novos pedidos.</p>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% if orders %}
    <div class="bg-gray-100 p-4 rounded-lg mt-4 flex flex-wrap justify-center gap-2">
        <div class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-semibold">
            Quantidade Total: <span>{{ totals.quantidade_total | format_decimal_br }}</span>
        </div>
        <div class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-semibold">
            Reservado: <span>{{ totals.reservado | format_decimal_br }}</span>
        </div>
        <div class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-semibold">
            Separado: <span>{{ totals.separado | format_decimal_br }}</span>
        </div>
        <div class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-semibold">
            Carregado: <span>{{ totals.carregado | format_decimal_br }}</span>
        </div>
    </div>
    {% endif %}
  </section>
</div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script>
    (function () {
      const table = document.getElementById('ordersTable');
      if (!table) return;

      const filterInputs = Array.from(table.querySelectorAll('.filter-input'));
      const normalize = (value) => (value || '').toString().trim().toLowerCase();

      const filterTable = () => {
        const tbody = table.tBodies[0];
        if (!tbody) return;

        Array.from(tbody.rows).forEach((row) => {
          let isVisible = true;
          for (const input of filterInputs) {
            if (!isVisible) break;
            
            const colIndex = Number.parseInt(input.dataset.column, 10);
            if (Number.isNaN(colIndex)) continue;

            const cell = row.cells[colIndex];
            if (!cell) continue;

            const cellText = normalize(cell.textContent || cell.innerText);
            const value = normalize(input.value);

            if (value && !cellText.includes(value)) {
              isVisible = false;
            }
          }
          row.style.display = isVisible ? '' : 'none';
        });
      };

      filterInputs.forEach((input) => {
        const eventType = input.tagName === 'SELECT' ? 'change' : 'input';
        input.addEventListener(eventType, filterTable);
      });
    })();
  </script>
{% endblock %}