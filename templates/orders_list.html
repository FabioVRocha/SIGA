{% extends "base.html" %}

{% block title %}Lista de Pedidos{% endblock %}

{% block page_title %}Lista de Pedidos{% endblock %}



{% block content %}
<style>
    .list-section {
        background-color: var(--clr-card-bg);
        border-radius: 0.75rem;
        border: 1px solid var(--clr-border);
        box-shadow: 0 1px 3px rgba(15, 23, 42, 0.12);
        padding: 1.5rem;
    }
    @media (min-width: 1024px) {
        .list-section {
            padding: 2rem;
        }
    }
    .section-heading {
        font-size: 1.05rem;
        font-weight: 600;
        color: var(--clr-dark-blue);
    }
    .text-dark-blue {
        color: var(--clr-dark-blue);
    }
    .text-slate-muted {
        color: var(--clr-text-secondary);
    }
    .hover-row:hover {
        background-color: rgba(79, 131, 204, 0.12);
        transition: background-color 0.2s ease-in-out;
    }
    .sort-button {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        background: none;
        border: none;
        color: inherit;
        font: inherit;
        text-transform: inherit;
        width: 100%;
        padding: 0;
        cursor: pointer;
    }
    .sort-button:focus-visible {
        outline: 2px solid var(--clr-light-blue);
        outline-offset: 2px;
    }
    .sort-button.justify-end {
        justify-content: flex-end;
    }
    .sort-icon {
        font-size: 0.75rem;
        opacity: 0.5;
    }
    .sort-button.active .sort-icon {
        opacity: 1;
        color: var(--clr-light-blue);
    }
    .form-input, .filter-input {
        width: 100%;
        padding: 0.5rem 0.75rem;
        border: 1px solid var(--clr-border);
        border-radius: 0.5rem;
        font-size: 0.8rem;
        color: var(--clr-dark-blue);
        background-color: var(--clr-white);
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }
    .form-input::placeholder, .filter-input::placeholder {
        color: var(--clr-text-secondary);
    }
    .form-input:focus, .filter-input:focus {
        border-color: var(--clr-light-blue);
        box-shadow: 0 0 0 3px rgba(79, 131, 204, 0.15);
        outline: none;
    }
    .modal-content {
        background-color: var(--clr-card-bg);
        border: 1px solid var(--clr-border);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    #orderDetailModal .modal-content {
        width: 100%;
        max-width: 75rem;
        max-height: 90vh;
        overflow-y: auto;
    }
    #orderDetailModal .modal-footer {
        border-top: 1px solid var(--clr-border);
        padding-top: 1rem;
        margin-top: 1rem;
    }
    .status-kpi-red {
        color: #dc2626;
    }
    .status-kpi-yellow {
        color: #f59e0b;
    }
    .status-kpi-green {
        color: #16a34a;
    }
    .status-kpi-blue {
        color: #2563eb;
    }
    .status-legend {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 0.75rem;
        margin-top: 1rem;
        font-size: 0.75rem;
        color: var(--clr-dark-blue);
    }
    .status-legend-item {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.35rem 0.75rem;
        border-radius: 9999px;
        background-color: var(--clr-light-gray);
    }
    .status-legend-color {
        width: 0.75rem;
        height: 0.75rem;
        border-radius: 9999px;
    }
    .status-legend-color.red {
        background-color: #dc2626;
    }
    .status-legend-color.yellow {
        background-color: #f59e0b;
    }
    .status-legend-color.green {
        background-color: #16a34a;
    }
    .status-legend-color.blue {
        background-color: #2563eb;
    }
</style>

<div class="space-y-6">
    <section class="list-section">
        <div class="flex flex-col gap-2 md:flex-row md:items-center md:justify-between mb-4">
            <div>
                <h2 class="section-heading">Pedidos</h2>
                <p class="text-xs text-slate-muted">Total de {{ orders|length if orders else 0 }} registros encontrados.</p>
            </div>
            <div class="flex justify-end w-full md:w-auto">
                <button id="openFilterModalBtn" class="btn-primary flex items-center px-4 py-2 rounded-lg">
                    <i class="fas fa-filter mr-2"></i> Filtrar
                </button>
            </div>
        </div>

        <div class="overflow-x-auto">
            <form id="columnFilterForm" action="{{ url_for('orders_list') }}" method="GET" class="space-y-3">
                {% if filters.load_lot %}
                <input type="hidden" name="load_lot" value="{{ filters.load_lot }}">
                {% endif %}
                {% for lot in filters.load_lots or [] %}
                <input type="hidden" name="load_lots" value="{{ lot }}">
                {% endfor %}
                {% for lot in filters.production_lots or [] %}
                <input type="hidden" name="production_lots" value="{{ lot }}">
                {% endfor %}
                {% for selected_line in filters.lines or [] %}
                <input type="hidden" name="lines" value="{{ selected_line }}">
                {% endfor %}
                {% for status_code in filters.approval_statuses or [] %}
                <input type="hidden" name="approval_statuses" value="{{ status_code }}">
                {% endfor %}
                {% for situation_code in filters.situations or [] %}
                <input type="hidden" name="situations" value="{{ situation_code }}">
                {% endfor %}
                {% if filters.line %}
                <input type="hidden" name="line" value="{{ filters.line }}">
                {% endif %}
                {% if filters.start_date %}
                <input type="hidden" name="start_date" value="{{ filters.start_date }}">
                {% endif %}
                {% if filters.end_date %}
                <input type="hidden" name="end_date" value="{{ filters.end_date }}">
                {% endif %}
                <input type="hidden" name="sort_by" id="columnSortByInput" value="{{ sort_by }}">
                <input type="hidden" name="sort_order" id="columnSortOrderInput" value="{{ sort_order }}">

                <table class="min-w-full bg-white rounded-xl overflow-hidden">
                    <thead class="bg-gray-800 text-white" style="background-color: var(--clr-sidebar-bg);">
                        <tr class="text-xs font-medium uppercase tracking-wider">
                            <th scope="col" class="px-4 py-3 text-left rounded-tl-lg">
                                <button type="button" class="sort-button {% if sort_by == 'pedido' %}active{% endif %}" data-sort-column="pedido">
                                    <span>Pedido</span>
                                    <i class="fas {% if sort_by == 'pedido' %}{% if sort_order == 'asc' %}fa-sort-up{% else %}fa-sort-down{% endif %}{% else %}fa-sort{% endif %} sort-icon"></i>
                                </button>
                            </th>
                            <th scope="col" class="px-4 py-3 text-left">
                                <button type="button" class="sort-button {% if sort_by == 'lcaseque' %}active{% endif %}" data-sort-column="lcaseque">
                                    <span>Seq.</span>
                                    <i class="fas {% if sort_by == 'lcaseque' %}{% if sort_order == 'asc' %}fa-sort-up{% else %}fa-sort-down{% endif %}{% else %}fa-sort{% endif %} sort-icon"></i>
                                </button>
                            </th>
                            <th scope="col" class="px-4 py-3 text-left">
                                <button type="button" class="sort-button {% if sort_by == 'cliente_codigo' %}active{% endif %}" data-sort-column="cliente_codigo">
                                    <span>Código</span>
                                    <i class="fas {% if sort_by == 'cliente_codigo' %}{% if sort_order == 'asc' %}fa-sort-up{% else %}fa-sort-down{% endif %}{% else %}fa-sort{% endif %} sort-icon"></i>
                                </button>
                            </th>
                            <th scope="col" class="px-4 py-3 text-left">
                                <button type="button" class="sort-button {% if sort_by == 'cliente_nome' %}active{% endif %}" data-sort-column="cliente_nome">
                                    <span>Cliente</span>
                                    <i class="fas {% if sort_by == 'cliente_nome' %}{% if sort_order == 'asc' %}fa-sort-up{% else %}fa-sort-down{% endif %}{% else %}fa-sort{% endif %} sort-icon"></i>
                                </button>
                            </th>
                            <th scope="col" class="px-4 py-3 text-left">
                                <button type="button" class="sort-button {% if sort_by == 'cidade_uf' %}active{% endif %}" data-sort-column="cidade_uf">
                                    <span>Cidade/UF</span>
                                    <i class="fas {% if sort_by == 'cidade_uf' %}{% if sort_order == 'asc' %}fa-sort-up{% else %}fa-sort-down{% endif %}{% else %}fa-sort{% endif %} sort-icon"></i>
                                </button>
                            </th>
                            <th scope="col" class="px-4 py-3 text-right">
                                <button type="button" class="sort-button justify-end {% if sort_by == 'quantidade_total' %}active{% endif %}" data-sort-column="quantidade_total">
                                    <span>Quantidade</span>
                                    <i class="fas {% if sort_by == 'quantidade_total' %}{% if sort_order == 'asc' %}fa-sort-up{% else %}fa-sort-down{% endif %}{% else %}fa-sort{% endif %} sort-icon"></i>
                                </button>
                            </th>
                            <th scope="col" class="px-4 py-3 text-right">
                                <button type="button" class="sort-button justify-end {% if sort_by == 'reservado' %}active{% endif %}" data-sort-column="reservado">
                                    <span>Reservado</span>
                                    <i class="fas {% if sort_by == 'reservado' %}{% if sort_order == 'asc' %}fa-sort-up{% else %}fa-sort-down{% endif %}{% else %}fa-sort{% endif %} sort-icon"></i>
                                </button>
                            </th>
                            <th scope="col" class="px-4 py-3 text-right">
                                <button type="button" class="sort-button justify-end {% if sort_by == 'separado' %}active{% endif %}" data-sort-column="separado">
                                    <span>Separado</span>
                                    <i class="fas {% if sort_by == 'separado' %}{% if sort_order == 'asc' %}fa-sort-up{% else %}fa-sort-down{% endif %}{% else %}fa-sort{% endif %} sort-icon"></i>
                                </button>
                            </th>
                            <th scope="col" class="px-4 py-3 text-right">
                                <button type="button" class="sort-button justify-end {% if sort_by == 'carregado' %}active{% endif %}" data-sort-column="carregado">
                                    <span>Carregado</span>
                                    <i class="fas {% if sort_by == 'carregado' %}{% if sort_order == 'asc' %}fa-sort-up{% else %}fa-sort-down{% endif %}{% else %}fa-sort{% endif %} sort-icon"></i>
                                </button>
                            </th>
                            <th scope="col" class="px-4 py-3 text-left">
                                <button type="button" class="sort-button {% if sort_by == 'linha' %}active{% endif %}" data-sort-column="linha">
                                    <span>Linha</span>
                                    <i class="fas {% if sort_by == 'linha' %}{% if sort_order == 'asc' %}fa-sort-up{% else %}fa-sort-down{% endif %}{% else %}fa-sort{% endif %} sort-icon"></i>
                                </button>
                            </th>
                            <th scope="col" class="px-4 py-3 text-center rounded-tr-lg">
                                <span>Ações</span>
                            </th>
                        </tr>
                        <tr class="bg-slate-100 text-xs text-dark-blue">
                            <th scope="col" class="px-4 py-2">
                                <input type="text" name="filter_pedido" value="{{ filters.filter_pedido or '' }}" class="filter-input column-filter-input" placeholder="Pedido">
                            </th>
                            <th scope="col" class="px-4 py-2">
                                <input type="text" name="filter_seq_lote" value="{{ filters.filter_seq_lote or '' }}" class="filter-input column-filter-input" placeholder="Seq.">
                            </th>
                            <th scope="col" class="px-4 py-2">
                                <input type="text" name="filter_cliente_codigo" value="{{ filters.filter_cliente_codigo or '' }}" class="filter-input column-filter-input" placeholder="Código">
                            </th>
                            <th scope="col" class="px-4 py-2">
                                <input type="text" name="filter_cliente_nome" value="{{ filters.filter_cliente_nome or '' }}" class="filter-input column-filter-input" placeholder="Cliente">
                            </th>
                            <th scope="col" class="px-4 py-2">
                                <input type="text" name="filter_cidade_uf" value="{{ filters.filter_cidade_uf or '' }}" class="filter-input column-filter-input" placeholder="Cidade/UF">
                            </th>
                            <th scope="col" class="px-4 py-2">
                                <input type="text" name="filter_quantidade_total" value="{{ filters.filter_quantidade_total or '' }}" class="filter-input column-filter-input text-right" placeholder="Qtd.">
                            </th>
                            <th scope="col" class="px-4 py-2">
                                <input type="text" name="filter_reservado" value="{{ filters.filter_reservado or '' }}" class="filter-input column-filter-input text-right" placeholder="Reservado">
                            </th>
                            <th scope="col" class="px-4 py-2">
                                <input type="text" name="filter_separado" value="{{ filters.filter_separado or '' }}" class="filter-input column-filter-input text-right" placeholder="Separado">
                            </th>
                            <th scope="col" class="px-4 py-2">
                                <input type="text" name="filter_carregado" value="{{ filters.filter_carregado or '' }}" class="filter-input column-filter-input text-right" placeholder="Carregado">
                            </th>
                            <th scope="col" class="px-4 py-2">
                                <input type="text" name="filter_linha" value="{{ filters.filter_linha or '' }}" class="filter-input column-filter-input" placeholder="Linha">
                            </th>
                            <th scope="col" class="px-4 py-2 text-center">
                                <div class="flex items-center justify-center gap-3">
                                    <button type="submit" class="text-xs font-semibold text-blue-700 hover:underline">Aplicar</button>
                                    <button type="button" id="clearColumnFiltersBtn" class="text-xs text-red-600 hover:underline">Limpar</button>
                                </div>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if orders %}
                        {% for order in orders %}
                        {% set row_bg = 'var(--clr-white)' if loop.index is odd else 'var(--clr-light-gray)' %}
                        {% set kpi_status = order.kpi_status %}
                        {% set pedido_status_class = 'status-kpi-blue' if kpi_status == 3 else ('status-kpi-green' if kpi_status == 2 else ('status-kpi-yellow' if kpi_status == 1 else 'status-kpi-red')) %}
                        <tr class="hover-row text-sm text-dark-blue" data-order-row="true" style="background-color: {{ row_bg }};">
                            <td class="py-2 px-4 whitespace-nowrap font-semibold {{ pedido_status_class }}" data-column="filter_pedido">{{ order.pedido or 'N/A' }}</td>
                            <td class="py-2 px-4 whitespace-nowrap" data-column="filter_seq_lote">{{ order.lcaseque or 'N/A' }}</td>
                            <td class="py-2 px-4 whitespace-nowrap" data-column="filter_cliente_codigo">{{ order.cliente_codigo or 'N/A' }}</td>
                            <td class="py-2 px-4 whitespace-nowrap" data-column="filter_cliente_nome">{{ order.cliente_nome or 'N/A' }}</td>
                            <td class="py-2 px-4 whitespace-nowrap" data-column="filter_cidade_uf">{{ order.cidade_uf or 'N/A' }}</td>
                            <td class="py-2 px-4 whitespace-nowrap text-right" data-column="filter_quantidade_total">{{ order.quantidade_total | format_decimal_br }}</td>
                            <td class="py-2 px-4 whitespace-nowrap text-right" data-column="filter_reservado">{{ order.reservado | format_decimal_br }}</td>
                            <td class="py-2 px-4 whitespace-nowrap text-right" data-column="filter_separado">{{ order.separado | format_decimal_br }}</td>
                            <td class="py-2 px-4 whitespace-nowrap text-right" data-column="filter_carregado">{{ order.carregado | format_decimal_br }}</td>
                            <td class="py-2 px-4 whitespace-nowrap" data-column="filter_linha">{{ order.linha or 'N/A' }}</td>
                            <td class="py-2 px-4 whitespace-nowrap text-center">
                                <button
                                    type="button"
                                    class="icon-button order-detail-button"
                                    data-pedido="{{ order.pedido }}"
                                    aria-label="Visualizar detalhes do pedido {{ order.pedido }}"
                                    title="Visualizar detalhes"
                                >
                                    <i class="fas fa-eye text-blue-600 hover:text-blue-800"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                        <tr id="noLocalResultsRow" class="hidden">
                            <td colspan="11" class="py-6 px-4 text-center text-sm text-slate-muted">
                                Nenhum pedido coincide com os filtros digitados.
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="11" class="py-6 px-4 text-center text-sm text-slate-muted">
                                Nenhum pedido encontrado. Ajuste os filtros ou utilize os campos de busca acima.
                            </td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </form>
        </div>
        {% if orders %}
        {% set total_reservado = totals.reservado or 0 %}
        {% set total_separado = totals.separado or 0 %}
        {% set total_carregado = totals.carregado or 0 %}
        {% set percentual_separado = (total_separado / total_reservado * 100) if total_reservado else 0 %}
        {% set percentual_carregado = (total_carregado / total_separado * 100) if total_separado else 0 %}
        <div class="bg-gray-100 p-4 rounded-lg mt-4 flex flex-wrap justify-center gap-2">
            <div class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-semibold">
                Quantidade Total: <span>{{ totals.quantidade_total | format_decimal_br }}</span>
            </div>
            <div class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-semibold">
                Reservado: <span>{{ total_reservado | format_decimal_br }}</span>
            </div>
            <div class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-semibold">
                Separado: <span>{{ total_separado | format_decimal_br }}</span> <span>({{ percentual_separado | format_decimal_br(2) }}%)</span>
            </div>
            <div class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-semibold">
                Carregado: <span>{{ total_carregado | format_decimal_br }}</span> <span>({{ percentual_carregado | format_decimal_br(2) }}%)</span>
            </div>
        </div>
        <div class="status-legend">
            <div class="status-legend-item">
                <span class="status-legend-color red"></span>
                <span>Vermelho = Nada Separado</span>
            </div>
            <div class="status-legend-item">
                <span class="status-legend-color yellow"></span>
                <span>Amarelo = Parcialmente Separado</span>
            </div>
            <div class="status-legend-item">
                <span class="status-legend-color green"></span>
                <span>Verde = Totalmente Separado</span>
            </div>
            <div class="status-legend-item">
                <span class="status-legend-color blue"></span>
                <span>Azul = Totalmente Carregado</span>
            </div>
        </div>
        {% else %}
        <div class="text-center py-12 px-4 text-sm text-slate-muted">
            <div class="flex flex-col items-center gap-3">
                <i class="fas fa-file-invoice-dollar text-2xl" style="color: var(--clr-medium-gray);"></i>
                <p class="font-semibold text-dark-blue">Nenhum pedido encontrado.</p>
                <p>Use o botão "Filtrar" para ajustar sua busca.</p>
            </div>
        </div>
        {% endif %}

    </section>
</div>

<div
    id="orderDetailModal"
    class="modal"
    data-endpoint="{{ url_for('order_logistics_details', pedido='__PLACEHOLDER__') }}"
>
    <div class="modal-content order-detail-modal-content p-6 md:p-8 rounded-xl space-y-4">
        <div class="flex items-center justify-between">
            <h2 class="section-heading">Detalhes do Pedido</h2>
            <button id="closeOrderDetailModalBtn" class="close-button" aria-label="Fechar detalhes do pedido">&times;</button>
        </div>
        <div id="orderDetailLoading" class="py-6 text-center text-sm text-dark-blue hidden">
            <i class="fas fa-spinner fa-spin mr-2"></i> Carregando detalhes do pedido...
        </div>
        <div id="orderDetailError" class="py-6 text-center text-sm text-red-600 hidden"></div>
        <div id="orderDetailContent" class="space-y-4 hidden">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm text-dark-blue">
                <div><span class="font-semibold">Pedido:</span> <span id="orderDetailPedido">--</span></div>
                <div><span class="font-semibold">Cliente:</span> <span id="orderDetailCliente">--</span></div>
                <div><span class="font-semibold">Cidade:</span> <span id="orderDetailCidade">--</span></div>
                <div><span class="font-semibold">UF:</span> <span id="orderDetailUF">--</span></div>
                <div><span class="font-semibold">Data do Pedido:</span> <span id="orderDetailDataPedido">--</span></div>
                <div><span class="font-semibold">Status:</span> <span id="orderDetailStatus">--</span></div>
                <div><span class="font-semibold">Situação:</span> <span id="orderDetailSituacao">--</span></div>
                <div class="md:col-span-2"><span class="font-semibold">Lote de Produção:</span> <span id="orderDetailLoteProducao">--</span></div>
                <div class="md:col-span-2"><span class="font-semibold">Lote de Carga:</span> <span id="orderDetailLoteCarga">--</span></div>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white rounded-xl overflow-hidden">
                    <thead class="bg-gray-800 text-white" style="background-color: var(--clr-sidebar-bg);">
                        <tr class="text-xs font-medium uppercase tracking-wider">
                            <th scope="col" class="px-4 py-3 text-left">Código do Produto</th>
                            <th scope="col" class="px-4 py-3 text-left">Sequência</th>
                            <th scope="col" class="px-4 py-3 text-left">Produto</th>
                            <th scope="col" class="px-4 py-3 text-right">Reservado</th>
                            <th scope="col" class="px-4 py-3 text-right">Separado</th>
                            <th scope="col" class="px-4 py-3 text-right">Data Separação</th>
                            <th scope="col" class="px-4 py-3 text-right">Carregado</th>
                            <th scope="col" class="px-4 py-3 text-right">Data Embarque</th>
                        </tr>
                    </thead>
                    <tbody id="orderDetailTableBody" class="text-sm text-dark-blue"></tbody>
                </table>
            </div>
            <div id="orderDetailEmptyState" class="hidden text-sm text-center text-slate-muted">
                Nenhum item encontrado para este pedido.
            </div>
        </div>
        <div class="modal-footer">
            <div class="status-legend">
                <div class="status-legend-item">
                    <span class="status-legend-color red"></span>
                    <span>Vermelho = Nada Separado</span>
                </div>
                <div class="status-legend-item">
                    <span class="status-legend-color yellow"></span>
                    <span>Amarelo = Parcialmente Separado</span>
                </div>
                <div class="status-legend-item">
                    <span class="status-legend-color green"></span>
                    <span>Verde = Totalmente Separado</span>
                </div>
                <div class="status-legend-item">
                    <span class="status-legend-color blue"></span>
                    <span>Azul = Totalmente Carregado</span>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="filterModal" class="modal">
    <div class="modal-content">
        <div class="flex justify-between items-center mb-4">
            <h2 class="section-heading">Filtros de Pedidos</h2>
            <button id="closeFilterModalBtn" class="close-button">&times;</button>
        </div>
        <form id="filterForm" action="{{ url_for('orders_list') }}" method="GET" class="space-y-4">
            <div class="form-group">
                <label class="form-label">Lote de Carga:</label>
                <div id="loadLotDropdownContainer" class="relative">
                    <button type="button" id="loadLotDropdownToggle" class="form-input cursor-pointer flex items-center justify-between" aria-haspopup="listbox" aria-expanded="false">
                        <span id="loadLotDropdownLabel" class="text-left truncate">Selecione lotes de carga</span>
                        <i class="fas fa-chevron-down ml-2 text-gray-500"></i>
                    </button>
                    <div id="loadLotDropdown" class="hidden absolute z-20 mt-1 w-full bg-white border border-gray-300 rounded-lg shadow-lg p-3">
                        {% if load_lot_options %}
                        <input type="text" id="loadLotSearchInput" class="filter-input mb-3" placeholder="Pesquisar lote de carga">
                        {% endif %}
                        <div class="max-h-60 overflow-y-auto space-y-2">
                            {% if load_lot_options %}
                                {% for lot in load_lot_options %}
                                    {% set lot_display = lot.code %}
                                    {% if lot.description %}
                                        {% set lot_display = lot.code ~ ' - ' ~ lot.description %}
                                    {% endif %}
                                    <label class="flex items-center space-x-2 cursor-pointer dropdown-option load-lot-option">
                                        <input
                                            type="checkbox"
                                            class="load-lot-checkbox"
                                            name="load_lots"
                                            value="{{ lot.code }}"
                                            data-display="{{ lot_display }}"
                                            {% if lot.code in (filters.load_lots or []) %}checked{% endif %}
                                        >
                                        <span class="text-sm text-gray-700">{{ lot_display }}</span>
                                    </label>
                                {% endfor %}
                            {% else %}
                                <p class="text-sm text-gray-500">Nenhum lote de carga encontrado.</p>
                            {% endif %}
                        </div>
                        {% if load_lot_options %}
                        <p id="loadLotNoResults" class="hidden text-sm text-gray-500 text-center py-1">Nenhum lote de carga correspondente.</p>
                        {% endif %}
                        <div class="flex justify-end pt-2 mt-2 border-t border-gray-200">
                            <button type="button" id="loadLotClearBtn" class="text-sm text-red-600 hover:underline">Limpar selecao</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">Lote de Producao:</label>
                <div id="productionLotDropdownContainer" class="relative">
                    <button type="button" id="productionLotDropdownToggle" class="form-input cursor-pointer flex items-center justify-between" aria-haspopup="listbox" aria-expanded="false">
                        <span id="productionLotDropdownLabel" class="text-left truncate">Selecione lotes de producao</span>
                        <i class="fas fa-chevron-down ml-2 text-gray-500"></i>
                    </button>
                    <div id="productionLotDropdown" class="hidden absolute z-20 mt-1 w-full bg-white border border-gray-300 rounded-lg shadow-lg p-3">
                        {% if production_lot_options %}
                        <input type="text" id="productionLotSearchInput" class="filter-input mb-3" placeholder="Pesquisar lote de producao">
                        {% endif %}
                        <div class="max-h-60 overflow-y-auto space-y-2">
                            {% if production_lot_options %}
                                {% for lot in production_lot_options %}
                                    {% set lot_display = lot.code %}
                                    {% if lot.description %}
                                        {% set lot_display = lot.code ~ ' - ' ~ lot.description %}
                                    {% endif %}
                                    <label class="flex items-center space-x-2 cursor-pointer dropdown-option production-lot-option">
                                        <input
                                            type="checkbox"
                                            class="production-lot-checkbox"
                                            name="production_lots"
                                            value="{{ lot.code }}"
                                            data-display="{{ lot_display }}"
                                            {% if lot.code in filters.production_lots %}checked{% endif %}
                                        >
                                        <span class="text-sm text-gray-700">{{ lot_display }}</span>
                                    </label>
                                {% endfor %}
                            {% else %}
                                <p class="text-sm text-gray-500">Nenhum lote de producao encontrado.</p>
                            {% endif %}
                        </div>
                        {% if production_lot_options %}
                        <p id="productionLotNoResults" class="hidden text-sm text-gray-500 text-center py-1">Nenhum lote de producao correspondente.</p>
                        {% endif %}
                        <div class="flex justify-end pt-2 mt-2 border-t border-gray-200">
                            <button type="button" id="productionLotClearBtn" class="text-sm text-red-600 hover:underline">Limpar selecao</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">Linha:</label>
                <div id="lineDropdownContainer" class="relative">
                    <button type="button" id="lineDropdownToggle" class="form-input cursor-pointer flex items-center justify-between" aria-haspopup="listbox" aria-expanded="false">
                        <span id="lineDropdownLabel" class="text-left truncate">Selecione linhas</span>
                        <i class="fas fa-chevron-down ml-2 text-gray-500"></i>
                    </button>
                    <div id="lineDropdown" class="hidden absolute z-20 mt-1 w-full bg-white border border-gray-300 rounded-lg shadow-lg p-3">
                        <div class="max-h-60 overflow-y-auto space-y-2">
                            {% if product_line_options %}
                                {% for line in product_line_options %}
                                    <label class="flex items-center space-x-2 cursor-pointer">
                                        <input
                                            type="checkbox"
                                            class="line-checkbox"
                                            name="lines"
                                            value="{{ line }}"
                                            data-display="{{ line }}"
                                            {% if line in (filters.lines or []) %}checked{% endif %}
                                        >
                                        <span class="text-sm text-gray-700">{{ line }}</span>
                                    </label>
                                {% endfor %}
                            {% else %}
                                <p class="text-sm text-gray-500">Nenhuma linha disponível.</p>
                            {% endif %}
                        </div>
                        <div class="flex justify-end pt-2 mt-2 border-t border-gray-200">
                            <button type="button" id="lineClearBtn" class="text-sm text-red-600 hover:underline">Limpar selecao</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="form-group">
                    <label class="form-label">Status do Pedido:</label>
                    <div id="approvalStatusDropdownContainer" class="relative">
                        <button type="button" id="approvalStatusDropdownToggle" class="form-input cursor-pointer flex items-center justify-between" aria-haspopup="listbox" aria-expanded="false">
                            <span id="approvalStatusDropdownLabel" class="text-left truncate">Selecione status do pedido</span>
                            <i class="fas fa-chevron-down ml-2 text-gray-500"></i>
                        </button>
                        <div id="approvalStatusDropdown" class="hidden absolute z-20 mt-1 w-full bg-white border border-gray-300 rounded-lg shadow-lg p-3">
                            <div class="max-h-60 overflow-y-auto space-y-2">
                                {% if approval_status_options %}
                                    {% for status in approval_status_options %}
                                        <label class="flex items-center space-x-2 cursor-pointer">
                                            <input
                                                type="checkbox"
                                                class="approval-status-checkbox"
                                                name="approval_statuses"
                                                value="{{ status.code }}"
                                                data-display="{{ status.label }}"
                                                {% if status.code in (filters.approval_statuses or []) %}checked{% endif %}
                                            >
                                            <span class="text-sm text-gray-700">{{ status.label }}</span>
                                        </label>
                                    {% endfor %}
                                {% else %}
                                    <p class="text-sm text-gray-500">Nenhum status disponivel.</p>
                                {% endif %}
                            </div>
                            <div class="flex justify-end pt-2 mt-2 border-t border-gray-200">
                                <button type="button" id="approvalStatusClearBtn" class="text-sm text-red-600 hover:underline">Limpar selecao</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Situação:</label>
                    <div id="situationDropdownContainer" class="relative">
                        <button type="button" id="situationDropdownToggle" class="form-input cursor-pointer flex items-center justify-between" aria-haspopup="listbox" aria-expanded="false">
                            <span id="situationDropdownLabel" class="text-left truncate">Selecione situações</span>
                            <i class="fas fa-chevron-down ml-2 text-gray-500"></i>
                        </button>
                        <div id="situationDropdown" class="hidden absolute z-20 mt-1 w-full bg-white border border-gray-300 rounded-lg shadow-lg p-3">
                            <div class="max-h-60 overflow-y-auto space-y-2">
                                {% if situation_options %}
                                    {% for situation in situation_options %}
                                        <label class="flex items-center space-x-2 cursor-pointer">
                                            <input
                                                type="checkbox"
                                                class="situation-checkbox"
                                                name="situations"
                                                value="{{ situation.code }}"
                                                data-display="{{ situation.label }}"
                                                {% if situation.code in (filters.situations or []) %}checked{% endif %}
                                            >
                                            <span class="text-sm text-gray-700">{{ situation.label }}</span>
                                        </label>
                                    {% endfor %}
                                {% else %}
                                    <p class="text-sm text-gray-500">Nenhuma situação disponivel.</p>
                                {% endif %}
                            </div>
                            <div class="flex justify-end pt-2 mt-2 border-t border-gray-200">
                                <button type="button" id="situationClearBtn" class="text-sm text-red-600 hover:underline">Limpar selecao</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="form-group grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="start_date" class="form-label">Data do Pedido (início):</label>
                    <input type="date" id="start_date" name="start_date" class="form-input" value="{{ filters.start_date or '' }}">
                </div>
                <div>
                    <label for="end_date" class="form-label">Data do Pedido (fim):</label>
                    <input type="date" id="end_date" name="end_date" class="form-input" value="{{ filters.end_date or '' }}">
                </div>
            </div>
            <div class="flex justify-end space-x-4 mt-6">
                <button type="button" id="clearFiltersBtn" class="btn btn-secondary">Limpar Filtros</button>
                <button type="submit" class="btn btn-primary">Aplicar Filtros</button>
            </div>
            <input type="hidden" name="filter_pedido" class="modal-column-filter" value="{{ filters.filter_pedido or '' }}">
            <input type="hidden" name="filter_seq_lote" class="modal-column-filter" value="{{ filters.filter_seq_lote or '' }}">
            <input type="hidden" name="filter_cliente_codigo" class="modal-column-filter" value="{{ filters.filter_cliente_codigo or '' }}">
            <input type="hidden" name="filter_cliente_nome" class="modal-column-filter" value="{{ filters.filter_cliente_nome or '' }}">
            <input type="hidden" name="filter_cidade_uf" class="modal-column-filter" value="{{ filters.filter_cidade_uf or '' }}">
            <input type="hidden" name="filter_quantidade_total" class="modal-column-filter" value="{{ filters.filter_quantidade_total or '' }}">
            <input type="hidden" name="filter_reservado" class="modal-column-filter" value="{{ filters.filter_reservado or '' }}">
            <input type="hidden" name="filter_separado" class="modal-column-filter" value="{{ filters.filter_separado or '' }}">
            <input type="hidden" name="filter_carregado" class="modal-column-filter" value="{{ filters.filter_carregado or '' }}">
            <input type="hidden" name="filter_linha" class="modal-column-filter" value="{{ filters.filter_linha or '' }}">
            <input type="hidden" name="sort_by" id="sortByInput" value="{{ sort_by }}">
            <input type="hidden" name="sort_order" id="sortOrderInput" value="{{ sort_order }}">
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const filterModal = document.getElementById('filterModal');
    const openFilterModalBtn = document.getElementById('openFilterModalBtn');
    const closeFilterModalBtn = document.getElementById('closeFilterModalBtn');
    const clearFiltersBtn = document.getElementById('clearFiltersBtn');
    const filterForm = document.getElementById('filterForm');
    const columnFilterForm = document.getElementById('columnFilterForm');
    const columnFilterInputs = columnFilterForm ? columnFilterForm.querySelectorAll('.column-filter-input') : [];
    const modalColumnFilterInputs = filterForm ? filterForm.querySelectorAll('.modal-column-filter') : [];
    const clearColumnFiltersBtn = document.getElementById('clearColumnFiltersBtn');
    const sortByInputs = document.querySelectorAll('input[name="sort_by"]');
    const sortOrderInputs = document.querySelectorAll('input[name="sort_order"]');
    const sortableButtons = document.querySelectorAll('[data-sort-column]');
    const tableBody = columnFilterForm ? columnFilterForm.querySelector('tbody') : null;
    const orderRows = tableBody ? Array.from(tableBody.querySelectorAll('tr[data-order-row="true"]')) : [];
    const noLocalResultsRow = document.getElementById('noLocalResultsRow');
    const numericFilterNames = new Set([
        'filter_quantidade_total',
        'filter_reservado',
        'filter_separado',
        'filter_carregado',
    ]);
    const sortColumnToDataColumn = {
        pedido: 'filter_pedido',
        lcaseque: 'filter_seq_lote',
        cliente_codigo: 'filter_cliente_codigo',
        cliente_nome: 'filter_cliente_nome',
        cidade_uf: 'filter_cidade_uf',
        quantidade_total: 'filter_quantidade_total',
        reservado: 'filter_reservado',
        separado: 'filter_separado',
        carregado: 'filter_carregado',
        linha: 'filter_linha',
    };
    const numericSortColumns = new Set([
        'quantidade_total',
        'reservado',
        'separado',
        'carregado',
    ]);
    let currentSortBy = sortByInputs.length > 0 ? sortByInputs[0].value : '';
    let currentSortOrder = sortOrderInputs.length > 0 ? (sortOrderInputs[0].value || 'desc') : 'desc';
    if (currentSortOrder !== 'asc' && currentSortOrder !== 'desc') {
        currentSortOrder = 'asc';
    }

    const normalizeText = (value) => {
        if (!value) {
            return '';
        }
        return String(value)
            .normalize('NFD')
            .replace(/[\u0300-\u036f]/g, '')
            .toLowerCase();
    };

    const parseNumericValue = (value) => {
        if (!value) {
            return 0;
        }
        const normalized = value
            .toString()
            .replace(/\./g, '')
            .replace(/\s/g, '')
            .replace(',', '.')
            .replace(/[^\d.-]/g, '');
        const parsed = parseFloat(normalized);
        return Number.isNaN(parsed) ? 0 : parsed;
    };

    const textCollator = (typeof Intl !== 'undefined' && typeof Intl.Collator === 'function')
        ? new Intl.Collator('pt-BR', { numeric: true, sensitivity: 'base' })
        : null;

    const compareTextValues = (valueA, valueB) => {
        const normalizedA = normalizeText(valueA);
        const normalizedB = normalizeText(valueB);
        if (textCollator) {
            return textCollator.compare(normalizedA, normalizedB);
        }
        if (normalizedA < normalizedB) {
            return -1;
        }
        if (normalizedA > normalizedB) {
            return 1;
        }
        return 0;
    };

    const compareNumericValues = (valueA, valueB) => {
        const numericA = parseNumericValue(valueA);
        const numericB = parseNumericValue(valueB);
        if (numericA < numericB) {
            return -1;
        }
        if (numericA > numericB) {
            return 1;
        }
        return 0;
    };

    const getCellValueForColumn = (row, sortColumn) => {
        const dataColumn = sortColumnToDataColumn[sortColumn];
        if (!dataColumn) {
            return '';
        }
        const cell = row.querySelector(`[data-column="${dataColumn}"]`);
        return cell ? cell.textContent.trim() : '';
    };

    const sortTableRows = (column, order) => {
        if (!column || orderRows.length === 0 || !tableBody) {
            return;
        }

        const isNumericColumn = numericSortColumns.has(column);

        orderRows.sort((a, b) => {
            const rawValueA = getCellValueForColumn(a, column);
            const rawValueB = getCellValueForColumn(b, column);
            const comparison = isNumericColumn
                ? compareNumericValues(rawValueA, rawValueB)
                : compareTextValues(rawValueA, rawValueB);

            if (comparison === 0) {
                return 0;
            }
            return order === 'asc' ? comparison : -comparison;
        });

        orderRows.forEach((row) => {
            if (noLocalResultsRow) {
                tableBody.insertBefore(row, noLocalResultsRow);
            } else {
                tableBody.appendChild(row);
            }
        });
    };

    const updateSortIndicators = (activeColumn, order) => {
        sortableButtons.forEach((button) => {
            const column = button.dataset.sortColumn;
            const icon = button.querySelector('.sort-icon');
            const isActive = Boolean(activeColumn && column === activeColumn);

            button.classList.toggle('active', isActive);

            if (icon) {
                icon.classList.remove('fa-sort', 'fa-sort-up', 'fa-sort-down');
                if (!isActive) {
                    icon.classList.add('fa-sort');
                } else if (order === 'asc') {
                    icon.classList.add('fa-sort-up');
                } else {
                    icon.classList.add('fa-sort-down');
                }
            }
        });
    };

    const filterDropdownOptions = (config, searchTerm) => {
        if (!config || !config.options || config.options.length === 0) {
            if (config && config.noResultsMessage) {
                config.noResultsMessage.classList.add('hidden');
            }
            return;
        }

        const normalizedTerm = normalizeText(searchTerm);
        let visibleCount = 0;

        config.options.forEach((option) => {
            const checkbox = option.querySelector('input[type="checkbox"]');
            const displayValue = checkbox ? checkbox.dataset.display || checkbox.value : option.textContent;
            const normalizedDisplay = normalizeText(displayValue);
            if (normalizedTerm === '' || normalizedDisplay.includes(normalizedTerm)) {
                option.classList.remove('hidden');
                visibleCount += 1;
            } else {
                option.classList.add('hidden');
            }
        });

        if (config.noResultsMessage) {
            if (visibleCount === 0) {
                config.noResultsMessage.classList.remove('hidden');
            } else {
                config.noResultsMessage.classList.add('hidden');
            }
        }
    };

    const createDropdownConfig = ({
        containerId,
        dropdownId,
        toggleId,
        labelId,
        checkboxSelector,
        defaultLabel,
        clearBtnId,
        countLabel = 'itens',
        optionSelector,
        searchInputId,
        noResultsId,
    }) => {
        const container = document.getElementById(containerId);
        if (!container) {
            return null;
        }
        const dropdown = document.getElementById(dropdownId);
        const toggle = document.getElementById(toggleId);
        const label = document.getElementById(labelId);
        const clearBtn = clearBtnId ? document.getElementById(clearBtnId) : null;
        const checkboxes = Array.from(container.querySelectorAll(checkboxSelector));
        const options = optionSelector ? Array.from(container.querySelectorAll(optionSelector)) : [];
        const searchInput = searchInputId ? document.getElementById(searchInputId) : null;
        const noResultsMessage = noResultsId ? document.getElementById(noResultsId) : null;
        return {
            container,
            dropdown,
            toggle,
            label,
            clearBtn,
            checkboxes,
            defaultLabel,
            countLabel,
            options,
            searchInput,
            noResultsMessage,
        };
    };

    const dropdownConfigs = [
        createDropdownConfig({
            containerId: 'loadLotDropdownContainer',
            dropdownId: 'loadLotDropdown',
            toggleId: 'loadLotDropdownToggle',
            labelId: 'loadLotDropdownLabel',
            checkboxSelector: '.load-lot-checkbox',
            defaultLabel: 'Selecione lotes de carga',
            clearBtnId: 'loadLotClearBtn',
            countLabel: 'lotes',
            optionSelector: '.load-lot-option',
            searchInputId: 'loadLotSearchInput',
            noResultsId: 'loadLotNoResults',
        }),
        createDropdownConfig({
            containerId: 'productionLotDropdownContainer',
            dropdownId: 'productionLotDropdown',
            toggleId: 'productionLotDropdownToggle',
            labelId: 'productionLotDropdownLabel',
            checkboxSelector: '.production-lot-checkbox',
            defaultLabel: 'Selecione lotes de producao',
            clearBtnId: 'productionLotClearBtn',
            countLabel: 'lotes',
            optionSelector: '.production-lot-option',
            searchInputId: 'productionLotSearchInput',
            noResultsId: 'productionLotNoResults',
        }),
        createDropdownConfig({
            containerId: 'lineDropdownContainer',
            dropdownId: 'lineDropdown',
            toggleId: 'lineDropdownToggle',
            labelId: 'lineDropdownLabel',
            checkboxSelector: '.line-checkbox',
            defaultLabel: 'Selecione linhas',
            clearBtnId: 'lineClearBtn',
            countLabel: 'linhas',
        }),
        createDropdownConfig({
            containerId: 'approvalStatusDropdownContainer',
            dropdownId: 'approvalStatusDropdown',
            toggleId: 'approvalStatusDropdownToggle',
            labelId: 'approvalStatusDropdownLabel',
            checkboxSelector: '.approval-status-checkbox',
            defaultLabel: 'Selecione status do pedido',
            clearBtnId: 'approvalStatusClearBtn',
            countLabel: 'status',
        }),
        createDropdownConfig({
            containerId: 'situationDropdownContainer',
            dropdownId: 'situationDropdown',
            toggleId: 'situationDropdownToggle',
            labelId: 'situationDropdownLabel',
            checkboxSelector: '.situation-checkbox',
            defaultLabel: 'Selecione situações',
            clearBtnId: 'situationClearBtn',
            countLabel: 'situações',
        }),
    ].filter(Boolean);

    const closeDropdown = (config) => {
        if (config.dropdown) {
            config.dropdown.classList.add('hidden');
        }
        if (config.toggle) {
            config.toggle.setAttribute('aria-expanded', 'false');
        }
    };

    const openDropdown = (config) => {
        if (config.dropdown) {
            config.dropdown.classList.remove('hidden');
        }
        if (config.toggle) {
            config.toggle.setAttribute('aria-expanded', 'true');
        }
    };

    const updateDropdownLabel = (config) => {
        if (!config.label) {
            return;
        }
        const selected = config.checkboxes.filter((checkbox) => checkbox.checked);
        if (selected.length === 0) {
            config.label.textContent = config.defaultLabel;
        } else if (selected.length === 1) {
            config.label.textContent = selected[0].dataset.display || selected[0].value;
        } else {
            const countLabel = config.countLabel || 'itens';
            config.label.textContent = `${selected.length} ${countLabel} selecionados`;
        }
    };

    if (filterModal) {
        filterModal.style.display = 'none';
    }

    if (sortableButtons.length > 0) {
        sortableButtons.forEach((button) => {
            button.addEventListener('click', (event) => {
                event.preventDefault();
                const column = button.dataset.sortColumn;
                if (!column || !sortColumnToDataColumn[column]) {
                    return;
                }

                let nextOrder = 'asc';
                if (currentSortBy === column && currentSortOrder === 'asc') {
                    nextOrder = 'desc';
                }

                currentSortBy = column;
                currentSortOrder = nextOrder;

                sortByInputs.forEach((input) => {
                    input.value = column;
                });
                sortOrderInputs.forEach((input) => {
                    input.value = nextOrder;
                });

                sortTableRows(column, nextOrder);
                updateSortIndicators(column, nextOrder);
            });
        });
    }

    updateSortIndicators(currentSortBy, currentSortOrder);

    const normalizeFilterValue = (value, isNumeric = false) => {
        let normalized = normalizeText(value);
        if (isNumeric) {
            normalized = normalized.replace(/[^0-9]/g, '');
        }
        return normalized;
    };

    const applyLocalTableFilters = () => {
        if (orderRows.length === 0 || columnFilterInputs.length === 0) {
            return;
        }

        const activeFilters = {};

        columnFilterInputs.forEach((input) => {
            const isNumeric = numericFilterNames.has(input.name);
            const normalizedValue = normalizeFilterValue(input.value, isNumeric);
            if (normalizedValue !== '') {
                activeFilters[input.name] = normalizedValue;
            }
        });

        if (Object.keys(activeFilters).length === 0) {
            orderRows.forEach((row) => row.classList.remove('hidden'));
            if (noLocalResultsRow) {
                noLocalResultsRow.classList.add('hidden');
            }
            return;
        }

        let matchCount = 0;

        orderRows.forEach((row) => {
            const rowMatches = Object.entries(activeFilters).every(([filterName, filterValue]) => {
                const cell = row.querySelector(`[data-column="${filterName}"]`);
                const cellValue = normalizeFilterValue(
                    cell ? cell.textContent : '',
                    numericFilterNames.has(filterName),
                );
                return cellValue.includes(filterValue);
            });

            if (rowMatches) {
                row.classList.remove('hidden');
                matchCount += 1;
            } else {
                row.classList.add('hidden');
            }
        });

        if (noLocalResultsRow) {
            if (matchCount === 0) {
                noLocalResultsRow.classList.remove('hidden');
            } else {
                noLocalResultsRow.classList.add('hidden');
            }
        }
    };

    if (columnFilterInputs.length > 0) {
        columnFilterInputs.forEach((input) => {
            input.addEventListener('input', applyLocalTableFilters);
        });
        applyLocalTableFilters();
    }

    if (filterForm && columnFilterInputs.length > 0 && modalColumnFilterInputs.length > 0) {
        filterForm.addEventListener('submit', () => {
            const columnValues = {};
            columnFilterInputs.forEach((input) => {
                columnValues[input.name] = input.value;
            });
            modalColumnFilterInputs.forEach((hidden) => {
                if (Object.prototype.hasOwnProperty.call(columnValues, hidden.name)) {
                    hidden.value = columnValues[hidden.name] || '';
                }
            });
        });
    }

    if (clearColumnFiltersBtn) {
        clearColumnFiltersBtn.addEventListener('click', (event) => {
            event.preventDefault();
            columnFilterInputs.forEach((input) => {
                input.value = '';
            });
            modalColumnFilterInputs.forEach((hidden) => {
                hidden.value = '';
            });
            applyLocalTableFilters();
            if (columnFilterForm) {
                columnFilterForm.submit();
            } else {
                const url = new URL(window.location.href);
                columnFilterInputs.forEach((input) => {
                    url.searchParams.delete(input.name);
                });
                window.location.href = url.toString();
            }
        });
    }

    const openFilterModal = () => {
        if (filterModal) {
            filterModal.style.display = 'flex';
        }
    };

    const closeFilterModal = () => {
        if (filterModal) {
            filterModal.style.display = 'none';
        }
        dropdownConfigs.forEach((config) => closeDropdown(config));
    };

    if (openFilterModalBtn) {
        openFilterModalBtn.addEventListener('click', openFilterModal);
    }

    if (closeFilterModalBtn) {
        closeFilterModalBtn.addEventListener('click', closeFilterModal);
    }

    const detailModal = document.getElementById('orderDetailModal');
    const closeDetailModalBtn = document.getElementById('closeOrderDetailModalBtn');
    const orderDetailButtons = document.querySelectorAll('.order-detail-button');
    const detailLoading = document.getElementById('orderDetailLoading');
    const detailError = document.getElementById('orderDetailError');
    const detailContent = document.getElementById('orderDetailContent');
    const detailTableBody = document.getElementById('orderDetailTableBody');
    const detailEmptyState = document.getElementById('orderDetailEmptyState');
    const detailEndpointTemplate = detailModal ? detailModal.dataset.endpoint || '' : '';
    const detailFields = {
        pedido: document.getElementById('orderDetailPedido'),
        cliente: document.getElementById('orderDetailCliente'),
        cidade: document.getElementById('orderDetailCidade'),
        uf: document.getElementById('orderDetailUF'),
        dataPedido: document.getElementById('orderDetailDataPedido'),
        status: document.getElementById('orderDetailStatus'),
        situacao: document.getElementById('orderDetailSituacao'),
        loteProducao: document.getElementById('orderDetailLoteProducao'),
        loteCarga: document.getElementById('orderDetailLoteCarga'),
    };

    const safeText = (value, fallback = 'N/A') => {
        if (value === null || value === undefined) {
            return fallback;
        }
        const trimmed = String(value).trim();
        return trimmed === '' ? fallback : trimmed;
    };

    const setFieldText = (element, value) => {
        if (!element) {
            return;
        }
        element.textContent = safeText(value);
    };

    const setFieldRawText = (element, value) => {
        if (!element) {
            return;
        }
        if (value === null || value === undefined) {
            element.textContent = '';
            return;
        }
        element.textContent = String(value);
    };

    const setFieldList = (element, value) => {
        if (!element) {
            return;
        }
        element.textContent = '';
        const values = Array.isArray(value)
            ? value
            : String(value || '')
                  .split(';')
                  .map((item) => item.trim())
                  .filter((item) => item.length > 0);
        if (values.length === 0) {
            element.textContent = 'N/A';
            return;
        }
        values.forEach((item, index) => {
            if (index > 0) {
                element.appendChild(document.createElement('br'));
            }
            element.appendChild(document.createTextNode(item));
        });
    };

    const numberFormatter = new Intl.NumberFormat('pt-BR', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2,
    });

    const formatNumber = (value) => {
        const numericValue = Number(value);
        if (Number.isNaN(numericValue)) {
            return numberFormatter.format(0);
        }
        return numberFormatter.format(numericValue);
    };

    const getStatusClass = (status) => {
        if (status === null || status === undefined) {
            return 'status-kpi-red';
        }
        const mapping = {
            0: 'status-kpi-red',
            1: 'status-kpi-yellow',
            2: 'status-kpi-green',
            3: 'status-kpi-blue',
        };
        return mapping[status] || 'status-kpi-red';
    };

    const resetDetailFields = () => {
        Object.values(detailFields).forEach((element) => {
            if (element) {
                element.textContent = '--';
            }
        });
        if (detailTableBody) {
            detailTableBody.innerHTML = '';
        }
        if (detailEmptyState) {
            detailEmptyState.classList.add('hidden');
        }
    };

    const showDetailLoading = () => {
        if (detailLoading) {
            detailLoading.classList.remove('hidden');
        }
        if (detailError) {
            detailError.classList.add('hidden');
        }
        if (detailContent) {
            detailContent.classList.add('hidden');
        }
    };

    const showDetailContent = () => {
        if (detailContent) {
            detailContent.classList.remove('hidden');
        }
        if (detailLoading) {
            detailLoading.classList.add('hidden');
        }
        if (detailError) {
            detailError.classList.add('hidden');
        }
    };

    const showDetailError = (message) => {
        if (detailError) {
            detailError.textContent = message || 'Não foi possível carregar os detalhes do pedido.';
            detailError.classList.remove('hidden');
        }
        if (detailLoading) {
            detailLoading.classList.add('hidden');
        }
        if (detailContent) {
            detailContent.classList.add('hidden');
        }
        if (detailEmptyState) {
            detailEmptyState.classList.add('hidden');
        }
    };

    const renderItems = (items) => {
        if (!detailTableBody) {
            return;
        }
        detailTableBody.innerHTML = '';
        if (!Array.isArray(items) || items.length === 0) {
            if (detailEmptyState) {
                detailEmptyState.classList.remove('hidden');
            }
            return;
        }
        if (detailEmptyState) {
            detailEmptyState.classList.add('hidden');
        }
        items.forEach((item) => {
            const row = document.createElement('tr');
            row.className = 'hover-row text-sm text-dark-blue';

            const codeCell = document.createElement('td');
            codeCell.className = `py-3 px-4 whitespace-nowrap font-semibold ${getStatusClass(item.kpi_status)}`;
            codeCell.textContent = safeText(item.codigo_produto);

            const sequenceCell = document.createElement('td');
            sequenceCell.className = 'py-3 px-4 whitespace-nowrap';
            sequenceCell.textContent = safeText(item.sequencia);

            const productCell = document.createElement('td');
            productCell.className = 'py-3 px-4 whitespace-nowrap';
            productCell.textContent = safeText(item.produto);

            const reservadoCell = document.createElement('td');
            reservadoCell.className = 'py-3 px-4 whitespace-nowrap text-right';
            reservadoCell.textContent = formatNumber(item.reservado);

            const separadoCell = document.createElement('td');
            separadoCell.className = 'py-3 px-4 whitespace-nowrap text-right';
            separadoCell.textContent = formatNumber(item.separado);

            const dataSeparadoCell = document.createElement('td');
            dataSeparadoCell.className = 'py-3 px-4 whitespace-nowrap text-right';
            dataSeparadoCell.textContent = safeText(item.data_separacao);

            const carregadoCell = document.createElement('td');
            carregadoCell.className = 'py-3 px-4 whitespace-nowrap text-right';
            carregadoCell.textContent = formatNumber(item.carregado);

            const dataCarregadoCell = document.createElement('td');
            dataCarregadoCell.className = 'py-3 px-4 whitespace-nowrap text-right';
            dataCarregadoCell.textContent = safeText(item.data_embarque);

            row.appendChild(codeCell);
            row.appendChild(sequenceCell);
            row.appendChild(productCell);
            row.appendChild(reservadoCell);
            row.appendChild(separadoCell);
            row.appendChild(dataSeparadoCell);
            row.appendChild(carregadoCell);
            row.appendChild(dataCarregadoCell);

            detailTableBody.appendChild(row);
        });
    };

    const populateDetailModal = (data) => {
        if (!data) {
            showDetailError('Não foi possível carregar os detalhes do pedido.');
            return;
        }
        const header = data.header || {};
        setFieldText(detailFields.pedido, header.pedido);
        setFieldText(detailFields.cliente, header.cliente);
        setFieldText(detailFields.cidade, header.cidade);
        setFieldText(detailFields.uf, header.uf);
        setFieldText(detailFields.dataPedido, header.data_pedido);
        setFieldRawText(detailFields.status, header.status);
        setFieldRawText(detailFields.situacao, header.situacao);
        setFieldList(detailFields.loteProducao, header.lote_producao);
        setFieldText(detailFields.loteCarga, header.lote_carga);
        renderItems(Array.isArray(data.items) ? data.items : []);
        showDetailContent();
    };

    const getDetailUrl = (pedido) => {
        if (!detailEndpointTemplate || !pedido) {
            return '';
        }
        return detailEndpointTemplate.replace('__PLACEHOLDER__', encodeURIComponent(pedido));
    };

    const openDetailModal = () => {
        if (detailModal) {
            detailModal.style.display = 'flex';
        }
    };

    const closeDetailModal = () => {
        if (detailModal) {
            detailModal.style.display = 'none';
        }
        resetDetailFields();
        if (detailLoading) {
            detailLoading.classList.add('hidden');
        }
        if (detailError) {
            detailError.classList.add('hidden');
        }
        if (detailContent) {
            detailContent.classList.add('hidden');
        }
    };

    if (closeDetailModalBtn) {
        closeDetailModalBtn.addEventListener('click', closeDetailModal);
    }

    if (detailModal && orderDetailButtons.length > 0) {
        orderDetailButtons.forEach((button) => {
            button.addEventListener('click', async () => {
                const pedido = button.dataset.pedido;
                if (!pedido) {
                    return;
                }
                openDetailModal();
                resetDetailFields();
                showDetailLoading();
                const detailUrl = getDetailUrl(pedido);
                if (!detailUrl) {
                    showDetailError('Endpoint de detalhes não configurado.');
                    return;
                }
                try {
                    const response = await fetch(detailUrl, {
                        headers: {
                            Accept: 'application/json',
                        },
                    });
                    let payload = null;
                    try {
                        payload = await response.json();
                    } catch (parseError) {
                        console.error('Erro ao interpretar a resposta dos detalhes do pedido:', parseError);
                    }
                    if (!response.ok || !payload) {
                        const message = payload && payload.error
                            ? payload.error
                            : 'Não foi possível carregar os detalhes do pedido.';
                        showDetailError(message);
                        return;
                    }
                    populateDetailModal(payload);
                } catch (fetchError) {
                    console.error('Erro ao buscar detalhes do pedido:', fetchError);
                    showDetailError('Não foi possível carregar os detalhes do pedido.');
                }
            });
        });
    }

    window.addEventListener('click', (event) => {
        if (filterModal && event.target === filterModal) {
            closeFilterModal();
        }
        if (detailModal && event.target === detailModal) {
            closeDetailModal();
        }
        dropdownConfigs.forEach((config) => {
            if (config.container && !config.container.contains(event.target)) {
                closeDropdown(config);
            }
        });
    });

    if (clearFiltersBtn) {
        clearFiltersBtn.addEventListener('click', () => {
            window.location = "{{ url_for('orders_list') }}";
        });
    }

    dropdownConfigs.forEach((config) => {
        if (config.toggle && config.dropdown) {
            config.toggle.addEventListener('click', (event) => {
                event.stopPropagation();
                const isHidden = config.dropdown.classList.contains('hidden');
                if (isHidden) {
                    dropdownConfigs.forEach((otherConfig) => {
                        if (otherConfig !== config) {
                            closeDropdown(otherConfig);
                        }
                    });
                    openDropdown(config);
                    if (config.searchInput) {
                        filterDropdownOptions(config, config.searchInput.value || '');
                        config.searchInput.focus();
                    }
                } else {
                    closeDropdown(config);
                }
            });
        }

        if (config.dropdown) {
            config.dropdown.addEventListener('click', (event) => {
                event.stopPropagation();
            });
        }

        if (config.searchInput) {
            config.searchInput.addEventListener('input', (event) => {
                filterDropdownOptions(config, event.target.value);
            });
            filterDropdownOptions(config, config.searchInput.value || '');
        } else if (config.noResultsMessage) {
            config.noResultsMessage.classList.add('hidden');
        }

        if (config.checkboxes.length > 0) {
            config.checkboxes.forEach((checkbox) => {
                checkbox.addEventListener('change', () => updateDropdownLabel(config));
            });
            updateDropdownLabel(config);
        } else if (config.label) {
            config.label.textContent = config.defaultLabel;
        }

        if (config.clearBtn) {
            config.clearBtn.addEventListener('click', (event) => {
                event.preventDefault();
                config.checkboxes.forEach((checkbox) => {
                    checkbox.checked = false;
                });
                if (config.searchInput) {
                    config.searchInput.value = '';
                    filterDropdownOptions(config, '');
                }
                updateDropdownLabel(config);
                closeDropdown(config);
            });
        }
    });

    if (filterForm) {
        filterForm.addEventListener('submit', () => {
            closeFilterModal();
        });
    }

    document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape') {
            if (filterModal && filterModal.style.display === 'flex') {
                closeFilterModal();
            }
            if (detailModal && detailModal.style.display === 'flex') {
                closeDetailModal();
            }
        }
    });
});
</script>
{% endblock %}
