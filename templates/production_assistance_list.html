{% extends "base.html" %}

{% block title %}{{ page_title or 'Consultar Assistências' }}{% endblock %}

{% block page_title %}{{ page_title or 'Consultar Assistências' }}{% endblock %}

{% block content %}
<style>
    .list-section {
        background-color: var(--clr-card-bg);
        border-radius: 0.75rem;
        border: 1px solid var(--clr-border);
        box-shadow: 0 1px 3px rgba(15, 23, 42, 0.12);
        padding: 1.5rem;
    }
    @media (min-width: 1024px) {
        .list-section {
            padding: 2rem;
        }
    }
    .section-heading {
        font-size: 1.05rem;
        font-weight: 600;
        color: var(--clr-dark-blue);
    }
    .text-dark-blue {
        color: var(--clr-dark-blue);
    }
    .text-slate-muted {
        color: var(--clr-text-secondary);
    }
    .hover-row:hover {
        background-color: rgba(79, 131, 204, 0.12);
        transition: background-color 0.2s ease-in-out;
    }
    .sort-button {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        background: none;
        border: none;
        color: inherit;
        font: inherit;
        text-transform: inherit;
        width: 100%;
        padding: 0;
        cursor: pointer;
    }
    .sort-button:focus-visible {
        outline: 2px solid var(--clr-light-blue);
        outline-offset: 2px;
    }
    .sort-button.justify-end {
        justify-content: flex-end;
    }
    .sort-icon {
        font-size: 0.75rem;
        opacity: 0.5;
    }
    .sort-button.active .sort-icon {
        opacity: 1;
        color: var(--clr-light-blue);
    }
    .form-input, .filter-input {
        width: 100%;
        padding: 0.5rem 0.75rem;
        border: 1px solid var(--clr-border);
        border-radius: 0.5rem;
        font-size: 0.8rem;
        color: var(--clr-dark-blue);
        background-color: var(--clr-white);
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }
    .form-input::placeholder, .filter-input::placeholder {
        color: var(--clr-text-secondary);
    }
    .form-input:focus, .filter-input:focus {
        border-color: var(--clr-light-blue);
        box-shadow: 0 0 0 3px rgba(79, 131, 204, 0.15);
        outline: none;
    }
    .checkbox-multi-select {
        position: relative;
    }
    .checkbox-multi-select__trigger {
        width: 100%;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 0.5rem;
        background-color: var(--clr-white);
        border: 1px solid var(--clr-border);
        border-radius: 0.5rem;
        padding: 0.5rem 0.75rem;
        font-size: 0.8rem;
        color: var(--clr-dark-blue);
        cursor: pointer;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }
    .checkbox-multi-select__trigger:focus-visible {
        border-color: var(--clr-light-blue);
        box-shadow: 0 0 0 3px rgba(79, 131, 204, 0.15);
        outline: none;
    }
    .checkbox-multi-select__trigger-label {
        flex: 1;
        text-align: left;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .checkbox-multi-select__dropdown {
        display: none;
        position: absolute;
        top: calc(100% + 0.25rem);
        left: 0;
        right: 0;
        z-index: 20;
        background-color: var(--clr-card-bg);
        border: 1px solid var(--clr-border);
        border-radius: 0.75rem;
        box-shadow: 0 6px 20px rgba(15, 23, 42, 0.15);
        padding: 0.75rem;
    }
    .checkbox-multi-select__search-input {
        font-size: 0.8rem;
    }
    .checkbox-multi-select.is-open .checkbox-multi-select__dropdown {
        display: block;
    }
    .checkbox-multi-select__options {
        max-height: 14rem;
        overflow-y: auto;
        margin-top: 0.75rem;
        border: 1px solid var(--clr-border);
        border-radius: 0.5rem;
        padding: 0.5rem;
        background-color: var(--clr-white);
    }
    .checkbox-multi-select__option {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.35rem 0.25rem;
        border-radius: 0.35rem;
        cursor: pointer;
    }
    .checkbox-multi-select__option input {
        accent-color: var(--clr-light-blue);
    }
    .checkbox-multi-select__option:hover {
        background-color: rgba(79, 131, 204, 0.08);
    }
    .checkbox-multi-select__option-label {
        font-size: 0.8rem;
        color: var(--clr-dark-blue);
    }
    .checkbox-multi-select__empty-message {
        font-size: 0.75rem;
        color: var(--clr-text-secondary);
        margin-top: 0.5rem;
    }
    .checkbox-multi-select__chevron {
        font-size: 0.75rem;
        color: var(--clr-text-secondary);
    }
    .modal-content {
        background-color: var(--clr-card-bg);
        border: 1px solid var(--clr-border);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    #assistanceDetailModal .modal-content {
        width: 100%;
        max-width: 80rem;
        max-height: 90vh;
        overflow-y: auto;
    }
    .summary-footer {
        margin-top: 1.5rem;
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        justify-content: center;
        background-color: rgba(148, 163, 184, 0.12);
        border: 1px solid var(--clr-border);
        border-radius: 0.75rem;
        padding: 1.25rem 1.5rem;
    }
    @media (min-width: 768px) {
        .summary-footer {
            justify-content: flex-start;
        }
    }
    .summary-card {
        display: flex;
        flex-direction: column;
        gap: 0.35rem;
        min-width: 12rem;
        padding: 1rem 1.25rem;
        border-radius: 0.75rem;
        border: 1px solid rgba(148, 163, 184, 0.4);
        background-color: rgba(148, 163, 184, 0.12);
        box-shadow: 0 1px 2px rgba(15, 23, 42, 0.08);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .summary-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 16px rgba(15, 23, 42, 0.12);
    }
    .summary-label {
        font-size: 0.7rem;
        font-weight: 600;
        letter-spacing: 0.05em;
        text-transform: uppercase;
        color: rgba(15, 23, 42, 0.65);
    }
    .summary-value {
        font-size: 1.2rem;
        font-weight: 700;
        color: var(--clr-dark-blue);
    }
    .summary-card--blue {
        background-color: rgba(59, 130, 246, 0.12);
        border-color: rgba(59, 130, 246, 0.35);
    }
    .summary-card--blue .summary-label,
    .summary-card--blue .summary-value {
        color: #1d4ed8;
    }
    .summary-card--green {
        background-color: rgba(74, 222, 128, 0.16);
        border-color: rgba(74, 222, 128, 0.35);
    }
    .summary-card--green .summary-label,
    .summary-card--green .summary-value {
        color: #15803d;
    }
    .summary-card--amber {
        background-color: rgba(251, 191, 36, 0.18);
        border-color: rgba(251, 191, 36, 0.35);
    }
    .summary-card--amber .summary-label,
    .summary-card--amber .summary-value {
        color: #b45309;
    }
    .status-kpi-red {
        color: #dc2626;
    }
    .status-kpi-yellow {
        color: #f59e0b;
    }
    .status-kpi-green {
        color: #16a34a;
    }
    .status-kpi-blue {
        color: #2563eb;
    }
    .status-legend {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 0.75rem;
        margin-top: 1rem;
        font-size: 0.75rem;
        color: var(--clr-dark-blue);
    }
    .status-legend-item {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.35rem 0.75rem;
        border-radius: 9999px;
        background-color: var(--clr-light-gray);
    }
    .status-legend-color {
        width: 0.75rem;
        height: 0.75rem;
        border-radius: 9999px;
    }
    .status-legend-color.red {
        background-color: #dc2626;
    }
    .status-legend-color.yellow {
        background-color: #f59e0b;
    }
    .status-legend-color.green {
        background-color: #16a34a;
    }
    .status-legend-color.blue {
        background-color: #2563eb;
    }
</style>

{% set list_url = (list_url | default(url_for('production_assistance_list'))) %}
{% set list_heading = (list_heading | default(page_title | default('Consultar Assistências'))) %}

<div class="space-y-6">
    <section class="list-section">
        <div class="flex flex-col gap-2 md:flex-row md:items-center md:justify-between mb-4">
            <div>
                <h2 class="section-heading">{{ list_heading }}</h2>
                <p class="text-xs text-slate-muted">Total de <span id="visibleRecordsCount" data-total="{{ assistance_records|length if assistance_records else 0 }}">{{ assistance_records|length if assistance_records else 0 }}</span> registros encontrados.</p>
            </div>
            <div class="flex justify-end w-full md:w-auto">
                <button id="openFilterModalBtn" class="btn-primary flex items-center px-4 py-2 rounded-lg">
                    <i class="fas fa-filter mr-2"></i> Filtrar
                </button>
            </div>
        </div>

        <div class="overflow-x-auto">
            <form id="columnFilterForm" action="{{ list_url }}" method="GET" class="space-y-3">
                <!-- Hidden inputs for existing filters from modal -->
                <input type="hidden" name="sort_by" id="columnSortByInput" value="{{ sort_by }}">
                <input type="hidden" name="sort_order" id="columnSortOrderInput" value="{{ sort_order }}">
                {% if filters.start_date %}<input type="hidden" name="start_date" value="{{ filters.start_date }}">{% endif %}
                {% if filters.end_date %}<input type="hidden" name="end_date" value="{{ filters.end_date }}">{% endif %}
                {% for status in filters.statuses or [] %}<input type="hidden" name="statuses" value="{{ status }}">{% endfor %}
                {% for situation in filters.situations or [] %}<input type="hidden" name="situations" value="{{ situation }}">{% endfor %}
                {% for load_lot in filters.load_lots or [] %}<input type="hidden" name="load_lots" value="{{ load_lot }}">{% endfor %}
                {% for production_lot in filters.production_lots or [] %}<input type="hidden" name="production_lots" value="{{ production_lot }}">{% endfor %}
                {% for line in filters.lines or [] %}<input type="hidden" name="lines" value="{{ line }}">{% endfor %}
                <div class="flex justify-end mb-4">
                    <button type="button" id="clearColumnFiltersBtn" class="text-xs text-red-600 hover:underline">Limpar filtros</button>
                </div>

                <table class="min-w-full bg-white rounded-xl overflow-hidden">
                    <thead class="bg-gray-800 text-white" style="background-color: var(--clr-sidebar-bg);">
                        <tr class="text-xs font-medium uppercase tracking-wider">
                            <th scope="col" class="px-4 py-3 text-left rounded-tl-lg"><button type="button" class="sort-button {% if sort_by == 'assistec' %}active{% endif %}" data-sort-column="assistec"><span>Chamado</span><i class="fas {% if sort_by == 'assistec' %}{% if sort_order == 'asc' %}fa-sort-up{% else %}fa-sort-down{% endif %}{% else %}fa-sort{% endif %} sort-icon"></i></button></th>
                            <th scope="col" class="px-4 py-3 text-left"><button type="button" class="sort-button {% if sort_by == 'assdata' %}active{% endif %}" data-sort-column="assdata"><span>Data</span><i class="fas {% if sort_by == 'assdata' %}{% if sort_order == 'asc' %}fa-sort-up{% else %}fa-sort-down{% endif %}{% else %}fa-sort{% endif %} sort-icon"></i></button></th>
                            <th scope="col" class="px-4 py-3 text-left"><button type="button" class="sort-button {% if sort_by == 'cliente_nome' %}active{% endif %}" data-sort-column="cliente_nome"><span>Cliente</span><i class="fas {% if sort_by == 'cliente_nome' %}{% if sort_order == 'asc' %}fa-sort-up{% else %}fa-sort-down{% endif %}{% else %}fa-sort{% endif %} sort-icon"></i></button></th>
                            <th scope="col" class="px-4 py-3 text-left"><button type="button" class="sort-button {% if sort_by == 'cidade_estado' %}active{% endif %}" data-sort-column="cidade_estado"><span>Cidade/UF</span><i class="fas {% if sort_by == 'cidade_estado' %}{% if sort_order == 'asc' %}fa-sort-up{% else %}fa-sort-down{% endif %}{% else %}fa-sort{% endif %} sort-icon"></i></button></th>
                            <th scope="col" class="px-4 py-3 text-right"><button type="button" class="sort-button justify-end {% if sort_by == 'quantidade_pecas' %}active{% endif %}" data-sort-column="quantidade_pecas"><span>Peças</span><i class="fas {% if sort_by == 'quantidade_pecas' %}{% if sort_order == 'asc' %}fa-sort-up{% else %}fa-sort-down{% endif %}{% else %}fa-sort{% endif %} sort-icon"></i></button></th>
                            <th scope="col" class="px-4 py-3 text-right"><button type="button" class="sort-button justify-end {% if sort_by == 'reservado' %}active{% endif %}" data-sort-column="reservado"><span>Reservado</span><i class="fas {% if sort_by == 'reservado' %}{% if sort_order == 'asc' %}fa-sort-up{% else %}fa-sort-down{% endif %}{% else %}fa-sort{% endif %} sort-icon"></i></button></th>
                            <th scope="col" class="px-4 py-3 text-right"><button type="button" class="sort-button justify-end {% if sort_by == 'separado' %}active{% endif %}" data-sort-column="separado"><span>Separado</span><i class="fas {% if sort_by == 'separado' %}{% if sort_order == 'asc' %}fa-sort-up{% else %}fa-sort-down{% endif %}{% else %}fa-sort{% endif %} sort-icon"></i></button></th>
                            <th scope="col" class="px-4 py-3 text-right"><button type="button" class="sort-button justify-end {% if sort_by == 'carregado' %}active{% endif %}" data-sort-column="carregado"><span>Carregado</span><i class="fas {% if sort_by == 'carregado' %}{% if sort_order == 'asc' %}fa-sort-up{% else %}fa-sort-down{% endif %}{% else %}fa-sort{% endif %} sort-icon"></i></button></th>
                            <th scope="col" class="px-4 py-3 text-left"><button type="button" class="sort-button {% if sort_by == 'linha' %}active{% endif %}" data-sort-column="linha"><span>Linha</span><i class="fas {% if sort_by == 'linha' %}{% if sort_order == 'asc' %}fa-sort-up{% else %}fa-sort-down{% endif %}{% else %}fa-sort{% endif %} sort-icon"></i></button></th>
                            <th scope="col" class="px-4 py-3 text-center rounded-tr-lg">Ações</th>
                        </tr>
                        <tr class="bg-slate-100 text-xs text-dark-blue">
                            <th scope="col" class="px-4 py-2">
                                <input type="text" name="assistance_code" value="{{ filters.get('assistance_code', '') }}" class="filter-input column-filter-input" data-field="assistance_code" placeholder="Chamado">
                            </th>
                            <th scope="col" class="px-4 py-2">
                                <input type="text" name="assistance_date" value="{{ filters.get('assistance_date', '') }}" class="filter-input column-filter-input" data-field="date" placeholder="Data">
                            </th>
                            <th scope="col" class="px-4 py-2">
                                <input type="text" name="customer" value="{{ filters.get('customer', '') }}" class="filter-input column-filter-input" data-field="customer" placeholder="Cliente">
                            </th>
                            <th scope="col" class="px-4 py-2">
                                <input type="text" name="city" value="{{ filters.get('city', '') }}" class="filter-input column-filter-input" data-field="city" placeholder="Cidade/UF">
                            </th>
                            <th scope="col" class="px-4 py-2">
                                <input type="text" name="pieces" value="{{ filters.get('pieces', '') }}" class="filter-input column-filter-input text-right" data-field="pieces" placeholder="Peças">
                            </th>
                            <th scope="col" class="px-4 py-2">
                                <input type="text" name="reserved" value="{{ filters.get('reserved', '') }}" class="filter-input column-filter-input text-right" data-field="reserved" placeholder="Reservado">
                            </th>
                            <th scope="col" class="px-4 py-2">
                                <input type="text" name="separated" value="{{ filters.get('separated', '') }}" class="filter-input column-filter-input text-right" data-field="separated" placeholder="Separado">
                            </th>
                            <th scope="col" class="px-4 py-2">
                                <input type="text" name="loaded" value="{{ filters.get('loaded', '') }}" class="filter-input column-filter-input text-right" data-field="loaded" placeholder="Carregado">
                            </th>
                            <th scope="col" class="px-4 py-2">
                                <input type="text" name="line" value="{{ filters.get('line', '') }}" class="filter-input column-filter-input" data-field="line" placeholder="Linha">
                            </th>
                            <th scope="col" class="px-4 py-2 text-center"></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if assistance_records %}
                        {% for assistance in assistance_records %}
                        {% set row_bg = 'var(--clr-white)' if loop.index is odd else 'var(--clr-light-gray)' %}
                        {% set kpi_status = assistance.kpi_status %}
                        {% set chamado_status_class = 'status-kpi-blue' if kpi_status == 3 else ('status-kpi-green' if kpi_status == 2 else ('status-kpi-yellow' if kpi_status == 1 else 'status-kpi-red')) %}
                        <tr class="hover-row text-sm text-dark-blue" style="background-color: {{ row_bg }};" data-row="true">
                            <td class="py-2 px-4 whitespace-nowrap font-semibold {{ chamado_status_class }}">{{ assistance.assistec or '—' }}</td>
                            <td class="py-2 px-4 whitespace-nowrap">
                                {% if assistance.assdata %}{{ assistance.assdata.strftime('%d/%m/%Y') }}{% else %}—{% endif %}
                            </td>
                            <td class="py-2 px-4 whitespace-nowrap">
                                <div class="font-medium">{{ assistance.cliente_nome or '—' }}</div>
                                <div class="text-xs text-slate-muted">
                                    {% if assistance.asscliente %}Código {{ assistance.asscliente }}{% else %}Sem código{% endif %}
                                </div>
                            </td>
                            <td class="py-2 px-4 whitespace-nowrap">{{ assistance.cidade_estado or '—' }}</td>
                            <td class="py-2 px-4 whitespace-nowrap text-right">{{ assistance.quantidade_pecas|format_decimal_br(0) }}</td>
                            <td class="py-2 px-4 whitespace-nowrap text-right">{{ assistance.reservado|format_decimal_br }}</td>
                            <td class="py-2 px-4 whitespace-nowrap text-right">{{ assistance.separado|format_decimal_br }}</td>
                            <td class="py-2 px-4 whitespace-nowrap text-right">{{ assistance.carregado|format_decimal_br }}</td>
                            <td class="py-2 px-4 whitespace-nowrap">{{ assistance.linha or '—' }}</td>
                            <td class="py-2 px-4 text-center">
                                {% if assistance.assistec %}
                                <button
                                    type="button"
                                    class="icon-button assistance-detail-button"
                                    data-assistance-code="{{ assistance.assistec }}"
                                    aria-label="Visualizar detalhes da assistência {{ assistance.assistec }}"
                                    title="Visualizar detalhes"
                                >
                                    <i class="fas fa-eye text-blue-600 hover:text-blue-800"></i>
                                </button>
                                {% else %}
                                —
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                        <tr id="noMatchingRows" style="display: none;">
                            <td colspan="10" class="py-6 px-4 text-center text-sm text-slate-muted">
                                Nenhum registro corresponde aos filtros digitados.
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="10" class="py-6 px-4 text-center text-sm text-slate-muted">
                                Nenhum registro encontrado. Ajuste os filtros ou utilize os campos de busca acima.
                            </td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </form>
        </div>
        {% if assistance_records %}
        <div class="summary-footer">
            <div class="summary-card summary-card--blue">
                <p class="summary-label">Chamados</p>
                <p class="summary-value">{{ totals.total_registros }}</p>
            </div>
            <div class="summary-card summary-card--amber">
                <p class="summary-label">Peças</p>
                <p class="summary-value">{{ totals.total_pecas|format_decimal_br(0) }}</p>
            </div>
            <div class="summary-card summary-card--green">
                <p class="summary-label">Valor Total</p>
                <p class="summary-value">{{ totals.valor_total|format_currency_brl }}</p>
            </div>
        </div>
        <div class="status-legend">
            <div class="status-legend-item">
                <span class="status-legend-color red"></span>
                <span>Vermelho = Nada Separado</span>
            </div>
            <div class="status-legend-item">
                <span class="status-legend-color yellow"></span>
                <span>Amarelo = Parcialmente Separado</span>
            </div>
            <div class="status-legend-item">
                <span class="status-legend-color green"></span>
                <span>Verde = Totalmente Separado</span>
            </div>
            <div class="status-legend-item">
                <span class="status-legend-color blue"></span>
                <span>Azul = Totalmente Carregado</span>
            </div>
        </div>
        {% else %}
        <div class="text-center py-12 px-4 text-sm text-slate-muted">
            <div class="flex flex-col items-center gap-3">
                <i class="fas fa-tools text-2xl" style="color: var(--clr-medium-gray);"></i>
                <p class="font-semibold text-dark-blue">Nenhuma assistência técnica encontrada.</p>
                <p>Use o botão "Filtrar" para ajustar sua busca.</p>
            </div>
        </div>
        {% endif %}
    </section>
</div>

<div
    id="assistanceDetailModal"
    class="modal"
    data-endpoint="{{ url_for('production_assistance_details', assistance_identifier='__PLACEHOLDER__') }}"
>
    <div class="modal-content assistance-detail-modal-content p-6 md:p-8 rounded-xl space-y-4">
        <div class="flex items-center justify-between">
            <h2 class="section-heading">Detalhes da Assistência</h2>
            <button id="closeAssistanceDetailModalBtn" class="close-button" aria-label="Fechar detalhes da assistência">&times;</button>
        </div>
        <div id="assistanceDetailLoading" class="py-6 text-center text-sm text-dark-blue hidden">
            <i class="fas fa-spinner fa-spin mr-2"></i> Carregando detalhes da assistência...
        </div>
        <div id="assistanceDetailError" class="py-6 text-center text-sm text-red-600 hidden"></div>
        <div id="assistanceDetailContent" class="space-y-4 hidden">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm text-dark-blue">
                <div><span class="font-semibold">Assistência:</span> <span id="assistanceDetailCodigo">--</span></div>
                <div><span class="font-semibold">Cliente:</span> <span id="assistanceDetailCliente">--</span></div>
                <div><span class="font-semibold">Cidade:</span> <span id="assistanceDetailCidade">--</span></div>
                <div><span class="font-semibold">UF:</span> <span id="assistanceDetailUf">--</span></div>
                <div><span class="font-semibold">Data do Pedido:</span> <span id="assistanceDetailDataPedido">--</span></div>
                <div class="md:col-span-2"><span class="font-semibold">Lote de Produção:</span> <span id="assistanceDetailLoteProducao">--</span></div>
                <div class="md:col-span-2"><span class="font-semibold">Lote de Carga:</span> <span id="assistanceDetailLoteCarga">--</span></div>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white rounded-xl overflow-hidden">
                    <thead class="bg-gray-800 text-white" style="background-color: var(--clr-sidebar-bg);">
                        <tr class="text-xs font-medium uppercase tracking-wider">
                            <th scope="col" class="px-4 py-3 text-left">Código do Produto</th>
                            <th scope="col" class="px-4 py-3 text-left">Sequência</th>
                            <th scope="col" class="px-4 py-3 text-left">Produto</th>
                            <th scope="col" class="px-4 py-3 text-right">Reservado</th>
                            <th scope="col" class="px-4 py-3 text-right">Separado</th>
                            <th scope="col" class="px-4 py-3 text-right">Carregado</th>
                        </tr>
                    </thead>
                    <tbody id="assistanceDetailTableBody" class="text-sm text-dark-blue"></tbody>
                </table>
            </div>
            <div id="assistanceDetailTotals" class="summary-footer hidden">
                <div class="summary-card summary-card--blue">
                    <span class="summary-label">Reservado Total</span>
                    <span class="summary-value" id="assistanceDetailTotalReservado">--</span>
                </div>
                <div class="summary-card summary-card--amber">
                    <span class="summary-label">Separado Total</span>
                    <span class="summary-value" id="assistanceDetailTotalSeparado">--</span>
                </div>
                <div class="summary-card summary-card--green">
                    <span class="summary-label">Carregado Total</span>
                    <span class="summary-value" id="assistanceDetailTotalCarregado">--</span>
                </div>
            </div>
            <div id="assistanceDetailEmptyState" class="hidden text-sm text-center text-slate-muted">
                Nenhum item encontrado para esta assistência.
            </div>
        </div>
    </div>
</div>

<div id="filterModal" class="modal">
    <div class="modal-content" style="max-width: 56rem;">
        <div class="flex justify-between items-center mb-4">
            <h2 class="section-heading">Filtrar Assistências</h2>
            <button id="closeFilterModalBtn" class="close-button">&times;</button>
        </div>
        <form id="filterForm" action="{{ list_url }}" method="GET" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <div>
                    <label class="form-label" for="start_date">Data Inicial</label>
                    <input id="start_date" name="start_date" type="date" class="form-input"
                           value="{{ filters.start_date }}">
                </div>
                <div>
                    <label class="form-label" for="end_date">Data Final</label>
                    <input id="end_date" name="end_date" type="date" class="form-input"
                           value="{{ filters.end_date }}">
                </div>
                <div>
                    <label class="form-label">Lote de Carga</label>
                    <div class="checkbox-multi-select" data-field-name="load_lots" data-placeholder="Todos os lotes de carga">
                        <button type="button" class="checkbox-multi-select__trigger" aria-haspopup="listbox" aria-expanded="false">
                            <span class="checkbox-multi-select__trigger-label">Todos os lotes de carga</span>
                            <span class="checkbox-multi-select__chevron" aria-hidden="true">&#9662;</span>
                        </button>
                        <div class="checkbox-multi-select__dropdown">
                            <div>
                                <input type="text" class="filter-input checkbox-multi-select__search-input" placeholder="Pesquisar lotes..." aria-label="Pesquisar no campo Lote de Carga">
                            </div>
                            <div class="checkbox-multi-select__options" role="listbox" aria-multiselectable="true">
                                {% for option in load_lot_options %}
                                    {% set code = option.code %}
                                    {% set description = option.description %}
                                    {% if code or description %}
                                        {% set option_id = 'load-lot-option-' ~ loop.index %}
                                        {% if code and description %}
                                            {% set display_label = code ~ ' - ' ~ description %}
                                        {% elif code %}
                                            {% set display_label = code %}
                                        {% else %}
                                            {% set display_label = description %}
                                        {% endif %}
                                        <label class="checkbox-multi-select__option" data-search-value="{{ display_label | lower }}" for="{{ option_id }}">
                                            <input type="checkbox" id="{{ option_id }}" value="{{ code }}" {% if code in (filters.load_lots or []) %}checked{% endif %} data-label="{{ display_label }}">
                                            <span class="checkbox-multi-select__option-label">{{ display_label }}</span>
                                        </label>
                                    {% endif %}
                                {% endfor %}
                            </div>
                            <div class="checkbox-multi-select__empty-message" data-empty-message hidden>Nenhuma opção encontrada</div>
                        </div>
                        <div class="checkbox-multi-select__inputs" data-input-container></div>
                    </div>
                </div>
                <div>
                    <label class="form-label">Lote de Produção</label>
                    <div class="checkbox-multi-select" data-field-name="production_lots" data-placeholder="Todos os lotes de produção">
                        <button type="button" class="checkbox-multi-select__trigger" aria-haspopup="listbox" aria-expanded="false">
                            <span class="checkbox-multi-select__trigger-label">Todos os lotes de produção</span>
                            <span class="checkbox-multi-select__chevron" aria-hidden="true">&#9662;</span>
                        </button>
                        <div class="checkbox-multi-select__dropdown">
                            <div>
                                <input type="text" class="filter-input checkbox-multi-select__search-input" placeholder="Pesquisar lotes..." aria-label="Pesquisar no campo Lote de Produção">
                            </div>
                            <div class="checkbox-multi-select__options" role="listbox" aria-multiselectable="true">
                                {% for option in production_lot_options %}
                                    {% set code = option.code %}
                                    {% set description = option.description %}
                                    {% if code or description %}
                                        {% set option_id = 'production-lot-option-' ~ loop.index %}
                                        {% if code and description %}
                                            {% set display_label = code ~ ' - ' ~ description %}
                                        {% elif code %}
                                            {% set display_label = code %}
                                        {% else %}
                                            {% set display_label = description %}
                                        {% endif %}
                                        <label class="checkbox-multi-select__option" data-search-value="{{ display_label | lower }}" for="{{ option_id }}">
                                            <input type="checkbox" id="{{ option_id }}" value="{{ code }}" {% if code in (filters.production_lots or []) %}checked{% endif %} data-label="{{ display_label }}">
                                            <span class="checkbox-multi-select__option-label">{{ display_label }}</span>
                                        </label>
                                    {% endif %}
                                {% endfor %}
                            </div>
                            <div class="checkbox-multi-select__empty-message" data-empty-message hidden>Nenhuma opção encontrada</div>
                        </div>
                        <div class="checkbox-multi-select__inputs" data-input-container></div>
                    </div>
                </div>
                <div>
                    <label class="form-label">Linha</label>
                    <div class="checkbox-multi-select" data-field-name="lines" data-placeholder="Todas as linhas">
                        <button type="button" class="checkbox-multi-select__trigger" aria-haspopup="listbox" aria-expanded="false">
                            <span class="checkbox-multi-select__trigger-label">Todas as linhas</span>
                            <span class="checkbox-multi-select__chevron" aria-hidden="true">&#9662;</span>
                        </button>
                        <div class="checkbox-multi-select__dropdown">
                            <div>
                                <input type="text" class="filter-input checkbox-multi-select__search-input" placeholder="Pesquisar linhas..." aria-label="Pesquisar no campo Linha">
                            </div>
                            <div class="checkbox-multi-select__options" role="listbox" aria-multiselectable="true">
                                {% for option in line_options %}
                                    {% set option_id = 'line-option-' ~ loop.index %}
                                    {% set display_label = option.label %}
                                    <label class="checkbox-multi-select__option" data-search-value="{{ display_label | lower }}" for="{{ option_id }}">
                                        <input type="checkbox" id="{{ option_id }}" value="{{ option.code }}" {% if option.code in (filters.lines or []) %}checked{% endif %} data-label="{{ display_label }}">
                                        <span class="checkbox-multi-select__option-label">{{ display_label }}</span>
                                    </label>
                                {% endfor %}
                            </div>
                            <div class="checkbox-multi-select__empty-message" data-empty-message hidden>Nenhuma opção encontrada</div>
                        </div>
                        <div class="checkbox-multi-select__inputs" data-input-container></div>
                    </div>
                </div>
                <div>
                    <label class="form-label">Status</label>
                    <div class="checkbox-multi-select" data-field-name="statuses" data-placeholder="Todos os status">
                        <button type="button" class="checkbox-multi-select__trigger" aria-haspopup="listbox" aria-expanded="false">
                            <span class="checkbox-multi-select__trigger-label">Todos os status</span>
                            <span class="checkbox-multi-select__chevron" aria-hidden="true">&#9662;</span>
                        </button>
                        <div class="checkbox-multi-select__dropdown">
                            <div>
                                <input type="text" class="filter-input checkbox-multi-select__search-input" placeholder="Pesquisar status..." aria-label="Pesquisar no campo Status">
                            </div>
                            <div class="checkbox-multi-select__options" role="listbox" aria-multiselectable="true">
                                {% for option in status_options %}
                                    {% set option_id = 'status-option-' ~ loop.index %}
                                    <label class="checkbox-multi-select__option" data-search-value="{{ option.label | lower }}" for="{{ option_id }}">
                                        <input type="checkbox" id="{{ option_id }}" value="{{ option.code }}" {% if option.code in (filters.statuses or []) %}checked{% endif %} data-label="{{ option.label }}">
                                        <span class="checkbox-multi-select__option-label">{{ option.label }}</span>
                                    </label>
                                {% endfor %}
                            </div>
                            <div class="checkbox-multi-select__empty-message" data-empty-message hidden>Nenhuma opção encontrada</div>
                        </div>
                        <div class="checkbox-multi-select__inputs" data-input-container></div>
                    </div>
                </div>
                <div>
                    <label class="form-label">Situação</label>
                    <div class="checkbox-multi-select" data-field-name="situations" data-placeholder="Todas as situações">
                        <button type="button" class="checkbox-multi-select__trigger" aria-haspopup="listbox" aria-expanded="false">
                            <span class="checkbox-multi-select__trigger-label">Todas as situações</span>
                            <span class="checkbox-multi-select__chevron" aria-hidden="true">&#9662;</span>
                        </button>
                        <div class="checkbox-multi-select__dropdown">
                            <div>
                                <input type="text" class="filter-input checkbox-multi-select__search-input" placeholder="Pesquisar situações..." aria-label="Pesquisar no campo Situação">
                            </div>
                            <div class="checkbox-multi-select__options" role="listbox" aria-multiselectable="true">
                                {% for option in situation_options %}
                                    {% set option_id = 'situation-option-' ~ loop.index %}
                                    <label class="checkbox-multi-select__option" data-search-value="{{ option.label | lower }}" for="{{ option_id }}">
                                        <input type="checkbox" id="{{ option_id }}" value="{{ option.code }}" {% if option.code in (filters.situations or []) %}checked{% endif %} data-label="{{ option.label }}">
                                        <span class="checkbox-multi-select__option-label">{{ option.label }}</span>
                                    </label>
                                {% endfor %}
                            </div>
                            <div class="checkbox-multi-select__empty-message" data-empty-message hidden>Nenhuma opção encontrada</div>
                        </div>
                        <div class="checkbox-multi-select__inputs" data-input-container></div>
                    </div>
                </div>
            </div>
            <div class="flex justify-end space-x-4 mt-6">
                <button type="button" id="clearFiltersBtn" class="btn btn-secondary">Limpar Filtros</button>
                <button type="submit" class="btn btn-primary">Aplicar Filtros</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const filterModal = document.getElementById('filterModal');
    const openFilterModalBtn = document.getElementById('openFilterModalBtn');
    const closeFilterModalBtn = document.getElementById('closeFilterModalBtn');
    const clearFiltersBtn = document.getElementById('clearFiltersBtn');
    const columnFilterForm = document.getElementById('columnFilterForm');
    const clearColumnFiltersBtn = document.getElementById('clearColumnFiltersBtn');
    const sortableButtons = document.querySelectorAll('[data-sort-column]');
    const sortByInput = document.getElementById('columnSortByInput');
    const sortOrderInput = document.getElementById('columnSortOrderInput');
    const visibleCountElement = document.getElementById('visibleRecordsCount');
    const noMatchingRows = document.getElementById('noMatchingRows');
    const assistanceDetailModal = document.getElementById('assistanceDetailModal');
    const closeAssistanceDetailModalBtn = document.getElementById('closeAssistanceDetailModalBtn');
    const assistanceDetailButtons = Array.from(document.querySelectorAll('.assistance-detail-button[data-assistance-code]'));
    const assistanceDetailLoading = document.getElementById('assistanceDetailLoading');
    const assistanceDetailError = document.getElementById('assistanceDetailError');
    const assistanceDetailContent = document.getElementById('assistanceDetailContent');
    const assistanceDetailTableBody = document.getElementById('assistanceDetailTableBody');
    const assistanceDetailEmptyState = document.getElementById('assistanceDetailEmptyState');
    const assistanceDetailEndpointTemplate = assistanceDetailModal ? assistanceDetailModal.dataset.endpoint || '' : '';
    const assistanceDetailFields = {
        codigo: document.getElementById('assistanceDetailCodigo'),
        cliente: document.getElementById('assistanceDetailCliente'),
        cidade: document.getElementById('assistanceDetailCidade'),
        uf: document.getElementById('assistanceDetailUf'),
        dataPedido: document.getElementById('assistanceDetailDataPedido'),
        loteProducao: document.getElementById('assistanceDetailLoteProducao'),
        loteCarga: document.getElementById('assistanceDetailLoteCarga'),
    };
    const assistanceDetailTotalsContainer = document.getElementById('assistanceDetailTotals');
    const assistanceDetailTotalsFields = {
        reservado: document.getElementById('assistanceDetailTotalReservado'),
        separado: document.getElementById('assistanceDetailTotalSeparado'),
        carregado: document.getElementById('assistanceDetailTotalCarregado'),
    };
    const multiSelectInstances = [];

    class CheckboxMultiSelect {
        constructor(element) {
            this.element = element;
            this.fieldName = element.dataset.fieldName || '';
            this.placeholder = element.dataset.placeholder || 'Selecione';
            this.trigger = element.querySelector('.checkbox-multi-select__trigger');
            this.triggerLabel = this.trigger ? this.trigger.querySelector('.checkbox-multi-select__trigger-label') : null;
            this.dropdown = element.querySelector('.checkbox-multi-select__dropdown');
            this.inputContainer = element.querySelector('[data-input-container]');
            this.searchInput = element.querySelector('.checkbox-multi-select__search-input');
            this.optionCheckboxes = Array.from(
                element.querySelectorAll('.checkbox-multi-select__option input[type="checkbox"]')
            );
            this.emptyMessage = element.querySelector('[data-empty-message]');
            this.isOpen = false;

            if (this.trigger) {
                this.trigger.addEventListener('click', (event) => {
                    event.preventDefault();
                    this.toggleDropdown();
                });
                this.trigger.setAttribute('aria-expanded', 'false');
            }

            this.optionCheckboxes.forEach((checkbox) => {
                checkbox.addEventListener('change', () => {
                    this.syncHiddenInputs();
                    this.updateTriggerLabel();
                });
            });

            if (this.searchInput) {
                this.searchInput.addEventListener('input', () => {
                    this.filterOptions(this.searchInput.value);
                });
            }

            this.handleDocumentClick = (event) => {
                if (!this.element.contains(event.target)) {
                    this.closeDropdown();
                }
            };
            document.addEventListener('click', this.handleDocumentClick);

            this.syncHiddenInputs();
            this.updateTriggerLabel();
        }

        toggleDropdown() {
            if (this.isOpen) {
                this.closeDropdown();
            } else {
                this.openDropdown();
            }
        }

        openDropdown() {
            this.isOpen = true;
            this.element.classList.add('is-open');
            if (this.trigger) {
                this.trigger.setAttribute('aria-expanded', 'true');
            }
            if (this.searchInput) {
                this.searchInput.focus();
                this.searchInput.select();
            }
        }

        closeDropdown() {
            this.isOpen = false;
            this.element.classList.remove('is-open');
            if (this.trigger) {
                this.trigger.setAttribute('aria-expanded', 'false');
            }
        }

        syncHiddenInputs() {
            if (!this.inputContainer || !this.fieldName) {
                return;
            }
            this.inputContainer.innerHTML = '';
            this.selectedLabels = [];
            this.optionCheckboxes.forEach((checkbox) => {
                if (!checkbox.checked) {
                    return;
                }
                const hiddenInput = document.createElement('input');
                hiddenInput.type = 'hidden';
                hiddenInput.name = this.fieldName;
                hiddenInput.value = checkbox.value;
                this.inputContainer.appendChild(hiddenInput);

                const optionLabel = checkbox.dataset.label || checkbox.value;
                if (optionLabel) {
                    this.selectedLabels.push(optionLabel);
                }
            });
        }

        updateTriggerLabel() {
            if (!this.triggerLabel) {
                return;
            }
            if (!this.selectedLabels || this.selectedLabels.length === 0) {
                this.triggerLabel.textContent = this.placeholder;
                return;
            }
            if (this.selectedLabels.length <= 2) {
                this.triggerLabel.textContent = this.selectedLabels.join(', ');
                return;
            }
            this.triggerLabel.textContent = `${this.selectedLabels.length} selecionados`;
        }

        filterOptions(query) {
            const normalizedQuery = (query || '').toString().trim().toLowerCase();
            let visibleCount = 0;
            this.optionCheckboxes.forEach((checkbox) => {
                const optionRow = checkbox.closest('.checkbox-multi-select__option');
                if (!optionRow) {
                    return;
                }
                const searchValue = (
                    optionRow.dataset.searchValue ||
                    checkbox.dataset.label ||
                    checkbox.value ||
                    ''
                ).toLowerCase();
                const matches = !normalizedQuery || searchValue.includes(normalizedQuery);
                optionRow.style.display = matches ? '' : 'none';
                if (matches) {
                    visibleCount += 1;
                }
            });
            if (this.emptyMessage) {
                this.emptyMessage.hidden = visibleCount !== 0;
            }
        }
    }

    document.querySelectorAll('.checkbox-multi-select').forEach((element) => {
        if (!element.dataset.fieldName) {
            return;
        }
        multiSelectInstances.push(new CheckboxMultiSelect(element));
    });

    const closeAllMultiSelects = () => {
        multiSelectInstances.forEach((instance) => instance.closeDropdown());
    };
    let lastFocusedAssistanceTrigger = null;

    const safeText = (value, fallback = '—') => {
        if (value === null || value === undefined) {
            return fallback;
        }
        const normalized = String(value).trim();
        return normalized || fallback;
    };

    const setFieldText = (element, value) => {
        if (!element) {
            return;
        }
        element.textContent = safeText(value);
    };

    const setFieldList = (element, value) => {
        if (!element) {
            return;
        }
        const items = Array.isArray(value)
            ? value
            : String(value || '')
                  .split(';')
                  .map((item) => item.trim())
                  .filter((item) => item.length > 0);
        if (!items.length) {
            element.textContent = '—';
            return;
        }
        element.textContent = '';
        items.forEach((item, index) => {
            if (index > 0) {
                element.appendChild(document.createElement('br'));
            }
            element.appendChild(document.createTextNode(item));
        });
    };

    const quantityFormatter = new Intl.NumberFormat('pt-BR', {
        minimumFractionDigits: 0,
        maximumFractionDigits: 4,
    });

    const formatQuantity = (value) => {
        const numeric = Number(value);
        if (Number.isNaN(numeric)) {
            return quantityFormatter.format(0);
        }
        return quantityFormatter.format(numeric);
    };

    const updateAssistanceTotals = (totals) => {
        if (!assistanceDetailTotalsContainer) {
            return;
        }
        const reservadoValue =
            totals && typeof totals.reservado_total !== 'undefined'
                ? totals.reservado_total
                : 0;
        const separadoValue =
            totals && typeof totals.separado_total !== 'undefined'
                ? totals.separado_total
                : 0;
        const carregadoValue =
            totals && typeof totals.carregado_total !== 'undefined'
                ? totals.carregado_total
                : 0;
        if (assistanceDetailTotalsFields.reservado) {
            assistanceDetailTotalsFields.reservado.textContent = formatQuantity(reservadoValue);
        }
        if (assistanceDetailTotalsFields.separado) {
            assistanceDetailTotalsFields.separado.textContent = formatQuantity(separadoValue);
        }
        if (assistanceDetailTotalsFields.carregado) {
            assistanceDetailTotalsFields.carregado.textContent = formatQuantity(carregadoValue);
        }
        assistanceDetailTotalsContainer.classList.remove('hidden');
    };

    const resetAssistanceDetail = () => {
        Object.values(assistanceDetailFields).forEach((element) => {
            if (element) {
                element.textContent = '--';
            }
        });
        if (assistanceDetailTableBody) {
            assistanceDetailTableBody.innerHTML = '';
        }
        if (assistanceDetailEmptyState) {
            assistanceDetailEmptyState.classList.add('hidden');
        }
        if (assistanceDetailTotalsFields.reservado) {
            assistanceDetailTotalsFields.reservado.textContent = '--';
        }
        if (assistanceDetailTotalsFields.separado) {
            assistanceDetailTotalsFields.separado.textContent = '--';
        }
        if (assistanceDetailTotalsFields.carregado) {
            assistanceDetailTotalsFields.carregado.textContent = '--';
        }
        if (assistanceDetailTotalsContainer) {
            assistanceDetailTotalsContainer.classList.add('hidden');
        }
    };

    const showAssistanceDetailLoading = () => {
        if (assistanceDetailLoading) {
            assistanceDetailLoading.classList.remove('hidden');
        }
        if (assistanceDetailError) {
            assistanceDetailError.classList.add('hidden');
            assistanceDetailError.textContent = '';
        }
        if (assistanceDetailContent) {
            assistanceDetailContent.classList.add('hidden');
        }
        if (assistanceDetailTotalsContainer) {
            assistanceDetailTotalsContainer.classList.add('hidden');
        }
    };

    const showAssistanceDetailContent = () => {
        if (assistanceDetailContent) {
            assistanceDetailContent.classList.remove('hidden');
        }
        if (assistanceDetailLoading) {
            assistanceDetailLoading.classList.add('hidden');
        }
        if (assistanceDetailError) {
            assistanceDetailError.classList.add('hidden');
        }
    };

    const showAssistanceDetailError = (message) => {
        if (assistanceDetailError) {
            assistanceDetailError.textContent = message || 'Não foi possível carregar os detalhes da assistência.';
            assistanceDetailError.classList.remove('hidden');
        }
        if (assistanceDetailLoading) {
            assistanceDetailLoading.classList.add('hidden');
        }
        if (assistanceDetailContent) {
            assistanceDetailContent.classList.add('hidden');
        }
        if (assistanceDetailTotalsContainer) {
            assistanceDetailTotalsContainer.classList.add('hidden');
        }
    };

    const renderAssistanceItems = (items) => {
        if (!assistanceDetailTableBody) {
            return;
        }
        assistanceDetailTableBody.innerHTML = '';
        if (!Array.isArray(items) || items.length === 0) {
            if (assistanceDetailEmptyState) {
                assistanceDetailEmptyState.classList.remove('hidden');
            }
            return;
        }
        if (assistanceDetailEmptyState) {
            assistanceDetailEmptyState.classList.add('hidden');
        }
        const createCell = (value, alignRight = false) => {
            const cell = document.createElement('td');
            cell.className = `px-4 py-2 ${alignRight ? 'text-right' : 'text-left'}`;
            cell.textContent = safeText(value);
            return cell;
        };

        items.forEach((item) => {
            const row = document.createElement('tr');
            row.appendChild(createCell(item.codigo_produto));
            row.appendChild(createCell(item.sequencia));
            row.appendChild(createCell(item.produto));
            row.appendChild(createCell(formatQuantity(item.reservado), true));
            row.appendChild(createCell(formatQuantity(item.separado), true));
            row.appendChild(createCell(formatQuantity(item.carregado), true));
            assistanceDetailTableBody.appendChild(row);
        });
    };

    const closeAssistanceDetailModal = () => {
        if (assistanceDetailModal) {
            assistanceDetailModal.style.display = 'none';
        }
        if (lastFocusedAssistanceTrigger) {
            lastFocusedAssistanceTrigger.focus({ preventScroll: true });
        }
    };

    const fetchAssistanceDetail = async (code) => {
        if (!code || !assistanceDetailEndpointTemplate) {
            showAssistanceDetailError('Código da assistência inválido.');
            return;
        }
        const endpoint = assistanceDetailEndpointTemplate.replace('__PLACEHOLDER__', encodeURIComponent(code));
        try {
            const response = await fetch(endpoint, {
                headers: { Accept: 'application/json' },
            });
            if (!response.ok) {
                let message = 'Erro ao carregar detalhes da assistência.';
                try {
                    const payload = await response.json();
                    if (payload && payload.error) {
                        message = payload.error;
                    }
                } catch (parseError) {
                    console.error('Erro ao interpretar a resposta da assistência:', parseError);
                }
                throw new Error(message);
            }
            const data = await response.json();
            const header = data.header || {};
            setFieldText(assistanceDetailFields.codigo, header.assistencia);
            setFieldText(assistanceDetailFields.cliente, header.cliente);
            setFieldText(assistanceDetailFields.cidade, header.cidade);
            setFieldText(assistanceDetailFields.uf, header.uf);
            setFieldText(assistanceDetailFields.dataPedido, header.data_pedido);
            setFieldList(assistanceDetailFields.loteProducao, header.lote_producao);
            setFieldList(assistanceDetailFields.loteCarga, header.lote_carga);
            updateAssistanceTotals(data.totals);
            renderAssistanceItems(Array.isArray(data.items) ? data.items : []);
            showAssistanceDetailContent();
        } catch (error) {
            console.error('Erro ao buscar detalhes da assistência:', error);
            showAssistanceDetailError(error.message);
        }
    };

    const openAssistanceDetailModal = (code, trigger) => {
        if (!assistanceDetailModal || !code) {
            return;
        }
        lastFocusedAssistanceTrigger = trigger || null;
        assistanceDetailModal.style.display = 'flex';
        resetAssistanceDetail();
        showAssistanceDetailLoading();
        fetchAssistanceDetail(code);
    };

    if (closeAssistanceDetailModalBtn) {
        closeAssistanceDetailModalBtn.addEventListener('click', closeAssistanceDetailModal);
    }

    if (assistanceDetailModal) {
        assistanceDetailModal.addEventListener('click', (event) => {
            if (event.target === assistanceDetailModal) {
                closeAssistanceDetailModal();
            }
        });
    }

    assistanceDetailButtons.forEach((button) => {
        button.addEventListener('click', () => {
            const code = (button.dataset.assistanceCode || '').trim();
            if (!code) {
                return;
            }
            openAssistanceDetailModal(code, button);
        });
    });

    const columnFilterInputs = columnFilterForm ? Array.from(columnFilterForm.querySelectorAll('.column-filter-input')) : [];
    const dataRows = Array.from(document.querySelectorAll('tr[data-row=\"true\"]'));

    if (visibleCountElement && !visibleCountElement.dataset.total) {
        visibleCountElement.dataset.total = String(dataRows.length);
    }

    // Modal handling
    if (openFilterModalBtn) {
        openFilterModalBtn.addEventListener('click', () => {
            if (filterModal) {
                filterModal.style.display = 'flex';
            }
        });
    }
    if (closeFilterModalBtn) {
        closeFilterModalBtn.addEventListener('click', () => {
            if (filterModal) {
                filterModal.style.display = 'none';
                closeAllMultiSelects();
            }
        });
    }
    if (clearFiltersBtn) {
        clearFiltersBtn.addEventListener('click', () => {
            window.location.href = "{{ list_url }}";
        });
    }
    if (filterModal) {
        window.addEventListener('click', (event) => {
            if (event.target === filterModal) {
                filterModal.style.display = 'none';
                closeAllMultiSelects();
            }
        });
    }

    const fieldIndexMap = {
        assistance_code: 0,
        date: 1,
        customer: 2,
        city: 3,
        pieces: 4,
        reserved: 5,
        separated: 6,
        loaded: 7,
        line: 8,
    };

    const normalizeText = (value) => {
        return (value || '')
            .toString()
            .normalize('NFD')
            .replace(/[\u0300-\u036f]/g, '')
            .toLowerCase()
            .replace(/[^a-z0-9]/g, '');
    };

    const rowCache = dataRows.map((row) => {
        const cells = Array.from(row.querySelectorAll('td'));
        const fields = {};

        Object.entries(fieldIndexMap).forEach(([field, index]) => {
            const cellValue = cells[index] ? cells[index].textContent : '';
            fields[field] = {
                raw: cellValue || '',
                normalized: normalizeText(cellValue),
            };
        });

        return {
            element: row,
            fields,
        };
    });

    const updateVisibleCount = (count) => {
        if (!visibleCountElement) {
            return;
        }
        const fallback = parseInt(visibleCountElement.dataset.total || '0', 10);
        const nextValue = typeof count === 'number' ? count : fallback;
        visibleCountElement.textContent = String(nextValue);
    };

    const applyFilters = () => {
        if (!rowCache.length) {
            updateVisibleCount(0);
            if (noMatchingRows) {
                noMatchingRows.style.display = 'none';
            }
            return;
        }

        const columnFilters = {};

        columnFilterInputs.forEach((input) => {
            const key = input.dataset.field;
            if (!key) {
                return;
            }
            const value = normalizeText(input.value);
            if (value) {
                columnFilters[key] = value;
            }
        });

        let visibleCount = 0;

        rowCache.forEach((row) => {
            let matches = true;

            for (const [field, filterValue] of Object.entries(columnFilters)) {
                const fieldValue = row.fields[field]?.normalized || '';
                if (!fieldValue.includes(filterValue)) {
                    matches = false;
                    break;
                }
            }

            row.element.style.display = matches ? '' : 'none';

            if (matches) {
                visibleCount += 1;
            }
        });

        updateVisibleCount(visibleCount);

        if (noMatchingRows) {
            noMatchingRows.style.display = visibleCount === 0 ? '' : 'none';
        }
    };

    let filterDebounce;
    const scheduleFilter = () => {
        clearTimeout(filterDebounce);
        filterDebounce = setTimeout(applyFilters, 150);
    };

    if (columnFilterForm) {
        columnFilterForm.addEventListener('submit', (event) => {
            event.preventDefault();
            applyFilters();
        });
    }

    columnFilterInputs.forEach((input) => {
        input.addEventListener('input', scheduleFilter);
        input.addEventListener('change', scheduleFilter);
    });

    if (clearColumnFiltersBtn) {
        clearColumnFiltersBtn.addEventListener('click', (event) => {
            event.preventDefault();
            columnFilterInputs.forEach((input) => {
                input.value = '';
            });
            applyFilters();
        });
    }

    // Sorting
    if (columnFilterForm) {
        sortableButtons.forEach((button) => {
            button.addEventListener('click', () => {
                const column = button.dataset.sortColumn;
                const currentOrder = sortOrderInput.value;

                let nextOrder = 'asc';
                if (sortByInput.value === column && currentOrder === 'asc') {
                    nextOrder = 'desc';
                }

                sortByInput.value = column;
                sortOrderInput.value = nextOrder;

                columnFilterForm.submit();
            });
        });
    }

    applyFilters();

    document.addEventListener('keydown', (event) => {
        if (event.key !== 'Escape') {
            return;
        }
        closeAllMultiSelects();
        if (filterModal && filterModal.style.display === 'flex') {
            filterModal.style.display = 'none';
        }
        if (assistanceDetailModal && assistanceDetailModal.style.display === 'flex') {
            closeAssistanceDetailModal();
        }
    });
});
</script>
{% endblock %}
