{% extends "base.html" %}

{% block title %}Cálculo MRP{% endblock %}

{% block page_title %}Cálculo MRP - Material Requirements Planning{% endblock %}

{% block extra_head %}
<style>
    .filter-section {
        background-color: var(--clr-card-bg);
        border-radius: 0.75rem;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 1px 3px 0 rgba(0,0,0,0.1);
    }

    .filter-group {
        margin-bottom: 1rem;
    }

    .filter-label {
        font-weight: 600;
        color: var(--clr-dark-blue);
        margin-bottom: 0.5rem;
        display: block;
    }

    .filter-select {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid var(--clr-border);
        border-radius: 0.375rem;
        background-color: white;
    }

    .quick-filter-buttons {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
        margin-bottom: 1rem;
    }

    .quick-filter-btn {
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        border: 2px solid var(--clr-light-blue);
        background-color: white;
        color: var(--clr-light-blue);
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }

    .quick-filter-btn.active {
        background-color: var(--clr-light-blue);
        color: white;
    }

    .quick-filter-btn:hover {
        background-color: var(--clr-light-blue);
        color: white;
    }

    .mrp-table {
        width: 100%;
        border-collapse: collapse;
        background-color: white;
        border-radius: 0.5rem;
        overflow: hidden;
        box-shadow: 0 1px 3px 0 rgba(0,0,0,0.1);
    }

    .mrp-table thead {
        background-color: var(--clr-dark-blue);
        color: white;
    }

    /* Header clone fixo */
    #stickyHeaderClone {
        position: fixed;
        top: 0;
        z-index: 500;
        background-color: var(--clr-dark-blue);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        display: none;
        overflow: hidden;
    }

    #stickyHeaderClone.active {
        display: block;
    }

    #stickyHeaderClone table {
        margin: 0;
        border-collapse: collapse;
    }

    #stickyHeaderClone th {
        background-color: var(--clr-dark-blue) !important;
        color: white !important;
        padding: 0.5rem;
        text-align: left;
        font-weight: 600;
        font-size: 0.75rem;
        white-space: nowrap;
        border: none;
    }

    #stickyHeaderClone .col-estoque {
        background-color: #28a745 !important;
    }

    #stickyHeaderClone .col-ordem {
        background-color: #0d6efd !important;
    }

    #stickyHeaderClone .col-reserva {
        background-color: #fd7e14 !important;
    }

    /* Alinhamento das colunas numéricas no clone */
    #stickyHeaderClone th:nth-child(n+4):nth-child(-n+14) {
        text-align: right;
    }

    /* Ajustar flexbox no clone para colunas com botões */
    #stickyHeaderClone th:nth-child(10) > div,
    #stickyHeaderClone th:nth-child(11) > div {
        justify-content: flex-end;
    }

    #stickyHeaderClone th:nth-child(10) > div > span,
    #stickyHeaderClone th:nth-child(11) > div > span {
        text-align: right;
    }

    .mrp-table th {
        padding: 0.5rem;
        text-align: left;
        font-weight: 600;
        font-size: 0.75rem;
        white-space: nowrap;
    }

    .mrp-table td {
        padding: 0.375rem 0.5rem;
        border-bottom: 1px solid var(--clr-border);
        font-size: 0.75rem;
    }

    /* Ajustes de responsividade */
    .table-container {
        max-width: 100%;
    }

    .table-wrapper {
        overflow-x: auto;
        overflow-y: visible;
        position: relative;
        width: 100%;
    }

    .mrp-table {
        min-width: 1200px;
        font-size: 0.75rem;
    }

    /* Colunas com largura otimizada */
    .mrp-table th:nth-child(1),
    .mrp-table td:nth-child(1) {
        width: 50px;
        text-align: center;
    }

    .mrp-table th:nth-child(2),
    .mrp-table td:nth-child(2) {
        width: 90px;
    }

    .mrp-table th:nth-child(3),
    .mrp-table td:nth-child(3) {
        min-width: 180px;
        max-width: 280px;
    }

    /* Colunas numéricas alinhadas à direita */
    .mrp-table td:nth-child(n+4):nth-child(-n+14) {
        text-align: right;
    }

    /* Headers das colunas numéricas também alinhados à direita */
    .mrp-table thead tr:last-child th:nth-child(n+4):nth-child(-n+14) {
        text-align: right;
    }

    /* Ajustar flexbox nos headers com botões para manter alinhamento */
    .mrp-table thead tr:last-child th:nth-child(10) > div,
    .mrp-table thead tr:last-child th:nth-child(11) > div {
        justify-content: flex-end;
    }

    .mrp-table thead tr:last-child th:nth-child(10) > div > span,
    .mrp-table thead tr:last-child th:nth-child(11) > div > span {
        text-align: right;
    }

    /* Responsividade para monitores menores */
    @media screen and (max-width: 1600px) {
        .mrp-table {
            font-size: 0.7rem;
        }

        .mrp-table th,
        .mrp-table td {
            padding: 0.3rem 0.4rem;
        }

        .mrp-table input[type="number"] {
            width: 60px;
            font-size: 0.7rem;
        }
    }

    .mrp-table tbody tr:hover {
        background-color: var(--clr-light-gray);
    }

    .mrp-table input[type="number"] {
        width: 70px;
        padding: 0.25rem 0.375rem;
        border: 1px solid var(--clr-border);
        border-radius: 0.25rem;
        font-size: 0.75rem;
        text-align: right;
    }

    .urgente-cell {
        background-color: #fee;
        color: var(--clr-error);
        font-weight: 600;
    }

    .necessidade-cell {
        background-color: #fef3cd;
        color: #856404;
        font-weight: 600;
    }

    .sem-necessidade-cell {
        background-color: #d4edda;
        color: var(--clr-success);
        font-weight: 600;
    }

    .summary-box {
        background: linear-gradient(135deg, var(--clr-light-blue), var(--clr-dark-blue));
        color: white;
        padding: 0.875rem 1rem;
        border-radius: 0.5rem;
        margin-bottom: 1rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .summary-box.sticky {
        position: sticky;
        top: 0;
        z-index: 1000;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    }

    .loading-overlay.active {
        display: flex;
    }

    .spinner {
        border: 4px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top: 4px solid white;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .action-buttons {
        display: flex;
        gap: 1rem;
        margin-bottom: 1.5rem;
        flex-wrap: wrap;
    }

    .table-container {
        margin-bottom: 2rem;
    }


    /* Destaque de colunas específicas */
    .col-estoque {
        background-color: #d4edda !important;
        color: #155724 !important;
        font-weight: 600;
    }

    .col-ordem {
        background-color: #cfe2ff !important;
        color: #084298 !important;
        font-weight: 600;
    }

    .col-reserva {
        background-color: #fff3cd !important;
        color: #856404 !important;
        font-weight: 600;
    }

    .mrp-table th.col-estoque {
        background-color: #28a745 !important;
        color: white !important;
    }

    .mrp-table th.col-ordem {
        background-color: #0d6efd !important;
        color: white !important;
    }

    .mrp-table th.col-reserva {
        background-color: #fd7e14 !important;
        color: white !important;
    }

    /* Estilos para painel de filtros selecionados */
    .selected-filters-panel {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1rem;
        border-radius: 0.5rem;
        margin-bottom: 1rem;
        display: none;
    }

    .selected-filters-panel.active {
        display: block;
    }

    .filter-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 0.5rem;
    }

    .filter-tag {
        background: rgba(255, 255, 255, 0.25);
        padding: 0.375rem 0.75rem;
        border-radius: 1rem;
        font-size: 0.875rem;
        display: flex;
        align-items: center;
        gap: 0.25rem;
        backdrop-filter: blur(10px);
    }

    .filter-tag i {
        font-size: 0.75rem;
    }

    .selection-counter {
        background-color: var(--clr-light-blue);
        color: white;
        padding: 0.125rem 0.5rem;
        border-radius: 1rem;
        font-size: 0.75rem;
        font-weight: 700;
        margin-left: 0.5rem;
        display: inline-block;
    }

    .selection-counter.empty {
        background-color: #ccc;
    }

    .filter-instruction {
        font-size: 0.875rem;
        color: #666;
        margin-top: 0.25rem;
        font-style: italic;
    }

    .multiselect-box {
        border: 2px solid var(--clr-border);
        border-radius: 0.375rem;
        padding: 0.5rem;
        background-color: white;
        transition: border-color 0.2s;
    }

    .multiselect-box.has-selection {
        border-color: var(--clr-light-blue);
        background-color: #f0f7ff;
    }

    .multiselect-box select {
        border: none;
        background: transparent;
        padding: 0;
    }

    .select-buttons {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
    }

    .select-btn {
        padding: 0.25rem 0.75rem;
        font-size: 0.75rem;
        border-radius: 0.25rem;
        border: 1px solid var(--clr-border);
        background-color: white;
    }

    /* Estilos para inputs de filtro na tabela */
    .mrp-table thead input[type="text"] {
        font-family: inherit;
        transition: border-color 0.2s;
        color: #000 !important;
        background-color: #fff !important;
        font-weight: 500;
    }

    .mrp-table thead input[type="text"]:focus {
        outline: none;
        border-color: var(--clr-light-blue);
        box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.1);
        background-color: #fffef8 !important;
    }

    .mrp-table thead input[type="text"]::placeholder {
        color: #999 !important;
        font-style: italic;
        font-weight: normal;
    }

    .select-btn:hover {
        background-color: var(--clr-light-blue);
        color: white;
        border-color: var(--clr-light-blue);
    }

    .select-btn i {
        margin-right: 0.25rem;
        font-size: 0.7rem;
    }

    /* Animação de atualização do Saldo Futuro */
    @keyframes highlightUpdate {
        0% { background-color: #fff3cd; }
        100% { background-color: transparent; }
    }

    .saldo-futuro-updated {
        animation: highlightUpdate 0.8s ease-out;
    }

    /* Botões de copiar para OP */
    .btn-copy-to-op {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 0.25rem;
        padding: 0.25rem 0.5rem;
        cursor: pointer;
        font-size: 0.7rem;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        min-width: 28px;
        height: 24px;
    }

    .btn-copy-to-op:hover {
        transform: scale(1.1);
        box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
    }

    .btn-copy-to-op:active {
        transform: scale(0.95);
    }

    .btn-copy-to-op i {
        font-size: 0.7rem;
    }

    #iconSticky,
    #iconStickyHeader {
        transition: transform 0.3s ease;
    }

    #btnToggleStickyHeader:hover {
        background: #1976d2;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    #btnToggleStickyHeader:active {
        transform: translateY(0);
    }

    #btnToggleStickyHeader {
        transition: all 0.2s ease;
    }
</style>
{% endblock %}

{% block content %}
<div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
</div>

<!-- Painel de Filtros Selecionados -->
<div class="selected-filters-panel" id="selectedFiltersPanel">
    <h4 style="margin: 0 0 0.5rem 0; font-size: 1rem;">
        <i class="fas fa-check-circle"></i> Filtros Aplicados
    </h4>
    <div class="filter-tags" id="filterTags">
        <span class="filter-tag">
            <i class="fas fa-info-circle"></i>
            Nenhum filtro selecionado
        </span>
    </div>
</div>

<!-- Resumo em Tempo Real -->
<div class="summary-box" id="summaryBox" style="display: none; transition: all 0.3s ease;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
        <h3 style="margin: 0; font-size: 1rem; font-weight: 600;">
            <i class="fas fa-calculator"></i> Resumo do Cálculo
        </h3>
        <button
            onclick="toggleStickyResume()"
            id="btnToggleSticky"
            style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.4); color: white; padding: 0.25rem 0.625rem; border-radius: 0.25rem; cursor: pointer; font-size: 0.75rem; display: flex; align-items: center; gap: 0.25rem;"
            title="Fixar resumo no topo">
            <i class="fas fa-thumbtack" id="iconSticky" style="font-size: 0.7rem;"></i>
            <span id="textSticky">Fixar</span>
        </button>
    </div>

    <!-- Resumo Geral e por Matéria-Prima em uma única linha -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 0.5rem; font-size: 0.8rem;">
        <!-- Resumo Geral -->
        <div style="background: rgba(255, 255, 255, 0.2); padding: 0.5rem; border-radius: 0.25rem; backdrop-filter: blur(10px);">
            <div style="font-size: 0.7rem; opacity: 0.9; margin-bottom: 0.125rem;">Ordens</div>
            <div style="font-size: 1.1rem; font-weight: 700;" id="totalOrders">0</div>
        </div>
        <div style="background: rgba(255, 255, 255, 0.2); padding: 0.5rem; border-radius: 0.25rem; backdrop-filter: blur(10px);">
            <div style="font-size: 0.7rem; opacity: 0.9; margin-bottom: 0.125rem;">Quantidade</div>
            <div style="font-size: 1.1rem; font-weight: 700;" id="totalQuantity">0</div>
        </div>
        <div style="background: rgba(255, 255, 255, 0.2); padding: 0.5rem; border-radius: 0.25rem; backdrop-filter: blur(10px);">
            <div style="font-size: 0.7rem; opacity: 0.9; margin-bottom: 0.125rem;">M³ Madeira</div>
            <div style="font-size: 1.1rem; font-weight: 700;" id="m3Madeira">0</div>
        </div>

        <!-- Matéria-Prima -->
        <div style="background: rgba(139, 69, 19, 0.3); padding: 0.5rem; border-radius: 0.25rem; backdrop-filter: blur(10px);">
            <div style="font-size: 0.7rem; opacity: 0.9; margin-bottom: 0.125rem;"><i class="fas fa-tree"></i> Madeira</div>
            <div style="font-size: 0.8rem; font-weight: 600;" id="summaryMadeira">0 peças - 0 ordens</div>
        </div>
        <div style="background: rgba(255, 215, 0, 0.2); padding: 0.5rem; border-radius: 0.25rem; backdrop-filter: blur(10px);">
            <div style="font-size: 0.7rem; opacity: 0.9; margin-bottom: 0.125rem;"><i class="fas fa-dollar-sign"></i> Madeira $</div>
            <div style="font-size: 0.8rem; font-weight: 600;" id="summaryMadeiraCifrao">0 peças - 0 ordens</div>
        </div>
        <div style="background: rgba(160, 82, 45, 0.3); padding: 0.5rem; border-radius: 0.25rem; backdrop-filter: blur(10px);">
            <div style="font-size: 0.7rem; opacity: 0.9; margin-bottom: 0.125rem;"><i class="fas fa-tree"></i> Compensado</div>
            <div style="font-size: 0.8rem; font-weight: 600;" id="summaryCompensado">0 peças - 0 ordens</div>
        </div>
        <div style="background: rgba(255, 215, 0, 0.2); padding: 0.5rem; border-radius: 0.25rem; backdrop-filter: blur(10px);">
            <div style="font-size: 0.7rem; opacity: 0.9; margin-bottom: 0.125rem;"><i class="fas fa-dollar-sign"></i> Compensado $</div>
            <div style="font-size: 0.8rem; font-weight: 600;" id="summaryCompensadoCifrao">0 peças - 0 ordens</div>
        </div>
        <div style="background: rgba(210, 180, 140, 0.3); padding: 0.5rem; border-radius: 0.25rem; backdrop-filter: blur(10px);">
            <div style="font-size: 0.7rem; opacity: 0.9; margin-bottom: 0.125rem;"><i class="fas fa-layer-group"></i> MDF</div>
            <div style="font-size: 0.8rem; font-weight: 600;" id="summaryMdf">0 peças - 0 ordens</div>
        </div>
        <div style="background: rgba(255, 215, 0, 0.2); padding: 0.5rem; border-radius: 0.25rem; backdrop-filter: blur(10px);">
            <div style="font-size: 0.7rem; opacity: 0.9; margin-bottom: 0.125rem;"><i class="fas fa-dollar-sign"></i> MDF $</div>
            <div style="font-size: 0.8rem; font-weight: 600;" id="summaryMdfCifrao">0 peças - 0 ordens</div>
        </div>
    </div>
</div>

<!-- Filtros -->
<div class="filter-section">
    <h3 style="margin: 0 0 1rem 0; color: var(--clr-dark-blue);">
        <i class="fas fa-filter"></i> Filtros de Cálculo
    </h3>


    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <!-- Pedidos -->
        <div class="filter-group">
            <label class="filter-label" for="filterPedidos">
                <i class="fas fa-file-contract"></i> Pedidos de Venda
                <span class="selection-counter empty" id="counterPedidos">0</span>
            </label>
            <div class="select-buttons">
                <button class="select-btn" onclick="selectAll('filterPedidos')">
                    <i class="fas fa-check-double"></i>Marcar Todos
                </button>
                <button class="select-btn" onclick="deselectAll('filterPedidos')">
                    <i class="fas fa-times"></i>Desmarcar Todos
                </button>
            </div>
            <p class="filter-instruction">Segure Ctrl para selecionar múltiplos pedidos</p>
            <div class="multiselect-box" id="boxPedidos">
                <select id="filterPedidos" class="filter-select" multiple size="5">
                    <!-- Será preenchido via JavaScript -->
                </select>
            </div>
        </div>

        <!-- Lotes de Carga -->
        <div class="filter-group">
            <label class="filter-label" for="filterLotesCarga">
                <i class="fas fa-dolly"></i> Lotes de Carga
                <span class="selection-counter empty" id="counterLotesCarga">0</span>
            </label>
            <div class="select-buttons">
                <button class="select-btn" onclick="selectAll('filterLotesCarga')">
                    <i class="fas fa-check-double"></i>Marcar Todos
                </button>
                <button class="select-btn" onclick="deselectAll('filterLotesCarga')">
                    <i class="fas fa-times"></i>Desmarcar Todos
                </button>
            </div>
            <p class="filter-instruction">Segure Ctrl para selecionar múltiplos lotes</p>
            <div class="multiselect-box" id="boxLotesCarga">
                <select id="filterLotesCarga" class="filter-select" multiple size="5">
                    <!-- Será preenchido via JavaScript -->
                </select>
            </div>
        </div>

        <!-- Lotes de Produção -->
        <div class="filter-group">
            <label class="filter-label" for="filterLotesProducao">
                <i class="fas fa-industry"></i> Lotes de Produção
                <span class="selection-counter empty" id="counterLotesProducao">0</span>
            </label>
            <div class="select-buttons">
                <button class="select-btn" onclick="selectAll('filterLotesProducao')">
                    <i class="fas fa-check-double"></i>Marcar Todos
                </button>
                <button class="select-btn" onclick="deselectAll('filterLotesProducao')">
                    <i class="fas fa-times"></i>Desmarcar Todos
                </button>
            </div>
            <p class="filter-instruction">Segure Ctrl para selecionar múltiplos lotes</p>
            <div class="multiselect-box" id="boxLotesProducao">
                <select id="filterLotesProducao" class="filter-select" multiple size="5">
                    <!-- Será preenchido via JavaScript -->
                </select>
            </div>
        </div>
    </div>

    <div class="action-buttons" style="margin-top: 1rem;">
        <button class="btn btn-primary" onclick="calculateMRP()">
            <i class="fas fa-calculator"></i> Calcular MRP
        </button>
        <button class="btn btn-add" onclick="saveMRP()" id="btnSave" style="display: none;">
            <i class="fas fa-save"></i> Salvar no Banco
        </button>
        <button class="btn" onclick="exportWithOP()" id="btnExportOP" style="display: none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
            <i class="fas fa-file-excel"></i> Exportar Excel (com OP)
        </button>
        <button class="btn" onclick="exportAll()" id="btnExportAll" style="display: none; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white;">
            <i class="fas fa-file-download"></i> Exportar Excel (Todos)
        </button>
        <button class="btn btn-secondary" onclick="clearResults()">
            <i class="fas fa-eraser"></i> Limpar Resultados
        </button>
    </div>
</div>

<!-- Header clone fixo -->
<div id="stickyHeaderClone"></div>

<!-- Tabela de Resultados -->
<div class="table-container" id="resultsContainer" style="display: none;">
    <!-- Filtros Rápidos de Material (pós-cálculo) -->
    <div style="margin-bottom: 1rem; background: white; padding: 1rem; border-radius: 0.5rem; box-shadow: 0 1px 3px 0 rgba(0,0,0,0.1);">
        <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: var(--clr-dark-blue);">
            <i class="fas fa-filter"></i> Filtrar por Matéria-Prima
        </label>
        <div class="quick-filter-buttons">
            <button class="quick-filter-btn" id="filterCompensado" onclick="applyMaterialFilter('compensado')">
                <i class="fas fa-tree"></i> Compensado
            </button>
            <button class="quick-filter-btn" id="filterMadeira" onclick="applyMaterialFilter('madeira')">
                <i class="fas fa-tree"></i> Madeira
            </button>
            <button class="quick-filter-btn" id="filterMadeiraCifrao" onclick="applyMaterialFilter('madeira_cifrao')">
                <i class="fas fa-dollar-sign"></i> Madeira $
            </button>
            <button class="quick-filter-btn" id="filterMdf" onclick="applyMaterialFilter('mdf')">
                <i class="fas fa-layer-group"></i> MDF
            </button>
            <button class="quick-filter-btn" id="filterTodos" onclick="applyMaterialFilter('')">
                <i class="fas fa-times"></i> Todos
            </button>
        </div>
        <small style="color: #666; font-size: 0.75rem; display: block; margin-top: 0.5rem;">
            Filtra produtos que utilizam a matéria-prima selecionada em sua estrutura
        </small>
    </div>

    <!-- Botão Fixar Cabeçalho -->
    <div style="margin-bottom: 0.5rem; text-align: right;">
        <button
            onclick="toggleStickyHeader()"
            id="btnToggleStickyHeader"
            style="background: var(--clr-light-blue); border: none; color: white; padding: 0.5rem 1rem; border-radius: 0.375rem; cursor: pointer; font-size: 0.85rem; display: inline-flex; align-items: center; gap: 0.5rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1);"
            title="Fixar linha de títulos da tabela">
            <i class="fas fa-thumbtack" id="iconStickyHeader"></i>
            <span id="textStickyHeader">Fixar Títulos da Tabela</span>
        </button>
    </div>

    <div class="table-wrapper" id="tableWrapper">
        <table class="mrp-table" id="mrpTable">
            <thead>
                <!-- Linha de filtros -->
                <tr style="background-color: #f8f9fa;">
                    <th style="padding: 0.5rem;">
                        <input
                            type="text"
                            id="filterGrupo"
                            placeholder="Filtrar grupo..."
                            style="width: 100%; padding: 0.375rem; border: 1px solid var(--clr-border); border-radius: 0.25rem; font-size: 0.75rem;"
                            oninput="filterTable()"
                        >
                    </th>
                    <th style="padding: 0.5rem;">
                        <input
                            type="text"
                            id="filterCodigo"
                            placeholder="Filtrar código..."
                            style="width: 100%; padding: 0.375rem; border: 1px solid var(--clr-border); border-radius: 0.25rem; font-size: 0.75rem;"
                            oninput="filterTable()"
                        >
                    </th>
                    <th style="padding: 0.5rem;">
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <input
                                type="text"
                                id="filterDescricao"
                                placeholder="Filtrar descrição..."
                                style="flex: 1; min-width: 0; padding: 0.375rem; border: 1px solid var(--clr-border); border-radius: 0.25rem; font-size: 0.75rem;"
                                oninput="filterTable()"
                            >
                            <label style="display: flex; align-items: center; gap: 0.25rem; font-size: 0.7rem; cursor: pointer; font-weight: normal; white-space: nowrap;">
                                <input type="checkbox" id="filterComCifrao" onchange="filterTable()" style="cursor: pointer;">
                                <span>$</span>
                            </label>
                        </div>
                    </th>
                    <th colspan="11" style="text-align: center; font-size: 0.75rem; color: #666; font-weight: normal;">
                        <i class="fas fa-info-circle"></i> Digite nos campos acima para filtrar | Clique nos cabeçalhos para ordenar
                    </th>
                </tr>
                <!-- Linha de cabeçalhos -->
                <tr id="headerTitlesRow">
                    <th onclick="sortTable(0)" style="cursor: pointer;">
                        Grupo <i class="fas fa-sort"></i>
                    </th>
                    <th onclick="sortTable(1)" style="cursor: pointer;">
                        Código <i class="fas fa-sort"></i>
                    </th>
                    <th onclick="sortTable(2)" style="cursor: pointer;">
                        Descrição <i class="fas fa-sort"></i>
                    </th>
                    <th onclick="sortTable(3)" style="cursor: pointer;">
                        Est. Mín. <i class="fas fa-sort"></i>
                    </th>
                    <th onclick="sortTable(4)" style="cursor: pointer;">
                        Lote Eco. <i class="fas fa-sort"></i>
                    </th>
                    <th class="col-estoque" onclick="sortTable(5)" style="cursor: pointer;">
                        Estoque <i class="fas fa-sort"></i>
                    </th>
                    <th class="col-ordem" onclick="sortTable(6)" style="cursor: pointer;">
                        Ordem <i class="fas fa-sort"></i>
                    </th>
                    <th class="col-reserva" onclick="sortTable(7)" style="cursor: pointer;">
                        Reserva <i class="fas fa-sort"></i>
                    </th>
                    <th onclick="sortTable(8)" style="cursor: pointer;">
                        Sem Necess. <i class="fas fa-sort"></i>
                    </th>
                    <th style="position: relative;">
                        <div style="display: flex; align-items: center; justify-content: space-between; gap: 0.25rem;">
                            <span onclick="sortTable(9)" style="cursor: pointer; flex: 1;">
                                Necessidade <i class="fas fa-sort"></i>
                            </span>
                            <button class="btn-copy-to-op" onclick="copyNecessidadeToOP()" title="Copiar Necessidade para OP">
                                <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                    </th>
                    <th style="position: relative;">
                        <div style="display: flex; align-items: center; justify-content: space-between; gap: 0.25rem;">
                            <span onclick="sortTable(10)" style="cursor: pointer; flex: 1;">
                                Urgente <i class="fas fa-sort"></i>
                            </span>
                            <button class="btn-copy-to-op" onclick="copyUrgenteToOP()" title="Copiar Urgente para OP">
                                <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                    </th>
                    <th onclick="sortTable(11)" style="cursor: pointer;">
                        OP <i class="fas fa-sort"></i>
                    </th>
                    <th onclick="sortTable(12)" style="cursor: pointer;">
                        Saldo - Res. <i class="fas fa-sort"></i>
                    </th>
                    <th onclick="sortTable(13)" style="cursor: pointer;">
                        Saldo Futuro <i class="fas fa-sort"></i>
                    </th>
                </tr>
            </thead>
            <tbody id="mrpTableBody">
                <!-- Será preenchido via JavaScript -->
            </tbody>
        </table>
    </div>
</div>

<script>
let mrpData = [];
let currentMaterialFilter = '';  // Filtro de material ativo (compensado, madeira, mdf)
let currentFilters = {
    material_filter: '',
    pedidos: [],
    lotes_carga: [],
    lotes_producao: []
};

// Carregar filtros ao iniciar
document.addEventListener('DOMContentLoaded', function() {
    loadFilters();

    // Event listeners para os selects de filtros
    document.getElementById('filterPedidos').addEventListener('change', function() {
        updateSelectionCounter('Pedidos');
        updateSelectedFiltersPanel();
    });

    document.getElementById('filterLotesCarga').addEventListener('change', function() {
        updateSelectionCounter('LotesCarga');
        updateSelectedFiltersPanel();
    });

    document.getElementById('filterLotesProducao').addEventListener('change', function() {
        updateSelectionCounter('LotesProducao');
        updateSelectedFiltersPanel();
    });
});

// Marcar todos os itens de um select
function selectAll(selectId) {
    const select = document.getElementById(selectId);
    for (let i = 0; i < select.options.length; i++) {
        select.options[i].selected = true;
    }

    // Atualizar contador e painel
    const filterType = selectId.replace('filter', '');
    updateSelectionCounter(filterType);
    updateSelectedFiltersPanel();
}

// Desmarcar todos os itens de um select
function deselectAll(selectId) {
    const select = document.getElementById(selectId);
    for (let i = 0; i < select.options.length; i++) {
        select.options[i].selected = false;
    }

    // Atualizar contador e painel
    const filterType = selectId.replace('filter', '');
    updateSelectionCounter(filterType);
    updateSelectedFiltersPanel();
}

// Atualizar contador de seleção
function updateSelectionCounter(filterType) {
    const select = document.getElementById(`filter${filterType}`);
    const counter = document.getElementById(`counter${filterType}`);
    const box = document.getElementById(`box${filterType}`);
    const count = select.selectedOptions.length;

    counter.textContent = count;

    if (count > 0) {
        counter.classList.remove('empty');
        box.classList.add('has-selection');
    } else {
        counter.classList.add('empty');
        box.classList.remove('has-selection');
    }
}

// Atualizar painel de filtros selecionados
function updateSelectedFiltersPanel() {
    const panel = document.getElementById('selectedFiltersPanel');
    const tagsContainer = document.getElementById('filterTags');
    tagsContainer.innerHTML = '';

    let hasFilters = false;

    // Filtro rápido de material
    if (currentFilters.material_filter) {
        hasFilters = true;
        const tag = document.createElement('span');
        tag.className = 'filter-tag';
        tag.innerHTML = `<i class="fas fa-tree"></i> Material: ${currentFilters.material_filter.toUpperCase()}`;
        tagsContainer.appendChild(tag);
    }

    // Pedidos selecionados
    const pedidosSelect = document.getElementById('filterPedidos');
    const selectedPedidos = Array.from(pedidosSelect.selectedOptions);
    if (selectedPedidos.length > 0) {
        hasFilters = true;
        const tag = document.createElement('span');
        tag.className = 'filter-tag';
        tag.innerHTML = `<i class="fas fa-file-contract"></i> ${selectedPedidos.length} Pedido(s): ${selectedPedidos.slice(0, 3).map(opt => opt.value).join(', ')}${selectedPedidos.length > 3 ? '...' : ''}`;
        tagsContainer.appendChild(tag);
    }

    // Lotes de carga selecionados
    const lotesCargaSelect = document.getElementById('filterLotesCarga');
    const selectedLotesCarga = Array.from(lotesCargaSelect.selectedOptions);
    if (selectedLotesCarga.length > 0) {
        hasFilters = true;
        const tag = document.createElement('span');
        tag.className = 'filter-tag';
        tag.innerHTML = `<i class="fas fa-dolly"></i> ${selectedLotesCarga.length} Lote(s) de Carga: ${selectedLotesCarga.slice(0, 3).map(opt => opt.value).join(', ')}${selectedLotesCarga.length > 3 ? '...' : ''}`;
        tagsContainer.appendChild(tag);
    }

    // Lotes de produção selecionados
    const lotesProducaoSelect = document.getElementById('filterLotesProducao');
    const selectedLotesProducao = Array.from(lotesProducaoSelect.selectedOptions);
    if (selectedLotesProducao.length > 0) {
        hasFilters = true;
        const tag = document.createElement('span');
        tag.className = 'filter-tag';
        tag.innerHTML = `<i class="fas fa-industry"></i> ${selectedLotesProducao.length} Lote(s) de Produção: ${selectedLotesProducao.slice(0, 3).map(opt => opt.value).join(', ')}${selectedLotesProducao.length > 3 ? '...' : ''}`;
        tagsContainer.appendChild(tag);
    }

    // Se não há filtros, mostrar mensagem
    if (!hasFilters) {
        const tag = document.createElement('span');
        tag.className = 'filter-tag';
        tag.innerHTML = '<i class="fas fa-info-circle"></i> Nenhum filtro selecionado';
        tagsContainer.appendChild(tag);
    }

    // Mostrar/ocultar painel
    if (hasFilters) {
        panel.classList.add('active');
    } else {
        panel.classList.remove('active');
    }
}

function loadFilters() {
    fetch('/mrp/get_filters')
        .then(response => response.json())
        .then(data => {
            // Preencher pedidos
            const selectPedidos = document.getElementById('filterPedidos');
            data.pedidos.forEach(pedido => {
                const option = document.createElement('option');
                option.value = pedido.codigo;
                option.textContent = `${pedido.codigo} - ${pedido.cliente || 'N/A'}`;
                selectPedidos.appendChild(option);
            });

            // Preencher lotes de carga
            const selectLotesCarga = document.getElementById('filterLotesCarga');
            data.lotes_carga.forEach(lote => {
                const option = document.createElement('option');
                option.value = lote.codigo;
                option.textContent = `${lote.codigo} - ${lote.descricao || 'N/A'}`;
                selectLotesCarga.appendChild(option);
            });

            // Preencher lotes de produção
            const selectLotesProducao = document.getElementById('filterLotesProducao');
            data.lotes_producao.forEach(lote => {
                const option = document.createElement('option');
                option.value = lote.codigo;
                option.textContent = `${lote.codigo} - ${lote.descricao || 'N/A'}`;
                selectLotesProducao.appendChild(option);
            });
        })
        .catch(error => {
            console.error('Erro ao carregar filtros:', error);
            alert('Erro ao carregar filtros. Por favor, recarregue a página.');
        });
}

function calculateMRP() {
    // Coletar filtros selecionados
    const pedidosSelect = document.getElementById('filterPedidos');
    const lotesCargaSelect = document.getElementById('filterLotesCarga');
    const lotesProducaoSelect = document.getElementById('filterLotesProducao');

    currentFilters.pedidos = Array.from(pedidosSelect.selectedOptions).map(opt => opt.value);
    currentFilters.lotes_carga = Array.from(lotesCargaSelect.selectedOptions).map(opt => opt.value);
    currentFilters.lotes_producao = Array.from(lotesProducaoSelect.selectedOptions).map(opt => opt.value);

    // Mostrar loading
    document.getElementById('loadingOverlay').classList.add('active');

    // Fazer requisição
    fetch('/mrp/calculate', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(currentFilters)
    })
    .then(response => response.json())
    .then(data => {
        mrpData = data.produtos;
        renderTable();
        updateSummary();

        // Mostrar resultados e botões
        document.getElementById('resultsContainer').style.display = 'block';
        document.getElementById('summaryBox').style.display = 'block';
        document.getElementById('btnSave').style.display = 'inline-flex';
        document.getElementById('btnExportOP').style.display = 'inline-flex';
        document.getElementById('btnExportAll').style.display = 'inline-flex';

        // Esconder loading
        document.getElementById('loadingOverlay').classList.remove('active');
    })
    .catch(error => {
        console.error('Erro ao calcular MRP:', error);
        alert('Erro ao calcular MRP. Por favor, tente novamente.');
        document.getElementById('loadingOverlay').classList.remove('active');
    });
}

function renderTable() {
    const tbody = document.getElementById('mrpTableBody');
    tbody.innerHTML = '';

    // Ativar botão "Todos" por padrão
    currentMaterialFilter = '';
    document.querySelectorAll('.quick-filter-btn').forEach(btn => btn.classList.remove('active'));
    const filterTodosBtn = document.getElementById('filterTodos');
    if (filterTodosBtn) {
        filterTodosBtn.classList.add('active');
    }

    mrpData.forEach((produto, index) => {
        const tr = document.createElement('tr');
        tr.setAttribute('data-index', index);  // Adicionar índice para filtros

        // Determinar qual célula destacar
        let highlightClass = '';
        if (produto.urgente > 0) {
            highlightClass = 'urgente-cell';
        } else if (produto.necessidade > 0) {
            highlightClass = 'necessidade-cell';
        } else {
            highlightClass = 'sem-necessidade-cell';
        }

        tr.innerHTML = `
            <td>${produto.grupo}</td>
            <td>${produto.codigo}</td>
            <td>${produto.descricao}</td>
            <td>${formatNumber(produto.estoque_minimo)}</td>
            <td>${formatNumber(produto.lote_economico)}</td>
            <td class="col-estoque">${formatNumber(produto.estoque)}</td>
            <td class="col-ordem">${formatNumber(produto.ordem)}</td>
            <td class="col-reserva">${formatNumber(produto.reserva)}</td>
            <td class="${produto.sem_necessidade > 0 ? highlightClass : ''}">${formatNumber(produto.sem_necessidade)}</td>
            <td class="${produto.necessidade > 0 ? highlightClass : ''}">${formatNumber(produto.necessidade)}</td>
            <td class="${produto.urgente > 0 ? highlightClass : ''}">${formatNumber(produto.urgente)}</td>
            <td>
                <input type="number"
                       min="0"
                       step="1"
                       value="${produto.op || 0}"
                       data-index="${index}"
                       onchange="updateOP(${index}, this.value)"
                       oninput="updateOP(${index}, this.value)">
            </td>
            <td>${formatNumber(produto.saldo_menos_reserva)}</td>
            <td id="saldoFuturo_${index}">${formatNumber(produto.saldo_futuro)}</td>
        `;

        tbody.appendChild(tr);
    });
}

function updateOP(index, value) {
    const opValue = parseFloat(value) || 0;
    mrpData[index].op = opValue;

    // Recalcular Saldo Futuro automaticamente
    // Fórmula: Saldo Futuro = Estoque + Ordem - Reserva + OP
    const produto = mrpData[index];
    const novoSaldoFuturo = produto.estoque + produto.ordem - produto.reserva + opValue;
    mrpData[index].saldo_futuro = novoSaldoFuturo;

    // Atualizar a célula do Saldo Futuro na tabela com animação
    const saldoFuturoCell = document.getElementById(`saldoFuturo_${index}`);
    if (saldoFuturoCell) {
        saldoFuturoCell.textContent = formatNumber(novoSaldoFuturo);

        // Adicionar animação de destaque
        saldoFuturoCell.classList.add('saldo-futuro-updated');
        setTimeout(() => {
            saldoFuturoCell.classList.remove('saldo-futuro-updated');
        }, 800);
    }

    updateSummary();
}

function updateSummary() {
    let totalOrders = 0;
    let totalQuantity = 0;
    let m3Madeira = 0;

    // Contadores por tipo de material
    let materialStats = {
        madeira: { pecas: 0, ordens: 0 },
        madeiraCifrao: { pecas: 0, ordens: 0 },
        compensado: { pecas: 0, ordens: 0 },
        compensadoCifrao: { pecas: 0, ordens: 0 },
        mdf: { pecas: 0, ordens: 0 },
        mdfCifrao: { pecas: 0, ordens: 0 }
    };

    mrpData.forEach(produto => {
        if (produto.op > 0) {
            totalOrders++;
            totalQuantity += produto.op;

            // Calcular M³ de madeira (OP * cubagem_unitaria)
            if (produto.material_type === 'madeira' && produto.cubagem_unitaria) {
                m3Madeira += produto.op * produto.cubagem_unitaria;
            }
        }

        // Calcular estatísticas por material
        const temCifrao = produto.descricao && produto.descricao.includes('$');
        const materialType = produto.material_type;

        if (materialType === 'madeira') {
            if (temCifrao) {
                if (produto.op > 0) {
                    materialStats.madeiraCifrao.pecas += produto.op;
                    materialStats.madeiraCifrao.ordens++;
                }
            } else {
                if (produto.op > 0) {
                    materialStats.madeira.pecas += produto.op;
                    materialStats.madeira.ordens++;
                }
            }
        } else if (materialType === 'compensado') {
            if (temCifrao) {
                if (produto.op > 0) {
                    materialStats.compensadoCifrao.pecas += produto.op;
                    materialStats.compensadoCifrao.ordens++;
                }
            } else {
                if (produto.op > 0) {
                    materialStats.compensado.pecas += produto.op;
                    materialStats.compensado.ordens++;
                }
            }
        } else if (materialType === 'mdf') {
            if (temCifrao) {
                if (produto.op > 0) {
                    materialStats.mdfCifrao.pecas += produto.op;
                    materialStats.mdfCifrao.ordens++;
                }
            } else {
                if (produto.op > 0) {
                    materialStats.mdf.pecas += produto.op;
                    materialStats.mdf.ordens++;
                }
            }
        }
    });

    document.getElementById('totalOrders').textContent = totalOrders;
    document.getElementById('totalQuantity').textContent = formatNumber(totalQuantity);
    document.getElementById('m3Madeira').textContent = m3Madeira.toFixed(3);

    // Atualizar resumo por material
    document.getElementById('summaryMadeira').textContent =
        `${formatNumber(materialStats.madeira.pecas)} peças - ${materialStats.madeira.ordens} ordens`;
    document.getElementById('summaryMadeiraCifrao').textContent =
        `${formatNumber(materialStats.madeiraCifrao.pecas)} peças - ${materialStats.madeiraCifrao.ordens} ordens`;
    document.getElementById('summaryCompensado').textContent =
        `${formatNumber(materialStats.compensado.pecas)} peças - ${materialStats.compensado.ordens} ordens`;
    document.getElementById('summaryCompensadoCifrao').textContent =
        `${formatNumber(materialStats.compensadoCifrao.pecas)} peças - ${materialStats.compensadoCifrao.ordens} ordens`;
    document.getElementById('summaryMdf').textContent =
        `${formatNumber(materialStats.mdf.pecas)} peças - ${materialStats.mdf.ordens} ordens`;
    document.getElementById('summaryMdfCifrao').textContent =
        `${formatNumber(materialStats.mdfCifrao.pecas)} peças - ${materialStats.mdfCifrao.ordens} ordens`;
}

function saveMRP() {
    // Verificar se há produtos com OP preenchido
    const produtosComOP = mrpData.filter(p => p.op > 0);

    if (produtosComOP.length === 0) {
        alert('Por favor, preencha o campo OP para pelo menos um produto antes de salvar.');
        return;
    }

    // Mostrar loading
    document.getElementById('loadingOverlay').classList.add('active');

    // Salvar no banco de dados
    fetch('/mrp/save', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            produtos: mrpData,
            filters: currentFilters
        })
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('loadingOverlay').classList.remove('active');
        if (data.success) {
            alert('MRP salvo com sucesso no banco de dados!');
        } else {
            alert('Erro ao salvar MRP: ' + (data.error || 'Erro desconhecido'));
        }
    })
    .catch(error => {
        console.error('Erro ao salvar MRP:', error);
        alert('Erro ao salvar MRP. Por favor, tente novamente.');
        document.getElementById('loadingOverlay').classList.remove('active');
    });
}

function exportWithOP() {
    // Verificar se há produtos com OP preenchido
    const produtosComOP = mrpData.filter(p => p.op > 0);

    if (produtosComOP.length === 0) {
        alert('Não há produtos com OP preenchido para exportar.');
        return;
    }

    // Mostrar loading
    document.getElementById('loadingOverlay').classList.add('active');

    // Exportar Excel apenas com produtos com OP > 0
    fetch('/mrp/export_with_op', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            produtos: mrpData
        })
    })
    .then(response => {
        if (response.ok) {
            return response.blob();
        }
        throw new Error('Erro ao gerar arquivo');
    })
    .then(blob => {
        // Download do arquivo
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `MRP_OP_${new Date().toISOString().split('T')[0]}.xlsx`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);

        document.getElementById('loadingOverlay').classList.remove('active');
        alert('Excel gerado com sucesso!');
    })
    .catch(error => {
        console.error('Erro ao exportar MRP:', error);
        alert('Erro ao exportar MRP. Por favor, tente novamente.');
        document.getElementById('loadingOverlay').classList.remove('active');
    });
}

function exportAll() {
    // Verificar se há dados calculados
    if (mrpData.length === 0) {
        alert('Não há dados calculados para exportar.');
        return;
    }

    // Filtrar produtos baseado no filtro de matéria-prima ativo
    let produtosParaExportar = mrpData;
    let sufixoFiltro = '';
    let nomeFiltro = '';

    if (currentMaterialFilter !== '') {
        // Aplicar filtro de material
        if (currentMaterialFilter === 'madeira') {
            // Madeira: apenas madeira SEM "$" na descrição
            produtosParaExportar = mrpData.filter(produto =>
                produto.material_type === 'madeira' && !produto.descricao.includes('$')
            );
            sufixoFiltro = '_Madeira';
            nomeFiltro = 'MADEIRA (sem $)';
        } else if (currentMaterialFilter === 'madeira_cifrao') {
            // Madeira $: apenas madeira COM "$" na descrição
            produtosParaExportar = mrpData.filter(produto =>
                produto.material_type === 'madeira' && produto.descricao.includes('$')
            );
            sufixoFiltro = '_Madeira$';
            nomeFiltro = 'MADEIRA $';
        } else {
            // Outros filtros (compensado, mdf)
            produtosParaExportar = mrpData.filter(produto =>
                produto.material_type === currentMaterialFilter
            );
            sufixoFiltro = `_${currentMaterialFilter.charAt(0).toUpperCase() + currentMaterialFilter.slice(1)}`;
            nomeFiltro = currentMaterialFilter.toUpperCase();
        }

        // Verificar se há produtos após o filtro
        if (produtosParaExportar.length === 0) {
            alert(`Não há produtos do tipo ${nomeFiltro} para exportar.`);
            return;
        }

        // Confirmar exportação com filtro
        const confirmar = confirm(
            `Exportar ${produtosParaExportar.length} produto(s) do tipo ${nomeFiltro}?\n\n` +
            `Total de produtos calculados: ${mrpData.length}\n` +
            `Filtro ativo: ${nomeFiltro}`
        );

        if (!confirmar) {
            return;
        }
    } else {
        // Sem filtro - exportar tudo
        const confirmar = confirm(
            `Exportar TODOS os ${mrpData.length} produtos calculados?\n\n` +
            `Nenhum filtro de matéria-prima está ativo.`
        );

        if (!confirmar) {
            return;
        }
    }

    // Mostrar loading
    document.getElementById('loadingOverlay').classList.add('active');

    // Exportar Excel com os produtos (filtrados ou todos)
    fetch('/mrp/export_all', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            produtos: produtosParaExportar
        })
    })
    .then(response => {
        if (response.ok) {
            return response.blob();
        }
        throw new Error('Erro ao gerar arquivo');
    })
    .then(blob => {
        // Download do arquivo
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `MRP_Completo${sufixoFiltro}_${new Date().toISOString().split('T')[0]}.xlsx`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);

        document.getElementById('loadingOverlay').classList.remove('active');

        // Mensagem de sucesso com informação do filtro
        if (currentMaterialFilter !== '') {
            alert(`Excel gerado com sucesso!\n\n${produtosParaExportar.length} produto(s) do tipo ${currentMaterialFilter.toUpperCase()} exportados.`);
        } else {
            alert(`Excel completo gerado com sucesso!\n\n${produtosParaExportar.length} produto(s) exportados.`);
        }
    })
    .catch(error => {
        console.error('Erro ao exportar MRP completo:', error);
        alert('Erro ao exportar MRP. Por favor, tente novamente.');
        document.getElementById('loadingOverlay').classList.remove('active');
    });
}

function clearResults() {
    mrpData = [];
    currentMaterialFilter = '';  // Limpar filtro de material
    document.getElementById('resultsContainer').style.display = 'none';
    document.getElementById('summaryBox').style.display = 'none';
    document.getElementById('btnSave').style.display = 'none';
    document.getElementById('btnExportOP').style.display = 'none';
    document.getElementById('btnExportAll').style.display = 'none';
    document.getElementById('mrpTableBody').innerHTML = '';

    // Limpar campos de filtro da tabela
    const filterGrupo = document.getElementById('filterGrupo');
    const filterCodigo = document.getElementById('filterCodigo');
    const filterDescricao = document.getElementById('filterDescricao');
    const filterComCifrao = document.getElementById('filterComCifrao');
    if (filterGrupo) filterGrupo.value = '';
    if (filterCodigo) filterCodigo.value = '';
    if (filterDescricao) filterDescricao.value = '';
    if (filterComCifrao) filterComCifrao.checked = false;

    // Limpar seleções
    document.getElementById('filterPedidos').selectedIndex = -1;
    document.getElementById('filterLotesCarga').selectedIndex = -1;
    document.getElementById('filterLotesProducao').selectedIndex = -1;

    // Limpar filtro rápido de material
    document.querySelectorAll('.quick-filter-btn').forEach(btn => {
        btn.classList.remove('active');
    });

    // Resetar sticky header e resumo
    const stickyClone = document.getElementById('stickyHeaderClone');
    const summaryBox = document.getElementById('summaryBox');
    if (stickyClone) {
        stickyClone.classList.remove('active');
        stickyClone.innerHTML = '';
    }
    if (summaryBox) {
        summaryBox.classList.remove('sticky');
    }

    // Resetar botões de sticky
    const btnTextHeader = document.getElementById('textStickyHeader');
    const btnIconHeader = document.getElementById('iconStickyHeader');
    const btnText = document.getElementById('textSticky');
    const btnIcon = document.getElementById('iconSticky');
    if (btnTextHeader) btnTextHeader.textContent = 'Fixar Títulos da Tabela';
    if (btnIconHeader) btnIconHeader.style.transform = 'rotate(0deg)';
    if (btnText) btnText.textContent = 'Fixar';
    if (btnIcon) btnIcon.style.transform = 'rotate(0deg)';

    currentFilters = {
        material_filter: '',
        pedidos: [],
        lotes_carga: [],
        lotes_producao: []
    };

    // Resetar contadores
    updateSelectionCounter('Pedidos');
    updateSelectionCounter('LotesCarga');
    updateSelectionCounter('LotesProducao');

    // Atualizar painel de filtros
    updateSelectedFiltersPanel();

    // Resetar direção de ordenação
    sortDirection = {};
}

function formatNumber(num) {
    if (num === 0 || num === '0') return '0';
    if (!num) return '-';
    return parseFloat(num).toLocaleString('pt-BR', {
        minimumFractionDigits: 0,
        maximumFractionDigits: 2
    });
}

// Variável para controlar direção da ordenação
let sortDirection = {};

// Aplicar filtro de material (pós-cálculo)
function applyMaterialFilter(materialType) {
    currentMaterialFilter = materialType;

    // Atualizar estado visual dos botões
    document.querySelectorAll('.quick-filter-btn').forEach(btn => {
        btn.classList.remove('active');
    });

    if (materialType === 'compensado') {
        document.getElementById('filterCompensado').classList.add('active');
    } else if (materialType === 'madeira') {
        document.getElementById('filterMadeira').classList.add('active');
    } else if (materialType === 'madeira_cifrao') {
        document.getElementById('filterMadeiraCifrao').classList.add('active');
    } else if (materialType === 'mdf') {
        document.getElementById('filterMdf').classList.add('active');
    } else {
        document.getElementById('filterTodos').classList.add('active');
    }

    // Aplicar filtro na tabela
    filterTable();
}

// Função para filtrar a tabela em tempo real
function filterTable() {
    const filterGrupo = document.getElementById('filterGrupo').value.toLowerCase();
    const filterCodigo = document.getElementById('filterCodigo').value.toLowerCase();
    const filterDescricao = document.getElementById('filterDescricao').value.toLowerCase();
    const filterComCifrao = document.getElementById('filterComCifrao').checked;

    const tbody = document.getElementById('mrpTableBody');
    const rows = tbody.getElementsByTagName('tr');

    for (let i = 0; i < rows.length; i++) {
        const cells = rows[i].getElementsByTagName('td');
        const grupo = cells[0].textContent.toLowerCase();
        const codigo = cells[1].textContent.toLowerCase();
        const descricao = cells[2].textContent.toLowerCase();

        // Obter índice do produto no mrpData
        const rowIndex = parseInt(rows[i].getAttribute('data-index'));
        const produto = mrpData[rowIndex];

        // Verifica se cada campo atende ao seu respectivo filtro
        const matchGrupo = filterGrupo === '' || grupo.includes(filterGrupo);
        const matchCodigo = filterCodigo === '' || codigo.includes(filterCodigo);
        const matchDescricao = filterDescricao === '' || descricao.includes(filterDescricao);

        // Filtro de material
        let matchMaterial = true;
        if (currentMaterialFilter === 'madeira') {
            // Madeira: apenas madeira SEM "$" na descrição
            matchMaterial = produto && produto.material_type === 'madeira' && !descricao.includes('$');
        } else if (currentMaterialFilter === 'madeira_cifrao') {
            // Madeira $: apenas madeira COM "$" na descrição
            matchMaterial = produto && produto.material_type === 'madeira' && descricao.includes('$');
        } else if (currentMaterialFilter !== '') {
            // Outros filtros (compensado, mdf)
            matchMaterial = produto && produto.material_type === currentMaterialFilter;
        }

        // Filtro de cifrao - se checkbox marcado, só mostra itens com $ na descrição
        const matchCifrao = !filterComCifrao || descricao.includes('$');

        // Mostra a linha apenas se todos os filtros corresponderem
        if (matchGrupo && matchCodigo && matchDescricao && matchMaterial && matchCifrao) {
            rows[i].style.display = '';
        } else {
            rows[i].style.display = 'none';
        }
    }
}

// Função para ordenar a tabela
function sortTable(columnIndex) {
    const tbody = document.getElementById('mrpTableBody');
    const rows = Array.from(tbody.getElementsByTagName('tr'));

    // Determinar direção da ordenação (alterna entre asc e desc)
    if (!sortDirection[columnIndex]) {
        sortDirection[columnIndex] = 'asc';
    } else {
        sortDirection[columnIndex] = sortDirection[columnIndex] === 'asc' ? 'desc' : 'asc';
    }

    const direction = sortDirection[columnIndex];

    // Ordenar as linhas
    rows.sort((a, b) => {
        const cellA = a.getElementsByTagName('td')[columnIndex];
        const cellB = b.getElementsByTagName('td')[columnIndex];

        let valueA = cellA.textContent.trim();
        let valueB = cellB.textContent.trim();

        // Tentar converter para número se possível
        const numA = parseFloat(valueA.replace(/\./g, '').replace(',', '.'));
        const numB = parseFloat(valueB.replace(/\./g, '').replace(',', '.'));

        let comparison = 0;

        if (!isNaN(numA) && !isNaN(numB)) {
            // Comparação numérica
            comparison = numA - numB;
        } else {
            // Comparação alfabética
            comparison = valueA.localeCompare(valueB, 'pt-BR');
        }

        return direction === 'asc' ? comparison : -comparison;
    });

    // Reordenar no DOM
    rows.forEach(row => tbody.appendChild(row));

    // Atualizar ícones de ordenação
    updateSortIcons(columnIndex, direction);
}

// Função para atualizar ícones de ordenação
function updateSortIcons(activeColumn, direction) {
    const headers = document.querySelectorAll('.mrp-table th');

    headers.forEach((header, index) => {
        const icon = header.querySelector('i');
        if (icon) {
            if (index === activeColumn) {
                // Coluna ativa
                icon.className = direction === 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down';
            } else {
                // Outras colunas
                icon.className = 'fas fa-sort';
            }
        }
    });
}

// Copiar valores da coluna Necessidade para OP
function copyNecessidadeToOP() {
    const tbody = document.getElementById('mrpTableBody');
    const rows = tbody.getElementsByTagName('tr');
    let copiedCount = 0;

    for (let i = 0; i < rows.length; i++) {
        // Verificar se a linha está visível (não filtrada)
        if (rows[i].style.display !== 'none') {
            const cells = rows[i].getElementsByTagName('td');
            const necessidadeValue = parseFloat(cells[9].textContent.replace(/\./g, '').replace(',', '.')) || 0;

            if (necessidadeValue > 0) {
                // Encontrar o input OP nesta linha
                const opInput = cells[11].querySelector('input[type="number"]');
                if (opInput) {
                    const index = parseInt(opInput.getAttribute('data-index'));
                    opInput.value = necessidadeValue;
                    updateOP(index, necessidadeValue);
                    copiedCount++;
                }
            }
        }
    }

    // Feedback visual
    if (copiedCount > 0) {
        alert(`${copiedCount} valores copiados da coluna Necessidade para OP!`);
    } else {
        alert('Nenhum valor de Necessidade encontrado para copiar.');
    }
}

// Copiar valores da coluna Urgente para OP
function copyUrgenteToOP() {
    const tbody = document.getElementById('mrpTableBody');
    const rows = tbody.getElementsByTagName('tr');
    let copiedCount = 0;

    for (let i = 0; i < rows.length; i++) {
        // Verificar se a linha está visível (não filtrada)
        if (rows[i].style.display !== 'none') {
            const cells = rows[i].getElementsByTagName('td');
            const urgenteValue = parseFloat(cells[10].textContent.replace(/\./g, '').replace(',', '.')) || 0;

            if (urgenteValue > 0) {
                // Encontrar o input OP nesta linha
                const opInput = cells[11].querySelector('input[type="number"]');
                if (opInput) {
                    const index = parseInt(opInput.getAttribute('data-index'));
                    opInput.value = urgenteValue;
                    updateOP(index, urgenteValue);
                    copiedCount++;
                }
            }
        }
    }

    // Feedback visual
    if (copiedCount > 0) {
        alert(`${copiedCount} valores copiados da coluna Urgente para OP!`);
    } else {
        alert('Nenhum valor de Urgente encontrado para copiar.');
    }
}

// Fixar/desafixar resumo
function toggleStickyResume() {
    const summaryBox = document.getElementById('summaryBox');
    const btnText = document.getElementById('textSticky');
    const btnIcon = document.getElementById('iconSticky');
    const stickyClone = document.getElementById('stickyHeaderClone');

    if (summaryBox.classList.contains('sticky')) {
        summaryBox.classList.remove('sticky');
        btnText.textContent = 'Fixar';
        btnIcon.style.transform = 'rotate(0deg)';

        // Resetar posição do header clone
        if (stickyClone && stickyClone.classList.contains('active')) {
            stickyClone.style.top = '0';
        }
    } else {
        summaryBox.classList.add('sticky');
        btnText.textContent = 'Desafixar';
        btnIcon.style.transform = 'rotate(45deg)';

        // Ajustar posição do header clone se estiver fixo
        if (stickyClone && stickyClone.classList.contains('active')) {
            setTimeout(() => {
                const summaryHeight = summaryBox.offsetHeight;
                stickyClone.style.top = summaryHeight + 'px';
            }, 100);
        }
    }
}

// Fixar/desafixar cabeçalho da tabela
function toggleStickyHeader() {
    const headerRow = document.getElementById('headerTitlesRow');
    const stickyClone = document.getElementById('stickyHeaderClone');
    const btnText = document.getElementById('textStickyHeader');
    const btnIcon = document.getElementById('iconStickyHeader');
    const summaryBox = document.getElementById('summaryBox');
    const mrpTable = document.getElementById('mrpTable');

    if (!headerRow || !mrpTable) {
        alert('Calcule o MRP primeiro para ativar esta função!');
        return;
    }

    if (stickyClone.classList.contains('active')) {
        // Desativar sticky
        stickyClone.classList.remove('active');
        stickyClone.innerHTML = '';
        btnText.textContent = 'Fixar Títulos da Tabela';
        btnIcon.style.transform = 'rotate(0deg)';
    } else {
        // Ativar sticky - criar clone
        updateStickyHeaderClone();
        btnText.textContent = 'Desafixar Títulos';
        btnIcon.style.transform = 'rotate(45deg)';
    }
}

// Função para criar/atualizar o clone do header
function updateStickyHeaderClone() {
    const headerRow = document.getElementById('headerTitlesRow');
    const stickyClone = document.getElementById('stickyHeaderClone');
    const summaryBox = document.getElementById('summaryBox');
    const mrpTable = document.getElementById('mrpTable');

    if (!headerRow || !mrpTable) return;

    const tableRect = mrpTable.getBoundingClientRect();

    // Clonar a linha de títulos
    const cloneTable = document.createElement('table');
    cloneTable.style.width = tableRect.width + 'px';
    cloneTable.style.tableLayout = 'fixed';
    cloneTable.style.borderCollapse = 'collapse';

    const cloneThead = document.createElement('thead');
    const cloneRow = headerRow.cloneNode(true);

    // Copiar larguras exatas das colunas
    const originalThs = headerRow.querySelectorAll('th');
    const cloneThs = cloneRow.querySelectorAll('th');

    originalThs.forEach((th, index) => {
        cloneThs[index].style.width = th.offsetWidth + 'px';
        cloneThs[index].style.boxSizing = 'border-box';
    });

    cloneThead.appendChild(cloneRow);
    cloneTable.appendChild(cloneThead);

    // Limpar e adicionar novo clone
    stickyClone.innerHTML = '';
    stickyClone.appendChild(cloneTable);

    // Posicionar o clone
    stickyClone.style.left = (tableRect.left) + 'px';
    stickyClone.style.width = tableRect.width + 'px';

    // Ajustar top baseado no resumo
    if (summaryBox && summaryBox.classList.contains('sticky')) {
        const summaryHeight = summaryBox.offsetHeight;
        stickyClone.style.top = summaryHeight + 'px';
    } else {
        stickyClone.style.top = '0';
    }

    stickyClone.classList.add('active');
}

// Atualizar posição do clone quando houver resize ou toggle da sidebar
let resizeTimeout;
window.addEventListener('resize', () => {
    clearTimeout(resizeTimeout);
    resizeTimeout = setTimeout(() => {
        const stickyClone = document.getElementById('stickyHeaderClone');
        if (stickyClone && stickyClone.classList.contains('active')) {
            updateStickyHeaderClone();
        }
    }, 100);
});

// Observar mudanças na classe sidebar-collapsed do body
const bodyObserver = new MutationObserver((mutations) => {
    mutations.forEach((mutation) => {
        if (mutation.attributeName === 'class') {
            const stickyClone = document.getElementById('stickyHeaderClone');
            if (stickyClone && stickyClone.classList.contains('active')) {
                setTimeout(() => {
                    updateStickyHeaderClone();
                }, 350); // Aguardar transição da sidebar (300ms + margem)
            }
        }
    });
});

bodyObserver.observe(document.body, { attributes: true });

</script>
{% endblock %}
